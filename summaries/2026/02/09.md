# Activity Summary for 2/9/2026

## 2:07:26 PM
The changes primarily involve two files, `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`, with a few entries for `c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`.

### File-Specific Updates:

**`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**

This file, a Laravel Eloquent model for `Contact` in a PlotBox application, defines a complex SQL query within its `getDataWithDateRange` method, connecting to a Snowflake database.

*   **1/21/2026, 12:51:05 PM (Initial State):** The query initially filters data by a dynamic date range (`$fromDate`, `$toDate`) and includes several Common Table Expressions (CTEs) for calculating totals and categorizing items, such as `contract_fee_tax`, `deed_fee_tax`, and `cancelled_contract_fee_tax`.
*   **1/21/2026, 12:52:00 PM - 1/21/2026, 1:37:28 PM:** The date range filter in the `base_contracts` CTE is commented out and replaced with a hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'`, likely for debugging a specific contract.
*   **1/21/2026, 3:57:10 PM:** The `cancelled_contract_fee_tax` CTE is completely commented out, and its inclusion in the `contract_tax_totals` calculation is also commented out.
*   **1/21/2026, 4:05:53 PM:** A significant change occurs in how tax amounts are summed:
    *   In `contract_fee_tax` CTE, `SUM(f.TAX_AMOUNT * cf.QUANTITY)` is changed to `SUM(cf.TAX_AMOUNT * cf.QUANTITY)`.
    *   In `deed_fee_tax` CTE, `SUM(f.TAX_AMOUNT * df.QUANTITY)` is incorrectly changed to `SUM(cf.TAX_AMOUNT * df.QUANTITY)`, introducing a likely bug by referencing `cf` (from `DIM_CONTRACT_FEE`) instead of `df` (from `DIM_DEED_FEE`).
*   **1/21/2026, 4:16:07 PM:**
    *   The `deed_fee_tax` calculation is corrected to `SUM(df.TAX_AMOUNT * df.QUANTITY)`, fixing the bug from the previous change.
    *   A minor case change is made in `contract_fee_tax` from `LOWER(f.FEE_TYPE) != 'interest'` to `LOWER(f.FEE_TYPE) != 'Interest'`.
*   **1/21/2026, 4:20:08 PM:** `CAST` operations are added to subqueries within `IN` clauses (e.g., `cf.CONTRACT_ID IN (CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))`) for `contract_fee_tax`, `deed_fee_tax`, and the commented `cancelled_contract_fee_tax` CTEs, likely to address type issues.
*   **1/21/2026, 4:20:13 PM - 1/21/2026, 4:20:28 PM:** The hardcoded contract number is changed from `'645-110814'` to `'110814'`.
*   **1/21/2026, 4:23:56 PM:** The `CAST` syntax in the `WHERE ... IN` clauses is changed, introducing a malformed SQL query (`IN SELECT CONTRACT_ID FROM base_contracts AS INT)`).
*   **1/21/2026, 4:26:14 PM:** The `CAST` syntax errors from the previous change are reverted, restoring the correct `IN (SELECT CONTRACT_ID FROM base_contracts)` form.
*   **1/21/2026, 4:26:47 PM - 1/21/2026, 4:27:46 PM:** The `contract_tax_totals` CTE is modified to definitively remove the `cancelled_fee_tax_total` from the sum, aligning with the earlier commenting out of the `cancelled_contract_fee_tax` CTE.
*   **1/21/2026, 4:31:12 PM:** The hardcoded `CONTRACT_NUMBER` filter in `base_contracts` is commented out, and the original dynamic date range filtering logic is uncommented and restored.
*   **1/21/2026, 4:32:48 PM:** The final `FROM` and `LEFT JOIN` clauses of the main `SELECT` statement, which were previously truncated, are fully included in the log, completing the query view.

**`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**

This service handles syncing PlotBox data to HubSpot, including contacts, deals, and associations.

*   **1/21/2026, 12:54:56 PM (Initial State):** The `syncPlotBoxData` method includes a debugging statement `dd($dealsBatch);` which would halt execution.
*   **1/22/2026, 11:19:31 AM - 1/22/2026, 11:24:34 AM:** The `dd($dealsBatch);` debugging line is removed from the `syncPlotBoxData` method.

**`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`**

This service is similar to the PlotBox one but specifically for HMIS data, differentiating between 'SHIPOUT' and other service types.

*   **1/30/2026, 3:02:18 PM - 1/30/2026, 3:50:31 PM (Initial State):** The `syncData` method contains a debugging halt `dd($primaryContactBatch);`.
*   **1/30/2026, 3:50:42 PM:** The `dd($primaryContactBatch);` line is commented out in the `syncData` method.
*   **1/30/2026, 4:06:43 PM - 1/30/2026, 4:08:13 PM:** Within the `processContacts` method, the entire `try-catch` block for processing "Primary Contacts" is commented out. A new debugging halt, `dd($deceasedContactsToCreateOrUpdate);`, is added within the "Deceased Contacts" processing block.

### Timestamps of Significant Changes:

*   **1/21/2026, 12:52:00 PM:** Start of explicit debugging in `Contact.php` by hardcoding a contract number and disabling date filters.
*   **1/21/2026, 3:57:10 PM:** Removal of `cancelled_contract_fee_tax` logic in `Contact.php`.
*   **1/21/2026, 4:05:53 PM:** Introduction of a bug in tax amount calculation in `Contact.php` by changing the `TAX_AMOUNT` source.
*   **1/21/2026, 4:16:07 PM:** Bug fix for tax amount calculation in `Contact.php`.
*   **1/21/2026, 4:23:56 PM:** Introduction of a syntax error in SQL `CAST` for `IN` clauses in `Contact.php`.
*   **1/21/2026, 4:26:14 PM:** Correction of the SQL syntax error in `Contact.php`.
*   **1/21/2026, 4:31:12 PM:** Restoration of dynamic date filtering in `Contact.php`, indicating completion of specific contract debugging.
*   **1/22/2026, 11:19:31 AM:** Removal of a debugging halt (`dd`) in `PlotBoxHubSpotService.php`, allowing the sync process to run fully.
*   **1/30/2026, 3:50:42 PM:** Removal of a debugging halt (`dd`) in `HmisHubSpotService.php`.
*   **1/30/2026, 4:06:43 PM:** Temporary disabling of primary contact processing and introduction of a debugging halt for deceased contacts in `HmisHubSpotService.php`.

### Patterns or Recurring Elements:

*   **Debugging with `dd()` and commented code:** A frequent pattern is the insertion of `dd()` (dump and die) statements for debugging, followed by their removal or commenting out once the issue is resolved or the debugging phase passes. Similarly, large blocks of SQL (`cancelled_contract_fee_tax` CTE) or PHP logic (primary contacts processing) are commented out for isolation during development.
*   **Iterative SQL Refinement:** The `Contact.php` file shows an iterative process of refining a complex SQL query, including:
    *   Temporarily changing filtering conditions (date range vs. hardcoded contract ID).
    *   Modifying calculation logic (e.g., `TAX_AMOUNT` source).
    *   Addressing and reverting SQL syntax issues (`CAST` in `IN` clauses).
*   **HubSpot Service Structure:** Both `PlotBoxHubSpotService` and `HmisHubSpotService` follow a very similar structure, including:
    *   Batching `primaryContactBatch`, `deceasedContactBatch`, `dealsBatch`, and `locationAssociations`.
    *   Using `sleep()` calls between HubSpot API operations, likely to adhere to rate limits or allow for data propagation.
    *   Implementing robust error logging with `Log::error` within `try-catch` blocks for processing individual batches.
    *   Calling `searchContact`, `createContact`, `updateContact`, `searchDeal`, `createDeal`, `updateDeal`, and various `associate` methods.
    *   The `HmisHubSpotService` specifically includes logic to differentiate between `SHIPOUT` and non-`SHIPOUT` service types.