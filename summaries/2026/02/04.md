# Activity Summary for 2/4/2026

## 1:23:54 AM
The changes log primarily focuses on two areas: refining a complex SQL query within a Laravel Eloquent model for contact data and actively debugging HubSpot CRM synchronization services.

**File: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**

This file, responsible for the `Contact` model and its `getDataWithDateRange` method, underwent numerous iterative changes, mainly within the embedded SQL query.

*   **1/21/2026, 12:51:05 PM:** The initial logged state of the `getDataWithDateRange` method shows a Snowflake SQL query structured with multiple Common Table Expressions (CTEs) to retrieve detailed contact and contract information, including tax calculations (`contract_fee_tax`, `deed_fee_tax`, `cancelled_contract_fee_tax`) and item counts. The primary `WHERE` clause in `base_contracts` filters by `LAST_UPDATED_DATE_TIME_UTC` or `LAST_UPDATED_DATETIME` within a specified date range.
*   **1/21/2026, 12:52:00 PM - 1:37:28 PM:** The date range filter in the `base_contracts` CTE's `WHERE` clause was commented out and replaced with a hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'`. Additionally, the `Purchase_Price` calculation in the final `SELECT` changed from `COALESCE(cnp.net_price, pc.TOTAL_CASH_PRICE, 0)` to `COALESCE(cnp.net_price, 0)`.
*   **1/21/2026, 3:57:10 PM:** The `cancelled_contract_fee_tax` CTE and its corresponding `LEFT JOIN` in `contract_tax_totals` were commented out, effectively removing "cancelled fee tax" from the total tax calculation.
*   **1/21/2026, 4:05:53 PM:** A potential bug was introduced in the `contract_fee_tax` and `deed_fee_tax` CTEs, where `SUM(f.TAX_AMOUNT * ...)` was incorrectly changed to `SUM(cf.TAX_AMOUNT * ...)` and `SUM(df.TAX_AMOUNT * ...)` respectively, using the contract fee's or deed fee's own tax amount instead of the linked fee's tax amount.
*   **1/21/2026, 4:16:07 PM:** This bug was partially addressed by reverting `contract_fee_tax` to use `f.TAX_AMOUNT` and `deed_fee_tax` to use `df.TAX_AMOUNT` (still not `f.TAX_AMOUNT` for deeds, which might be another oversight). A minor case change was also made for a string literal from `'interest'` to `'Interest'`.
*   **1/21/2026, 4:20:08 PM - 4:23:56 PM:** An attempt was made to explicitly cast `CONTRACT_ID` to `INT` within the `IN` subqueries for tax-related CTEs, like `WHERE cf.CONTRACT_ID IN (CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))`. This introduced a syntax error.
*   **1/21/2026, 4:26:14 PM:** The incorrect `CAST` syntax for `CONTRACT_ID` was removed, reverting the subqueries to `WHERE cf.CONTRACT_ID IN (SELECT CONTRACT_ID FROM base_contracts)`.
*   **1/21/2026, 4:26:47 PM - 4:29:42 PM:** There were several rapid iterations around the `contract_tax_totals` CTE, first attempting to re-include the commented-out `cancelled_fee_tax_total` incorrectly with a wrong alias, then correcting the sum to only include `contract_fee_tax_total` and `deed_fee_tax_total`, and cleaning up the commented lines.
*   **1/21/2026, 4:31:12 PM:** The hardcoded `CONTRACT_NUMBER` filter in `base_contracts` was commented out, and the original date range filter (`CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN ...`) was uncommented, restoring the intended filtering logic.
*   **1/21/2026, 4:32:48 PM:** Additional fields (`Private_Estates_Owned`, `Urns_Owned`, `Vaults_Owned`) were added to the final `SELECT` statement, indicating an expansion of the data being extracted. The full `FROM` and `JOIN` clauses for the main `SELECT` statement were also completed, revealing joins to `item_counts` and `DIM_FACILITY`.
*   **1/22/2026, 11:24:20 AM - 2:29:50 PM:** Subsequent entries for this file appear identical to the 1/21/2026, 4:32:48 PM version, suggesting no further changes after this point in the log.

**File: `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**

This service handles the synchronization of PlotBox data to HubSpot.

*   **1/21/2026, 12:54:56 PM:** The initial log shows the `syncPlotBoxData` method setting up batches for primary contacts, deceased contacts, deals, and location associations. It includes a `dd($dealsBatch);` statement that would halt execution for debugging purposes, preventing the actual processing of data. The `processContacts` method defines the logic for interacting with HubSpot APIs.
*   **1/22/2026, 11:19:31 AM:** The `dd($dealsBatch);` statement in `syncPlotBoxData` was removed, allowing the data synchronization process to proceed to the `processContacts` method.
*   **1/22/2026, 11:24:34 AM - 11:25:42 AM:** The `dd($dealsBatch);` statement in `syncPlotBoxData` was reintroduced and then appears again, indicating repeated toggling for debugging.

**File: `c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`**

This service is similar to the PlotBox one but deals with Hmis data, also synchronizing to HubSpot.

*   **1/30/2026, 3:02:18 PM:** The `syncData` method categorizes data into "SHIPOUT" and non-"SHIPOUT" batches. It includes a `dd($primaryContactBatch);` call for debugging. The `processContacts` method contains logic for creating/updating contacts and deals, including checks for existing owners.
*   **1/30/2026, 3:50:31 PM:** A `dd($primaryContactsToCreateOrUpdate);` statement was added inside the `processContacts` method, specifically after the search for primary contacts, to inspect the results before further processing.
*   **1/30/2026, 3:50:42 PM:** Both `dd()` statements (in `syncData` and `processContacts`) were commented out, suggesting that debugging halts were temporarily disabled for a full run.
*   **1/30/2026, 4:06:43 PM:** The entire primary contacts processing block within `processContacts` was commented out, disabling updates for primary contacts. The `dd($primaryContactBatch);` in `syncData` was uncommented (re-enabled), and a new `dd($deceasedContactsToCreateOrUpdate);` was added to `processContacts` for debugging deceased contact searches. This indicates a shift in focus for debugging.
*   **1/30/2026, 4:08:13 PM:** All `dd()` statements (in `syncData` and `processContacts`) were commented out again, and the primary contact processing block remained commented out, suggesting a preparation for a full run with primary contact processing disabled.

**Patterns and Recurring Elements:**

*   **Extensive Debugging:** A significant pattern across both HubSpot service files (`PlotBoxHubSpotService.php` and `HmisHubSpotService.php`) is the frequent addition and removal (commenting out) of `dd()` statements at various points in the synchronization logic. This clearly indicates active, iterative debugging and testing of the CRM integration, likely to inspect data at different stages or to isolate issues.
*   **SQL Query Iteration:** In `Contact.php`, there's a recurring theme of refining a single, large SQL query. This includes commenting/uncommenting specific filters (date range vs. hardcoded contract number) for testing, fixing calculation logic (e.g., `TAX_AMOUNT` sourcing), addressing syntax errors (`CAST` operations), and incrementally expanding the output fields. The `cancelled_contract_fee_tax` CTE and its inclusion in the total tax calculation were repeatedly toggled (commented out/uncommented).
*   **CRM Synchronization Structure:** Both `PlotBoxHubSpotService` and `HmisHubSpotService` share similar methods (`syncData`, `processContacts`) and use the same underlying HubSpot service components (`HubSpotContactService`, `HubSpotDealService`, `HubSpotLocationService`), highlighting a standardized approach to CRM integration within the application. They also include `sleep()` calls, likely to manage API rate limits or ensure proper sequencing of operations in HubSpot.
*   **Error Handling:** Both HubSpot services consistently use `try-catch` blocks with `Log::error` for resilience and debugging, allowing the system to log failures without necessarily halting the entire process.