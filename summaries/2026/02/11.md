# Activity Summary for 2/11/2026

## 12:57:30 PM
The provided log shows changes across three files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`, `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`, `c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`, and `c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php`, and `c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php`. The changes span from January 21, 2026, to February 10, 2026.

### File-Specific Updates:

1.  **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
    *   **Timestamp Range:** 1/21/2026, 12:51:05 PM to 1/21/2026, 4:32:48 PM, and 1/22/2026, 11:24:20 AM to 1/22/2026, 11:25:33 AM, and finally 1/22/2026, 2:29:50 PM.
    *   **Key Changes:**
        *   **Initial State (1/21, 12:51 PM):** The `getDataWithDateRange` method contains a complex SQL query joining multiple `PLOTBOX_WAREHOUSE.WAREHOUSE_EVERSTORYPARTNERS.DIM_*` tables (DIM_CONTRACT, DIM_CONTACT_OWNER, DIM_CONTACT, DIM_PAYMENT_SCHEDULE, DIM_CONTRACT_FEE, DIM_FEE, DIM_DEED_FEE, DIM_CANCELLED_CONTRACT_FEE, DIM_CONTRACT_WRITER, DIM_SYSTEM_USER, DIM_CONTRACT_ITEM, DIM_FEE_CATEGORY, DIM_FACILITY). The primary filtering condition for `base_contracts` is based on `LAST_UPDATED_DATE_TIME_UTC` or `LAST_UPDATED_DATETIME` within the provided `fromDate` and `toDate`. There's also a production-only filter for `DIM_CONTRACT.STATUS = 'Approved'`. The `cancelled_contract_fee_tax` CTE (Common Table Expression) is active.
        *   **Temporary Hardcoding and Commenting (1/21, 12:52 PM - 1/21, 4:20 PM):**
            *   The main date range filter `(CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN '{$fromDate}' AND '{$toDate}' OR EXISTS (...))` within the `base_contracts` CTE is commented out.
            *   A hardcoded filter `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` is introduced, indicating debugging or specific data testing.
            *   The `cancelled_contract_fee_tax` CTE, and its corresponding join and `COALESCE` in `contract_tax_totals`, are repeatedly commented out and re-enabled/modified across several commits (e.g., 1/21, 3:57 PM comments it out, 1/21, 4:16 PM, 4:20 PM, 4:20 PM, 4:26 PM, 4:27 PM, 4:27 PM, 4:29 PM continue to have it commented out).
            *   Changes related to `cf.TAX_AMOUNT * cf.QUANTITY` vs `f.TAX_AMOUNT * cf.QUANTITY` in `contract_fee_tax` and `deed_fee_tax` CTEs are observed. Specifically, at 1/21, 4:05 PM, `cf.TAX_AMOUNT` is used instead of `f.TAX_AMOUNT` for `contract_fee_tax` and `deed_fee_tax`, which is then reverted in later commits (4:16 PM, 4:20 PM) back to `f.TAX_AMOUNT` for `contract_fee_tax` and `df.TAX_AMOUNT` for `deed_fee_tax`. This looks like a correction in how tax amounts are being calculated, ensuring the tax amount comes from the fee `f` rather than the contract fee `cf` or deed fee `df` directly, and then back to `df.TAX_AMOUNT`.
            *   The hardcoded contract number changes from `'645-110814'` to `'110814'` around 1/21, 4:20 PM.
            *   Some `WHERE ... IN (CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))` clauses are temporarily changed to `WHERE ... IN (SELECT CONTRACT_ID FROM base_contracts)` around 1/21, 4:26 PM, removing the explicit `CAST`.
        *   **Final State (1/22, 2:29 PM):** The temporary hardcoded contract number filter is removed, and the original date range filtering logic for `base_contracts` is restored. The `cancelled_contract_fee_tax` CTE remains commented out. The `contract_tax_totals` CTE no longer attempts to coalesce the `cancelled_fee_tax_total`. The tax calculation for `contract_fee_tax` and `deed_fee_tax` consistently uses `cf.TAX_AMOUNT * cf.QUANTITY` and `df.TAX_AMOUNT * df.QUANTITY` respectively. The final `SELECT` statement mapping output columns appears largely consistent across all logs, primarily the very end of the statement is cut off in most logs.

2.  **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**
    *   **Timestamp Range:** 1/21/2026, 12:54:56 PM to 1/22/2026, 11:25:42 AM.
    *   **Key Changes:**
        *   **Temporary `dd($dealsBatch)` (1/21, 12:54 PM - 1/22, 11:19 AM):** A `dd($dealsBatch)` (dump and die) statement is present immediately after populating the batch arrays in the `syncPlotBoxData` method, indicating debugging of the `dealsBatch` array.
        *   **Removal of `dd($dealsBatch)` (1/22, 11:19 AM):** The `dd($dealsBatch)` statement is removed, allowing the sync process to continue.
        *   **Restoration of `dd($dealsBatch)` (1/22, 11:24 AM - 1/22, 11:25 AM):** The `dd($dealsBatch)` statement is re-introduced and then removed again very quickly, suggesting continued debugging of the deals data.

3.  **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`**
    *   **Timestamp Range:** 1/30/2026, 3:02:18 PM to 2/10/2026, 1:03:39 PM.
    *   **Key Changes:**
        *   **Temporary `dd()` statements (1/30, 3:02 PM - 2/10, 1:03 PM):**
            *   A `dd($primaryContactBatch)` statement is present in the `syncData` method after batching, indicating debugging.
            *   Later, within the `processContacts` method, `dd($primaryContactsToCreateOrUpdate)` (1/30, 3:50 PM, 4:06 PM, 4:08 PM) and `dd($deceasedContactsToCreateOrUpdate)` (1/30, 4:06 PM, 4:08 PM) appear, then commented out and removed in the later timestamps, suggesting a progression of debugging through the contact processing logic.
        *   **Consistent debugging pattern:** The repeated addition and removal/commenting out of `dd()` statements points to active, iterative debugging of the data synchronization process.

4.  **`c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php`**
    *   **Timestamp Range:** 2/10/2026, 12:54:16 PM to 2/10/2026, 1:02:05 PM.
    *   **Key Changes:**
        *   **Introduction of `ZERO_PURCHASE_PRICE` constant (2/10, 1:02 PM):** A new class constant `const ZERO_PURCHASE_PRICE = "0.00";` is added.
        *   **Modification of `mapDeal` method (2/10, 1:02 PM):** The `amount` field in the mapped deal data is changed from `trim($hmisDto->purchasePrice)` to `self::ZERO_PURCHASE_PRICE`, indicating a decision to explicitly set the purchase price to "0.00" during deal mapping, possibly for specific deal types or as a temporary measure.

5.  **`c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php`**
    *   **Timestamp Range:** 2/10/2026, 12:59:03 PM to 2/10/2026, 1:31:21 PM.
    *   **Key Changes:**
        *   **`getDataWithDateRange` query limit (2/10, 12:59 PM):** A `->limit(1)` clause is temporarily added to the `getDataWithDateRange` query.
        *   **Removal of `->limit(1)` (2/10, 1:31 PM):** The `->limit(1)` clause is removed, restoring the query to fetch all matching records within the date range.

### Patterns and Recurring Elements:

*   **Debugging Activity:** A prominent pattern is the repeated insertion and removal/commenting out of `dd()` (dump and die) statements in the `PlotBoxHubSpotService.php` and `HmisHubSpotService.php` files. This strongly suggests active, iterative debugging of the data processing and mapping logic, focusing on the content of data batches (contacts, deals) at various stages of the synchronization process.
*   **SQL Query Iteration:** In `PlotBox\Contact.php`, there are numerous minor modifications to the complex SQL query within the `getDataWithDateRange` method. These include:
    *   Temporary hardcoding of `DIM_CONTRACT.CONTRACT_NUMBER` to specific values (`'645-110814'`, `'110814'`).
    *   Repeated commenting out and un-commenting of the primary date range filter.
    *   Repeated commenting out of the `cancelled_contract_fee_tax` CTE.
    *   Minor adjustments to tax calculation columns (e.g., `cf.TAX_AMOUNT` vs `f.TAX_AMOUNT`).
    *   Temporary changes in `CAST` usage for subqueries.
    This indicates a process of refining or testing the data retrieval logic, possibly to handle specific edge cases, improve performance, or verify data accuracy.
*   **HubSpot Integration Focus:** The services (`PlotBoxHubSpotService`, `HmisHubSpotService`) and mappers (`HmisDataToCrmMapper`) are consistently focused on syncing data to HubSpot, involving contact creation/update, deal creation/update, and association with locations. The use of `HubSpotContactService`, `HubSpotDealService`, `HubSpotLocationService`, and `HubSpotOwnerService` is a recurring theme.
*   **`last_update_dt` and `service_type_code`:** These fields are consistently present in the mapped data for both primary and deceased contacts, as well as deals, in `HmisDataToCrmMapper.php`. This indicates their importance for tracking changes and categorizing service types.
*   **Error Handling:** Both `PlotBoxHubSpotService` and `HmisHubSpotService` include comprehensive try-catch blocks with `Log::error` and detailed error return arrays, suggesting robust error reporting is a requirement.

## 1:57:23 PM
The changes primarily focus on refining data extraction logic for PlotBox contacts and deals, as well as modifications to HubSpot synchronization services for both PlotBox and HMIS data.

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**: This file underwent numerous, rapid changes between 1/21/2026, 12:51:05 PM and 1/21/2026, 4:32:48 PM, mainly concentrated on its `getDataWithDateRange` static method which executes a complex SQL query on a Snowflake database.
    *   Initially (1/21/2026, 12:51:05 PM), the query used dynamic date range filtering and included CTEs for various contract-related data, including `cancelled_contract_fee_tax`.
    *   Between 1/21/2026, 12:52:00 PM and 1/21/2026, 1:37:28 PM, the dynamic date range filter in the `base_contracts` CTE was temporarily commented out and replaced with a hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` filter, likely for testing a specific contract.
    *   At 1/21/2026, 3:57:10 PM, the `cancelled_contract_fee_tax` CTE and its contribution to `total_tax` calculation were commented out.
    *   Further adjustments at 1/21/2026, 4:05:53 PM and 1/21/2026, 4:16:07 PM involved changing the source of `TAX_AMOUNT` in `contract_fee_tax` and `deed_fee_tax` CTEs (from `f.TAX_AMOUNT` to `cf.TAX_AMOUNT` or `df.TAX_AMOUNT`) and a minor case fix for `'interest'` fee type.
    *   Between 1/21/2026, 4:20:08 PM and 1/21/2026, 4:23:56 PM, there were attempts to explicitly cast subquery results to `INT` within the `WHERE IN` clauses of tax-related CTEs, which were then reverted, and the hardcoded contract number for testing was changed from `'645-110814'` to `'110814'`.
    *   At 1/21/2026, 4:26:47 PM, the `cancelled_fee_tax_total` was formally removed from the `total_tax` calculation in `contract_tax_totals`.
    *   Finally, at 1/21/2026, 4:31:12 PM, the hardcoded contract number filter was commented out, restoring the original dynamic date range filtering for the `base_contracts` CTE. A subsequent change at 1/21/2026, 4:32:48 PM shows the completion of the main SELECT statement to include all `item_counts` fields.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**: This service processes PlotBox data for HubSpot synchronization.
    *   On 1/21/2026, 12:54:56 PM, the code included a `dd($dealsBatch)` statement for debugging within the `syncPlotBoxData` method.
    *   By 1/22/2026, 11:19:31 AM, this `dd($dealsBatch)` statement was commented out, indicating the removal of temporary debugging code. Subsequent entries for this file show no further functional changes.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`**: This service handles HMIS data synchronization with HubSpot.
    *   Initially (1/30/2026, 3:02:18 PM), the `syncData` method included a `dd($primaryContactBatch)` statement.
    *   At 1/30/2026, 3:50:31 PM, the `dd($primaryContactBatch)` was commented out, and a `dd($primaryContactsToCreateOrUpdate)` was introduced within the `processContacts` method, shifting the debugging focus.
    *   At 1/30/2026, 4:06:43 PM, the entire `try...catch` block for processing primary contacts was commented out, and the `dd()` statement was moved again to target `deceasedContactsToCreateOrUpdate`.
    *   By 2/10/2026, 12:54:07 PM, the commented-out primary contacts processing block was uncommented, and the debugging `dd()` for deceased contacts was removed, signaling a return to full operation.

*   **`c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php`**: This mapper translates HMIS data to CRM format.
    *   On 2/10/2026, 1:02:05 PM, a new constant `const ZERO_PURCHASE_PRICE = "0.00";` was introduced. Correspondingly, the `mapDeal` method's `amount` field was updated to use this constant, hardcoding the purchase price to "0.00", rather than `trim($hmisDto->purchasePrice)`. This suggests a change in how deal amounts are handled or a temporary override.

*   **`c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php`**: This Eloquent model defines database interactions for HMIS sales.
    *   On 2/10/2026, 12:59:03 PM, the `getDataWithDateRange` method included a `->limit(1)` clause in its SQL query.
    *   At 2/10/2026, 1:31:21 PM, this `->limit(1)` clause was removed, indicating a transition from fetching a single record (likely for testing) to retrieving all matching sales data within the specified date range.

**Patterns and Recurring Elements:**

*   **Debugging Practices:** A prominent pattern is the frequent use of `dd()` (die and dump) and commenting out entire sections of code (`WHERE` clauses, CTEs, or `try...catch` blocks) for debugging purposes, followed by their eventual removal or uncommenting. This suggests an iterative development and testing process.
*   **SQL Query Evolution:** The `PlotBox\Contact.php` file showcases a detailed evolution of a large SQL query, including changes to filtering conditions, calculations (especially tax-related), and schema references, often involving commenting/uncommenting sections.
*   **HubSpot Synchronization Logic:** Both `PlotBoxHubSpotService.php` and `HmisHubSpotService.php` follow a similar structure for syncing data, including batch processing for primary contacts, deceased contacts, and deals, along with handling location associations. They also include `sleep()` calls, possibly to manage API rate limits.
*   **HMIS-Specific Logic:** The HMIS services demonstrate specific handling for "SHIPOUT" service types, separating their processing.
*   **Data Mapping Adjustments:** The `HmisDataToCrmMapper.php` change indicates an adaptation of data mapping rules, specifically concerning the default value for deal amounts.

## 1:57:43 PM
The code changes primarily focus on developing a Paymentus integration for exporting data from various sources within an `es_integration_hub` Laravel application. This involves setting up data models, a console command, an action to handle the export logic, a service for CSV formatting, and a data transfer object. There's also significant configuration of database connections and filesystem disks.

**File-Specific Updates:**

*   **`config\app.php`**:
    *   **2/3/2026, 5:13:46 PM**: The application's default timezone was updated from 'UTC' to 'America/New_York'.

*   **`config\database.php`**:
    *   **2/4/2026, 11:18:26 AM**: This file underwent a significant expansion. New default database connections were introduced for `sims`, `home_office`, `contract_margin`, `hmis`, and `hmis_test`. Detailed configurations for `mysql` connections (`sims`, `corpstruct`, `keyserver`, `home_office`, `contract_margin`), an `sqlsrv` connection, and a `carlib` (DB2/iSeries ODBC) connection were added. This also included specifying `migrations_path` for several connections.
    *   Subsequent entries on **2/4/2026** (11:20:46 AM, 11:22:43 AM, 11:24:38 AM, 11:25:15 AM, 11:26:31 AM) show no functional changes, indicating minor saves or formatting without altering the core database configurations.

*   **`config\filesystems.php`**:
    *   **2/4/2026, 3:31:46 PM**: A new `paymentus` disk configuration was added. It uses the `local` driver and its root path is derived from the `PAYMENTUS_OUTGOING_FILE_PATH` environment variable.
    *   **2/4/2026, 4:28:08 PM**: The default root path for the `paymentus` disk was adjusted to include a trailing slash.

*   **`config\integrations.php`**:
    *   **2/4/2026, 5:40:44 PM**: This new configuration file was created to manage integration settings. Initially, it defined API credentials and an `export_batch_size`.
    *   **2/4/2026, 5:42:22 PM**: The Paymentus-specific settings were encapsulated under a `paymentus` key.
    *   **2/4/2026, 5:42:36 PM**: The default `export_batch_size` for Paymentus was changed from 1000 to 500.

*   **`app\Console\Commands\Integrations\PaymentusExportCommand.php`**:
    *   **2/4/2026, 1:11:46 PM**: A new console command `hub:paymentus-export-command` was created.
    *   **2/4/2026, 3:23:58 PM**: The command's description was updated to reflect its purpose: "Export payments data from PlotBox, HMIS and Carlib to Paymentus in a CIF file".
    *   **2/4/2026, 4:47:21 PM - 5:43:51 PM**: The `handle` method was iteratively developed. It started with placeholders, then integrated the `ExportPaymentusData` action, refined how `disk` and `batchSize` parameters are passed (moving from command options to application configuration), and improved success messages.
    *   **2/5/2026, 2:33:38 PM**: The command's signature was changed to `hub:paymentus-export-file`.
    *   **2/6/2026, 1:18:40 PM - 1:27:37 PM**: The command's logic was refactored to dispatch `ExportPaymentusDataJob` for multiple data sources (initially PlotBox, HMIS, Carlib, though HMIS and Carlib were later commented out in the `$exports` array for the `DimContract` model). The output messaging was also corrected to reflect job dispatching rather than immediate export results.
    *   **2/6/2026, 1:55:04 PM - 1:55:47 PM**: Added a `TODO` comment indicating that `DimContract` needs to be replaced with specific models for HMIS and Carlib, and temporarily commented out these exports.

*   **`app\Models\Paymentus\DimContract.php`**:
    *   **2/4/2026, 1:16:04 PM**: Initial creation of the `DimContract` Eloquent model. It's configured for a 'snowflake' connection and defines relationships to `DimFacility`, `DimPaymentSchedule`, `DimPayment`, and `DimContractOwner`.
    *   **2/4/2026, 1:20:41 PM**: A `scopeForAccountExport` method was added, which generates a complex SQL query to gather comprehensive contract and customer information from multiple related tables for export.
    *   **2/4/2026, 1:36:11 PM - 1:49:19 PM**: Several updates refined the `scopeForAccountExport` query, primarily focusing on standardizing column casing and correctly handling SQL string literals and quoted identifiers within `DB::raw` expressions for Snowflake compatibility.
    *   **2/6/2026, 2:02:05 PM - 2:07:01 PM**: The `$casts` array was briefly updated to include and then remove `paid_and_full_date`, before re-adding it.

*   **`app\Models\Paymentus\DimFacility.php` (2/4/2026, 1:16:57 PM)**: New model, connected to 'snowflake', defining a `contracts` relationship.

*   **`app\Models\Paymentus\DimPaymentSchedule.php` (2/4/2026, 1:17:32 PM, 1:17:39 PM)**: New model, connected to 'snowflake', defining `contract` and `details` relationships. Minor update to add `use` statements.

*   **`app\Models\Paymentus\DimPaymentScheduleDetail.php` (2/4/2026, 1:18:16 PM)**: New model, connected to 'snowflake', casting `COMPLETED_DATE` as a date, and defining a `paymentSchedule` relationship.

*   **`app\Models\Paymentus\DimPayment.php` (2/4/2026, 1:18:48 PM)**: New model, connected to 'snowflake', casting `payment_date` as a date, and defining a `contract` relationship.

*   **`app\Models\Paymentus\DimContractOwner.php` (2/4/2026, 1:19:18 PM)**: New model, connected to 'snowflake', defining `contract` and `contact` relationships.

*   **`app\Models\Paymentus\DimContact.php` (2/4/2026, 1:19:43 PM)**: New model, connected to 'snowflake', casting `NON_MAILABLE_ADDRESS` as a boolean, and defining a `contractOwners` relationship.

*   **`app\Services\Paymentus\CsvExporter.php`**:
    *   **2/4/2026, 4:54:28 PM**: Initial creation of a service for handling CSV file generation, including methods for initialization, writing chunks of data, finalization (saving to disk), defining headers, and mapping records to CSV rows.
    *   **2/4/2026, 4:56:55 PM**: Changed the `League\Csv\Writer` instantiation method from `createFromPath` to `from`.
    *   **2/6/2026, 1:31:35 PM**: Refined the `finalize` method to use an internal `$filename` property instead of recalculating the filename, and updated the `mapRecordToRow` return type hint.

*   **`app\Actions\Paymentus\ExportPaymentusData.php`**:
    *   **2/4/2026, 4:49:29 PM (via temp file)**: Initial version of an action class to orchestrate the Paymentus data export, using `CsvExporter` and `DimContract` to query and process data in chunks. It introduced the `ExportResult` DTO.
    *   **2/4/2026, 5:06:09 PM - 5:16:01 PM**: The `execute` method was developed, first simplifying and then progressively re-adding the export logic. Notably, `DimContact` was briefly used for querying instead of `DimContract` before being corrected. The method's parameters for `disk` and `batchSize` were added, and it began returning an `ExportResult`.
    *   **2/6/2026, 1:14:22 PM - 1:52:54 PM**: Significant refactoring for modularity: the `execute` method was updated to accept a `$modelClass` string and a `$connection` string, allowing it to work with different models and database connections dynamically. Logging was integrated using `Log::info` and `Log::debug`. The `generateFilename` method was enhanced to include a prefix. PHPDoc comments were added.

*   **`app\DataTransferObjects\Paymentus\ExportResult.php`**:
    *   **2/4/2026, 5:18:42 PM**: A new `readonly` DTO was created to encapsulate the results of an export, including `filename` and `lineCount`.
    *   **2/6/2026, 1:35:16 PM**: The `lineCount` property was renamed to `recordCount` for clarity.

*   **`bootstrap\app.php`**:
    *   **2/5/2026, 2:25:10 PM**: An incorrect attempt was made to register `ExportPaymentusData` (an action) as an Artisan command.
    *   **2/5/2026, 2:26:00 PM**: This was corrected to register `PaymentusExportCommand` (the actual command) in the `withCommands` array.

*   **`routes\console.php`**:
    *   **2/5/2026, 2:34:09 PM**: A commented-out line was added to schedule the `hub:paymentus-export-file` command to run daily.

*   **`app\Jobs\Paymentus\ExportPaymentusDataJob.php`**:
    *   **2/6/2026, 1:11:54 PM**: A new `ExportPaymentusDataJob` was created to allow the export process to be queued.
    *   **2/6/2026, 1:14:47 PM**: The job's constructor was updated to accept a `Model` object instead of just a connection string.
    *   **2/6/2026, 1:28:40 PM**: Further refactored: `output` was removed (as jobs don't interact with console output), and `modelClass`, `connection`, `filenamePrefix` were added. Queue properties like `tries` and `timeout` were set, and `Log` messages were introduced for job lifecycle and error handling.
    *   **2/6/2026, 1:29:07 PM**: Added the `Log` facade import.

*   **`app\Actions\Paymentus\UploadToSftp.php` (2/6/2026, 1:45:20 PM)**: A new action was created to handle uploading files to an SFTP server, including error handling and logging.

**Patterns and Recurring Elements:**

*   **Paymentus Integration**: There's a clear, sustained effort to build out a robust Paymentus integration, encompassing data extraction, formatting, and export. All new models, the console command, action, service, and DTO are centered around this.
*   **Layered Architecture**: The development follows a clean architecture pattern with distinct layers:
    *   **Console Command**: `PaymentusExportCommand` for triggering the process.
    *   **Jobs**: `ExportPaymentusDataJob` for asynchronous execution.
    *   **Actions**: `ExportPaymentusData` and `UploadToSftp` encapsulating specific business logic.
    *   **Services**: `CsvExporter` for generic CSV handling.
    *   **Models**: Eloquent models (`DimContract`, `DimFacility`, etc.) for data access.
    *   **DTOs**: `ExportResult` for structured data passing between layers.
*   **Snowflake as Data Source**: Most new Paymentus-related models explicitly connect to 'snowflake' and query tables within `WAREHOUSE_EVERSTORYPARTNERS`, indicating Snowflake is a central data warehouse for this integration.
*   **Database Quoting Adjustments**: The repeated changes to `DB::raw` expressions in `DimContract.php` (specifically regarding double quotes and escaped double quotes for aliases) suggest ongoing fine-tuning to ensure correct SQL syntax for the Snowflake database.
*   **Asynchronous Processing**: The evolution from directly executing the export in the console command to dispatching `ExportPaymentusDataJob` indicates a move towards making data exports more scalable and non-blocking, a common pattern for long-running tasks.
*   **Configuration-Driven**: Extensive use of `.env` variables and `config` files demonstrates a commitment to making the application flexible and configurable across different environments, particularly for database connections and integration settings like batch sizes and file paths.
*   **Logging**: Integration of `Log::info`, `Log::debug`, and `Log::error` across actions and jobs shows a focus on observability and debugging for the integration process.