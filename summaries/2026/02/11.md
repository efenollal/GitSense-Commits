# Activity Summary for 2/11/2026

## 12:57:30 PM
The provided log shows changes across three files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`, `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`, `c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`, and `c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php`, and `c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php`. The changes span from January 21, 2026, to February 10, 2026.

### File-Specific Updates:

1.  **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
    *   **Timestamp Range:** 1/21/2026, 12:51:05 PM to 1/21/2026, 4:32:48 PM, and 1/22/2026, 11:24:20 AM to 1/22/2026, 11:25:33 AM, and finally 1/22/2026, 2:29:50 PM.
    *   **Key Changes:**
        *   **Initial State (1/21, 12:51 PM):** The `getDataWithDateRange` method contains a complex SQL query joining multiple `PLOTBOX_WAREHOUSE.WAREHOUSE_EVERSTORYPARTNERS.DIM_*` tables (DIM_CONTRACT, DIM_CONTACT_OWNER, DIM_CONTACT, DIM_PAYMENT_SCHEDULE, DIM_CONTRACT_FEE, DIM_FEE, DIM_DEED_FEE, DIM_CANCELLED_CONTRACT_FEE, DIM_CONTRACT_WRITER, DIM_SYSTEM_USER, DIM_CONTRACT_ITEM, DIM_FEE_CATEGORY, DIM_FACILITY). The primary filtering condition for `base_contracts` is based on `LAST_UPDATED_DATE_TIME_UTC` or `LAST_UPDATED_DATETIME` within the provided `fromDate` and `toDate`. There's also a production-only filter for `DIM_CONTRACT.STATUS = 'Approved'`. The `cancelled_contract_fee_tax` CTE (Common Table Expression) is active.
        *   **Temporary Hardcoding and Commenting (1/21, 12:52 PM - 1/21, 4:20 PM):**
            *   The main date range filter `(CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN '{$fromDate}' AND '{$toDate}' OR EXISTS (...))` within the `base_contracts` CTE is commented out.
            *   A hardcoded filter `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` is introduced, indicating debugging or specific data testing.
            *   The `cancelled_contract_fee_tax` CTE, and its corresponding join and `COALESCE` in `contract_tax_totals`, are repeatedly commented out and re-enabled/modified across several commits (e.g., 1/21, 3:57 PM comments it out, 1/21, 4:16 PM, 4:20 PM, 4:20 PM, 4:26 PM, 4:27 PM, 4:27 PM, 4:29 PM continue to have it commented out).
            *   Changes related to `cf.TAX_AMOUNT * cf.QUANTITY` vs `f.TAX_AMOUNT * cf.QUANTITY` in `contract_fee_tax` and `deed_fee_tax` CTEs are observed. Specifically, at 1/21, 4:05 PM, `cf.TAX_AMOUNT` is used instead of `f.TAX_AMOUNT` for `contract_fee_tax` and `deed_fee_tax`, which is then reverted in later commits (4:16 PM, 4:20 PM) back to `f.TAX_AMOUNT` for `contract_fee_tax` and `df.TAX_AMOUNT` for `deed_fee_tax`. This looks like a correction in how tax amounts are being calculated, ensuring the tax amount comes from the fee `f` rather than the contract fee `cf` or deed fee `df` directly, and then back to `df.TAX_AMOUNT`.
            *   The hardcoded contract number changes from `'645-110814'` to `'110814'` around 1/21, 4:20 PM.
            *   Some `WHERE ... IN (CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))` clauses are temporarily changed to `WHERE ... IN (SELECT CONTRACT_ID FROM base_contracts)` around 1/21, 4:26 PM, removing the explicit `CAST`.
        *   **Final State (1/22, 2:29 PM):** The temporary hardcoded contract number filter is removed, and the original date range filtering logic for `base_contracts` is restored. The `cancelled_contract_fee_tax` CTE remains commented out. The `contract_tax_totals` CTE no longer attempts to coalesce the `cancelled_fee_tax_total`. The tax calculation for `contract_fee_tax` and `deed_fee_tax` consistently uses `cf.TAX_AMOUNT * cf.QUANTITY` and `df.TAX_AMOUNT * df.QUANTITY` respectively. The final `SELECT` statement mapping output columns appears largely consistent across all logs, primarily the very end of the statement is cut off in most logs.

2.  **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**
    *   **Timestamp Range:** 1/21/2026, 12:54:56 PM to 1/22/2026, 11:25:42 AM.
    *   **Key Changes:**
        *   **Temporary `dd($dealsBatch)` (1/21, 12:54 PM - 1/22, 11:19 AM):** A `dd($dealsBatch)` (dump and die) statement is present immediately after populating the batch arrays in the `syncPlotBoxData` method, indicating debugging of the `dealsBatch` array.
        *   **Removal of `dd($dealsBatch)` (1/22, 11:19 AM):** The `dd($dealsBatch)` statement is removed, allowing the sync process to continue.
        *   **Restoration of `dd($dealsBatch)` (1/22, 11:24 AM - 1/22, 11:25 AM):** The `dd($dealsBatch)` statement is re-introduced and then removed again very quickly, suggesting continued debugging of the deals data.

3.  **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`**
    *   **Timestamp Range:** 1/30/2026, 3:02:18 PM to 2/10/2026, 1:03:39 PM.
    *   **Key Changes:**
        *   **Temporary `dd()` statements (1/30, 3:02 PM - 2/10, 1:03 PM):**
            *   A `dd($primaryContactBatch)` statement is present in the `syncData` method after batching, indicating debugging.
            *   Later, within the `processContacts` method, `dd($primaryContactsToCreateOrUpdate)` (1/30, 3:50 PM, 4:06 PM, 4:08 PM) and `dd($deceasedContactsToCreateOrUpdate)` (1/30, 4:06 PM, 4:08 PM) appear, then commented out and removed in the later timestamps, suggesting a progression of debugging through the contact processing logic.
        *   **Consistent debugging pattern:** The repeated addition and removal/commenting out of `dd()` statements points to active, iterative debugging of the data synchronization process.

4.  **`c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php`**
    *   **Timestamp Range:** 2/10/2026, 12:54:16 PM to 2/10/2026, 1:02:05 PM.
    *   **Key Changes:**
        *   **Introduction of `ZERO_PURCHASE_PRICE` constant (2/10, 1:02 PM):** A new class constant `const ZERO_PURCHASE_PRICE = "0.00";` is added.
        *   **Modification of `mapDeal` method (2/10, 1:02 PM):** The `amount` field in the mapped deal data is changed from `trim($hmisDto->purchasePrice)` to `self::ZERO_PURCHASE_PRICE`, indicating a decision to explicitly set the purchase price to "0.00" during deal mapping, possibly for specific deal types or as a temporary measure.

5.  **`c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php`**
    *   **Timestamp Range:** 2/10/2026, 12:59:03 PM to 2/10/2026, 1:31:21 PM.
    *   **Key Changes:**
        *   **`getDataWithDateRange` query limit (2/10, 12:59 PM):** A `->limit(1)` clause is temporarily added to the `getDataWithDateRange` query.
        *   **Removal of `->limit(1)` (2/10, 1:31 PM):** The `->limit(1)` clause is removed, restoring the query to fetch all matching records within the date range.

### Patterns and Recurring Elements:

*   **Debugging Activity:** A prominent pattern is the repeated insertion and removal/commenting out of `dd()` (dump and die) statements in the `PlotBoxHubSpotService.php` and `HmisHubSpotService.php` files. This strongly suggests active, iterative debugging of the data processing and mapping logic, focusing on the content of data batches (contacts, deals) at various stages of the synchronization process.
*   **SQL Query Iteration:** In `PlotBox\Contact.php`, there are numerous minor modifications to the complex SQL query within the `getDataWithDateRange` method. These include:
    *   Temporary hardcoding of `DIM_CONTRACT.CONTRACT_NUMBER` to specific values (`'645-110814'`, `'110814'`).
    *   Repeated commenting out and un-commenting of the primary date range filter.
    *   Repeated commenting out of the `cancelled_contract_fee_tax` CTE.
    *   Minor adjustments to tax calculation columns (e.g., `cf.TAX_AMOUNT` vs `f.TAX_AMOUNT`).
    *   Temporary changes in `CAST` usage for subqueries.
    This indicates a process of refining or testing the data retrieval logic, possibly to handle specific edge cases, improve performance, or verify data accuracy.
*   **HubSpot Integration Focus:** The services (`PlotBoxHubSpotService`, `HmisHubSpotService`) and mappers (`HmisDataToCrmMapper`) are consistently focused on syncing data to HubSpot, involving contact creation/update, deal creation/update, and association with locations. The use of `HubSpotContactService`, `HubSpotDealService`, `HubSpotLocationService`, and `HubSpotOwnerService` is a recurring theme.
*   **`last_update_dt` and `service_type_code`:** These fields are consistently present in the mapped data for both primary and deceased contacts, as well as deals, in `HmisDataToCrmMapper.php`. This indicates their importance for tracking changes and categorizing service types.
*   **Error Handling:** Both `PlotBoxHubSpotService` and `HmisHubSpotService` include comprehensive try-catch blocks with `Log::error` and detailed error return arrays, suggesting robust error reporting is a requirement.