# Activity Summary for 2/12/2026

## 9:07:40 AM
The code changes primarily involve two files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` which defines data retrieval logic for PlotBox contacts, and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php` which handle data synchronization with HubSpot for PlotBox and HMIS data, respectively. Additionally, `c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php` and `c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php` received updates related to HMIS data processing.

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**:
    *   **1/21/2026, 12:51:05 PM**: The initial version of the `getDataWithDateRange` SQL query was present, filtering contracts by `LAST_UPDATED_DATE_TIME_UTC` or `LAST_UPDATED_DATETIME` within a date range. It also included a `cancelled_contract_fee_tax` calculation in the `contract_tax_totals`.
    *   **1/21/2026, 12:52:00 PM - 1:37:28 PM**: The date range filtering in the `base_contracts` CTE was commented out and replaced with a hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` filter.
    *   **1/21/2026, 3:57:10 PM**: The `cancelled_contract_fee_tax` CTE itself was commented out, and its sum was removed from the `contract_tax_totals` calculation.
    *   **1/21/2026, 4:05:53 PM**: The tax calculation logic within `contract_fee_tax` and `deed_fee_tax` CTEs was modified to use `cf.TAX_AMOUNT * cf.QUANTITY` and `df.TAX_AMOUNT * df.QUANTITY`, respectively, instead of `f.TAX_AMOUNT`.
    *   **1/21/2026, 4:16:07 PM**: A minor casing change from `LOWER(f.FEE_TYPE) != 'interest'` to `LOWER(f.FEE_TYPE) != 'Interest'` occurred in `contract_fee_tax`.
    *   **1/21/2026, 4:20:08 PM**: `CAST(... AS INT)` was explicitly added to the subqueries for `CONTRACT_ID` in `contract_fee_tax` and `deed_fee_tax`.
    *   **1/21/2026, 4:20:13 PM**: The hardcoded contract number filter was changed from `'645-110814'` to `'110814'`.
    *   **1/21/2026, 4:23:56 PM - 4:26:14 PM**: The `CAST(... AS INT)` was removed from the `CONTRACT_ID` subqueries, correcting a potential syntax issue.
    *   **1/21/2026, 4:26:47 PM - 4:27:46 PM**: Further refinements to the `contract_tax_totals` CTE involved removing commented lines related to `cancelled_fee_tax_total` and simplifying the total tax calculation to only include `contract_fee_tax_total` and `deed_fee_tax_total`.
    *   **1/21/2026, 4:31:12 PM**: The hardcoded contract number filter was commented out, restoring the original date range filter for `base_contracts`.
    *   **1/21/2026, 4:32:48 PM**: The main `SELECT` statement was completed, resolving truncated `COALESCE` statements for `item_counts` and adding `LEFT JOIN` clauses for `item_counts`, `contract_tax_totals`, `contract_net_prices`, and `DIM_FACILITY`.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**:
    *   **1/21/2026, 12:54:56 PM**: Contained a `dd($dealsBatch);` debugging statement in the `syncPlotBoxData` method, which would halt script execution.
    *   **1/22/2026, 11:19:31 AM**: The `dd($dealsBatch);` statement was removed, allowing the sync process to proceed.
    *   **1/22/2026, 11:24:34 AM**: The `dd($dealsBatch);` statement was re-introduced.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`**:
    *   **1/30/2026, 3:02:18 PM**: This file manages the synchronization of HMIS data to HubSpot, segmenting data by 'SHIPOUT' status. It included a `dd($primaryContactBatch);` for debugging. The `processContacts` method actively searched for and updated contacts and deals.
    *   **1/30/2026, 3:50:31 PM**: The `try-catch` block for processing primary contacts within `processContacts` was commented out, and a `dd($primaryContactsToCreateOrUpdate);` was added.
    *   **1/30/2026, 3:50:42 PM**: The `dd($primaryContactBatch);` in `syncData` was commented out, but the `dd($primaryContactsToCreateOrUpdate);` in `processContacts` remained.
    *   **2/10/2026, 12:54:07 PM**: The debugging `dd()` statements were removed, and the `try-catch` block for primary contacts in `processContacts` was restored.
    *   **2/10/2026, 12:58:40 PM**: A `dd($dealsBatch);` was added back into the `syncData` method.
    *   **2/10/2026, 1:03:10 PM - 1:03:39 PM**: The processing logic for primary contacts in `processContacts` was repeatedly commented out, and a `dd($deceasedContactsToCreateOrUpdate);` was briefly added and removed, indicating active debugging of contact processing.

*   **`c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php`**:
    *   **2/10/2026, 12:54:16 PM**: Defined data mapping methods for HubSpot contacts and deals, where `mapDeal` used `trim($hmisDto->purchasePrice)` for the `amount`.
    *   **2/10/2026, 1:02:05 PM**: A new constant `ZERO_PURCHASE_PRICE` was introduced, and the `mapDeal` method was modified to set the deal's `amount` to this `0.00` constant, overriding the actual purchase price.

*   **`c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php`**:
    *   **2/10/2026, 12:59:03 PM**: The `getDataWithDateRange` method's SQL query included a `->limit(1)` clause.
    *   **2/10/2026, 1:31:21 PM**: The `->limit(1)` clause was removed from the query.

**Patterns and Recurring Elements:**

A prominent pattern is the **intermittent addition and removal of `dd()` debugging statements**, particularly in the `PlotBoxHubSpotService.php` and `HmisHubSpotService.php` files. This suggests an iterative development and testing process, where code execution was frequently paused to inspect data at various stages of the HubSpot synchronization.

Another recurring element in `PlotBox\Contact.php` is the **experimentation with the SQL `WHERE` clauses** for filtering contracts, toggling between a dynamic date range and a hardcoded contract number, and then reverting to the dynamic date range. Similarly, the `cancelled_contract_fee_tax` CTE and its inclusion in the total tax calculation were repeatedly commented out, then completely removed from the sum, indicating changes in business logic or data availability regarding cancelled contract fees. The SQL query also showed a pattern of minor corrections related to data type casting and field references (`f.TAX_AMOUNT` vs. `cf.TAX_AMOUNT`).

Across the HubSpot service files, there's consistent use of `try-catch` blocks for individual processing steps (e.g., primary contacts, deceased contacts, deals, associations) to ensure resilience and partial processing even if certain steps fail. This highlights a focus on robust error handling in the integration services. Both services also separate contacts into "primary" and "deceased" batches and handle "location associations."

The modifications in `HmisDataToCrmMapper.php` and `Hmis\Sale.php` suggest changes in how HMIS sales data is retrieved and mapped to HubSpot, specifically the decision to hardcode deal amounts to zero and adjustments in the SQL query to fetch sales data.