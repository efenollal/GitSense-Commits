# Activity Summary for 2/2/2026

## 10:07:44 AM
The log primarily details iterative changes to two PHP files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`, with later additions for `c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`.

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`** (1/21/2026, 12:51:05 PM - 1/22/2026, 11:25:33 AM):
    *   **Initial State:** The file defines an Eloquent model for `Contact` connected to a Snowflake `PLOTBOX_WAREHOUSE` and includes a `getDataWithDateRange` static method. This method executes a large, multi-CTE SQL query designed to retrieve detailed contract and contact information, including tax calculations and item counts, for a given date range. It also includes a production-specific filter for `Approved` contract statuses.
    *   **1/21/2026, 12:52:00 PM - 1:37:28 PM:** The core date range filtering in the `base_contracts` CTE's `WHERE` clause was commented out, and a hardcoded filter `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` was introduced, likely for debugging or testing a specific contract.
    *   **1/21/2026, 3:57:10 PM:** The `cancelled_contract_fee_tax` CTE and its reference in the `contract_tax_totals` CTE were commented out, effectively removing 'cancelled fee tax' from the total tax calculation.
    *   **1/21/2026, 4:05:53 PM - 4:16:07 PM:** Minor adjustments were made to the `SUM` aggregation logic within the `contract_fee_tax` and `deed_fee_tax` CTEs (e.g., `f.TAX_AMOUNT` vs `cf.TAX_AMOUNT`), suggesting corrections in column referencing for tax amounts. A case change from `'interest'` to `'Interest'` was also applied.
    *   **1/21/2026, 4:20:08 PM - 4:20:13 PM:** The hardcoded contract number for debugging was changed from `'645-110814'` to `'110814'`. Attempts were made to cast the subquery `(SELECT CONTRACT_ID FROM base_contracts)` to `INT` within the `WHERE IN` clauses of tax calculation CTEs, although this was syntactically incorrect.
    *   **1/21/2026, 4:23:56 PM - 4:26:14 PM:** These `CAST` attempts were subsequently corrected and then entirely reverted, restoring the `WHERE ci.CONTRACT_ID IN (SELECT CONTRACT_ID FROM base_contracts)` pattern.
    *   **1/21/2026, 4:26:47 PM - 4:27:46 PM:** A brief error was introduced in `contract_tax_totals` by incorrectly referencing `cft.cancelled_fee_tax_total` before being corrected to properly omit the `cancelled_fee_tax_total` part from the sum, aligning with the earlier comment-out of the `cancelled_contract_fee_tax` CTE.
    *   **1/21/2026, 4:31:12 PM:** The hardcoded `CONTRACT_NUMBER` filter was removed/commented out, reverting the `base_contracts` CTE back to its original date range filtering logic for `LAST_UPDATED_DATE_TIME_UTC`.
    *   **1/22/2026, 11:24:20 AM - 11:25:33 AM:** The final `SELECT` clause of the main query was completed with all `item_counts` columns, and the necessary `LEFT JOIN item_counts ic` was added, indicating the full integration of itemized contract data.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`** (1/21/2026, 12:54:56 PM - 1/22/2026, 11:25:42 AM):
    *   This service handles syncing PlotBox data to HubSpot.
    *   **1/21/2026, 12:54:56 PM:** An immediate `dd($dealsBatch)` debugging statement was present after data mapping, which would halt the script.
    *   **1/22/2026, 11:19:31 AM:** The `dd($dealsBatch)` statement was removed, allowing the sync process to execute.
    *   **1/22/2026, 11:24:34 AM - 11:25:42 AM:** The `dd($dealsBatch)` statement was briefly re-introduced and then removed again, consistent with a pattern of adding/removing debug halts during testing.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`** (1/30/2026, 3:02:18 PM - 1/30/2026, 4:08:13 PM):
    *   This service handles syncing HMIS data to HubSpot, similar in structure to `PlotBoxHubSpotService`. It includes logic to differentiate between "SHIPOUT" and other service types.
    *   **1/30/2026, 3:02:18 PM:** Contained a `dd($primaryContactBatch)` in `syncData`. The `processContacts` method was designed to handle primary, deceased contacts, and deals with checks for existing owners.
    *   **1/30/2026, 3:50:31 PM:** An additional `dd($primaryContactsToCreateOrUpdate)` was inserted inside the primary contacts processing logic within `processContacts`.
    *   **1/30/2026, 3:50:42 PM:** Both `dd()` statements in `syncData` and `processContacts` were commented out.
    *   **1/30/2026, 4:06:43 PM - 4:08:13 PM:** The entire primary contacts processing block (including the `searchContact`, `createContact`, and `updateContact` calls for primary contacts) within the `processContacts` method was commented out, effectively disabling primary contact synchronization for HMIS. Simultaneously, a `dd($deceasedContactsToCreateOrUpdate)` was introduced within the deceased contacts processing block.

**Timestamps of Significant Changes:**

*   **1/21/2026, 12:52:00 PM:** Start of SQL query debugging/modification in `Contact.php` (commenting out date filter, adding hardcoded contract number).
*   **1/21/2026, 3:57:10 PM:** Removal of `cancelled_contract_fee_tax` CTE from calculation in `Contact.php`.
*   **1/21/2026, 4:31:12 PM:** Reversion of `Contact.php` `base_contracts` CTE to original date range filtering.
*   **1/22/2026, 11:24:20 AM - 11:25:33 AM:** Completion of the main SQL `SELECT` statement and `JOIN`s in `Contact.php`.
*   **1/22/2026, 11:19:31 AM:** First removal of `dd()` in `PlotBoxHubSpotService.php` for continued execution.
*   **1/30/2026, 3:50:42 PM:** Disabling of `dd()` statements in `HmisHubSpotService.php`.
*   **1/30/2026, 4:06:43 PM - 4:08:13 PM:** Commenting out of the entire primary contact processing logic in `HmisHubSpotService.php` and adding `dd()` for deceased contacts.

**Patterns and Recurring Elements:**

*   **Debugging Iterations:** A consistent pattern of inserting `dd()` (dump and die) statements, hardcoding filter values in SQL, and commenting out blocks of code for isolated testing or debugging is evident across both `Contact.php` and the HubSpot service files. These debugging artifacts are often removed or commented out in subsequent commits.
*   **SQL Query Complexity:** The `getDataWithDateRange` method in `Contact.php` uses a very elaborate Snowflake SQL query with multiple Common Table Expressions (CTEs) (`base_contracts`, `payment_schedule_totals`, `contract_fee_tax`, `deed_fee_tax`, `contract_tax_totals`, `contract_net_prices`, `contract_writers`, `item_counts`, `primary_contacts`, `deceased_contacts`) to aggregate and transform data.
*   **CRM Sync Logic:** Both `PlotBoxHubSpotService` and `HmisHubSpotService` implement similar high-level logic for syncing data to HubSpot: fetching data, mapping it, processing primary contacts, deceased contacts, deals, and creating associations with locations.
*   **Error Handling and Logging:** Both HubSpot services use `try-catch` blocks around major processing steps and log errors (`Log::error`), indicating a focus on resilience and observability.
*   **Rate Limiting Mitigation:** `sleep()` calls (e.g., `sleep(10)`, `sleep(5)`) are used within the `processContacts` methods of HubSpot services, suggesting an awareness of and strategy for handling API rate limits during batch operations.
*   **Data Segmentation:** The `HmisHubSpotService` specifically demonstrates logic for segmenting data based on `serviceTypeCode` ('SHIPOUT' vs. others) into different batches for processing.

## 1:09:00 PM
The code changes primarily involve two areas: a Laravel Eloquent model for PlotBox contacts (`Contact.php`) and two HubSpot integration services (`PlotBoxHubSpotService.php` and `HmisHubSpotService.php`).

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
    *   **1/21/2026, 12:51:05 PM (Initial State):** The file defines a `Contact` Eloquent model connected to a Snowflake database. It includes a `getDataWithDateRange` static method that executes a complex SQL query using multiple Common Table Expressions (CTEs) to fetch contract and contact details. This initial version filters data by a date range for both contract and contact last updated dates and includes `cancelled_contract_fee_tax` in total tax calculations.
    *   **1/21/2026, 12:52:00 PM:** The date range filter in the `base_contracts` CTE was commented out and replaced with a fixed filter for a specific `CONTRACT_NUMBER = '645-110814'`. This change likely indicates a testing or debugging phase.
    *   **1/21/2026, 12:54:01 PM:** The `Purchase_Price` calculation in the final `SELECT` statement was adjusted to use `COALESCE(cnp.net_price, 0)` instead of falling back to `pc.TOTAL_CASH_PRICE`.
    *   **1/21/2026, 3:57:10 PM:** The `cancelled_contract_fee_tax` CTE and its inclusion in `contract_tax_totals` were commented out, effectively removing them from the query logic.
    *   **1/21/2026, 4:05:53 PM & 4:16:07 PM:** Minor corrections were made to tax amount calculations in `contract_fee_tax` and `deed_fee_tax` CTEs. The `SUM` aggregate for tax was changed from using `f.TAX_AMOUNT` to `cf.TAX_AMOUNT` or `df.TAX_AMOUNT`, implying the tax amount is now directly available on the contract/deed fee items. A case change `LOWER(f.FEE_TYPE) != 'interest'` to `'Interest'` also occurred.
    *   **1/21/2026, 4:20:08 PM & 4:20:13 PM:** An explicit `CAST(... AS INT)` was temporarily added to subqueries within `WHERE ... IN` clauses (e.g., `WHERE cf.CONTRACT_ID IN (CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))`) for `contract_fee_tax` and `deed_fee_tax`. The hardcoded `CONTRACT_NUMBER` was also slightly changed from `'645-110814'` to `'110814'`.
    *   **1/21/2026, 4:23:56 PM & 4:26:14 PM:** The explicit `CAST(... AS INT)` was removed, and a syntax error (`IN SELECT`) introduced during the previous change was corrected.
    *   **1/21/2026, 4:26:47 PM & 4:27:14 PM & 4:27:46 PM:** A temporary and erroneous re-inclusion of `cancelled_fee_tax_total` in `contract_tax_totals` was quickly reverted.
    *   **1/21/2026, 4:31:12 PM:** The fixed `CONTRACT_NUMBER` filter was commented out, reactivating the original date range filter `(CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN '{$fromDate}' AND '{$toDate}' OR EXISTS (...))`. This suggests the debugging with a specific contract number concluded.
    *   **1/22/2026, 11:24:20 AM:** The `cancelled_contract_fee_tax` CTE and its related join in `contract_tax_totals` were permanently removed from the query, and the `SELECT` statement was fully completed (no longer truncated).

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**
    *   **1/21/2026, 12:54:56 PM (Initial State):** This service is designed to sync PlotBox data to HubSpot, handling primary and deceased contacts, deals, and their associations with locations. It uses `sleep()` calls (10 seconds and 5 seconds) after processing batches, likely for API rate limiting or to allow HubSpot to process. A `dd($dealsBatch)` debug statement was present in `syncPlotBoxData`.
    *   **1/22/2026, 11:19:31 AM:** The `dd($dealsBatch)` debug statement in `syncPlotBoxData` was removed.
    *   **1/22/2026, 11:24:34 AM:** The `dd($dealsBatch)` debug statement was reintroduced.
    *   **1/22/2026, 11:25:42 AM:** The `dd($dealsBatch)` debug statement was removed again.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`**
    *   **1/30/2026, 3:02:18 PM (Initial State):** Similar to the PlotBox service, this service syncs HMIS data to HubSpot, distinguishing between 'SHIPOUT' and non-'SHIPOUT' service types. It uses a similar pattern of batch processing, mapping, and HubSpot API interactions (contacts, deals, locations). It included a `dd($primaryContactBatch)` debug call. Additional `checkContactOwnerExists` and `checkDealOwnerExists` methods are called before updating contacts and deals.
    *   **1/30/2026, 3:50:31 PM:** A `dd($primaryContactsToCreateOrUpdate)` debug statement was added *inside* the `processContacts` method, specifically within the primary contacts processing logic.
    *   **1/30/2026, 3:50:42 PM:** The `dd($primaryContactBatch)` in `syncData` was commented out, while the newly added `dd($primaryContactsToCreateOrUpdate)` remained active.
    *   **1/30/2026, 4:06:43 PM:** The entire primary contacts processing block (`try-catch`) within `processContacts` was commented out. A `dd($deceasedContactsToCreateOrUpdate)` debug statement was added within the deceased contacts processing block.
    *   **1/30/2026, 4:08:13 PM:** No functional changes from the previous timestamp, retaining the commented-out primary contact processing and the deceased contact debug statement.

**Patterns and Recurring Elements:**

*   **Iterative Debugging:** A prominent pattern across both HubSpot service files is the frequent addition, removal, or commenting-out of `dd()` (dump and die) statements, indicating an active and iterative debugging process. This suggests the developers were testing specific parts of the data processing and API calls.
*   **HubSpot Service Architecture:** Both `PlotBoxHubSpotService` and `HmisHubSpotService` share a common structure for interacting with HubSpot, involving data retrieval, mapping to CRM properties, batch processing of contacts and deals, and associating them with locations. They both employ `sleep()` calls, likely for HubSpot API rate limit management, and extensive `try-catch` blocks for error handling and resilience.
*   **Complex SQL Queries:** The `Contact` model consistently utilizes multi-CTE SQL queries for data aggregation, reflecting a need for comprehensive and structured data from the Snowflake warehouse.
*   **Production Environment Filtering:** The `PlotBox\Contact.php` model consistently includes a conditional filter (`AND DIM_CONTRACT.STATUS = 'Approved'`) for production environments, ensuring only approved contracts are processed.
*   **Error Logging:** Both HubSpot services make consistent use of `Log::error` to capture and log exceptions, including detailed messages and stack traces, which is crucial for monitoring data synchronization processes.