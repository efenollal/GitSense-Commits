# Activity Summary for 2/2/2026

## 10:07:44 AM
The log primarily details iterative changes to two PHP files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`, with later additions for `c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`.

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`** (1/21/2026, 12:51:05 PM - 1/22/2026, 11:25:33 AM):
    *   **Initial State:** The file defines an Eloquent model for `Contact` connected to a Snowflake `PLOTBOX_WAREHOUSE` and includes a `getDataWithDateRange` static method. This method executes a large, multi-CTE SQL query designed to retrieve detailed contract and contact information, including tax calculations and item counts, for a given date range. It also includes a production-specific filter for `Approved` contract statuses.
    *   **1/21/2026, 12:52:00 PM - 1:37:28 PM:** The core date range filtering in the `base_contracts` CTE's `WHERE` clause was commented out, and a hardcoded filter `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` was introduced, likely for debugging or testing a specific contract.
    *   **1/21/2026, 3:57:10 PM:** The `cancelled_contract_fee_tax` CTE and its reference in the `contract_tax_totals` CTE were commented out, effectively removing 'cancelled fee tax' from the total tax calculation.
    *   **1/21/2026, 4:05:53 PM - 4:16:07 PM:** Minor adjustments were made to the `SUM` aggregation logic within the `contract_fee_tax` and `deed_fee_tax` CTEs (e.g., `f.TAX_AMOUNT` vs `cf.TAX_AMOUNT`), suggesting corrections in column referencing for tax amounts. A case change from `'interest'` to `'Interest'` was also applied.
    *   **1/21/2026, 4:20:08 PM - 4:20:13 PM:** The hardcoded contract number for debugging was changed from `'645-110814'` to `'110814'`. Attempts were made to cast the subquery `(SELECT CONTRACT_ID FROM base_contracts)` to `INT` within the `WHERE IN` clauses of tax calculation CTEs, although this was syntactically incorrect.
    *   **1/21/2026, 4:23:56 PM - 4:26:14 PM:** These `CAST` attempts were subsequently corrected and then entirely reverted, restoring the `WHERE ci.CONTRACT_ID IN (SELECT CONTRACT_ID FROM base_contracts)` pattern.
    *   **1/21/2026, 4:26:47 PM - 4:27:46 PM:** A brief error was introduced in `contract_tax_totals` by incorrectly referencing `cft.cancelled_fee_tax_total` before being corrected to properly omit the `cancelled_fee_tax_total` part from the sum, aligning with the earlier comment-out of the `cancelled_contract_fee_tax` CTE.
    *   **1/21/2026, 4:31:12 PM:** The hardcoded `CONTRACT_NUMBER` filter was removed/commented out, reverting the `base_contracts` CTE back to its original date range filtering logic for `LAST_UPDATED_DATE_TIME_UTC`.
    *   **1/22/2026, 11:24:20 AM - 11:25:33 AM:** The final `SELECT` clause of the main query was completed with all `item_counts` columns, and the necessary `LEFT JOIN item_counts ic` was added, indicating the full integration of itemized contract data.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`** (1/21/2026, 12:54:56 PM - 1/22/2026, 11:25:42 AM):
    *   This service handles syncing PlotBox data to HubSpot.
    *   **1/21/2026, 12:54:56 PM:** An immediate `dd($dealsBatch)` debugging statement was present after data mapping, which would halt the script.
    *   **1/22/2026, 11:19:31 AM:** The `dd($dealsBatch)` statement was removed, allowing the sync process to execute.
    *   **1/22/2026, 11:24:34 AM - 11:25:42 AM:** The `dd($dealsBatch)` statement was briefly re-introduced and then removed again, consistent with a pattern of adding/removing debug halts during testing.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`** (1/30/2026, 3:02:18 PM - 1/30/2026, 4:08:13 PM):
    *   This service handles syncing HMIS data to HubSpot, similar in structure to `PlotBoxHubSpotService`. It includes logic to differentiate between "SHIPOUT" and other service types.
    *   **1/30/2026, 3:02:18 PM:** Contained a `dd($primaryContactBatch)` in `syncData`. The `processContacts` method was designed to handle primary, deceased contacts, and deals with checks for existing owners.
    *   **1/30/2026, 3:50:31 PM:** An additional `dd($primaryContactsToCreateOrUpdate)` was inserted inside the primary contacts processing logic within `processContacts`.
    *   **1/30/2026, 3:50:42 PM:** Both `dd()` statements in `syncData` and `processContacts` were commented out.
    *   **1/30/2026, 4:06:43 PM - 4:08:13 PM:** The entire primary contacts processing block (including the `searchContact`, `createContact`, and `updateContact` calls for primary contacts) within the `processContacts` method was commented out, effectively disabling primary contact synchronization for HMIS. Simultaneously, a `dd($deceasedContactsToCreateOrUpdate)` was introduced within the deceased contacts processing block.

**Timestamps of Significant Changes:**

*   **1/21/2026, 12:52:00 PM:** Start of SQL query debugging/modification in `Contact.php` (commenting out date filter, adding hardcoded contract number).
*   **1/21/2026, 3:57:10 PM:** Removal of `cancelled_contract_fee_tax` CTE from calculation in `Contact.php`.
*   **1/21/2026, 4:31:12 PM:** Reversion of `Contact.php` `base_contracts` CTE to original date range filtering.
*   **1/22/2026, 11:24:20 AM - 11:25:33 AM:** Completion of the main SQL `SELECT` statement and `JOIN`s in `Contact.php`.
*   **1/22/2026, 11:19:31 AM:** First removal of `dd()` in `PlotBoxHubSpotService.php` for continued execution.
*   **1/30/2026, 3:50:42 PM:** Disabling of `dd()` statements in `HmisHubSpotService.php`.
*   **1/30/2026, 4:06:43 PM - 4:08:13 PM:** Commenting out of the entire primary contact processing logic in `HmisHubSpotService.php` and adding `dd()` for deceased contacts.

**Patterns and Recurring Elements:**

*   **Debugging Iterations:** A consistent pattern of inserting `dd()` (dump and die) statements, hardcoding filter values in SQL, and commenting out blocks of code for isolated testing or debugging is evident across both `Contact.php` and the HubSpot service files. These debugging artifacts are often removed or commented out in subsequent commits.
*   **SQL Query Complexity:** The `getDataWithDateRange` method in `Contact.php` uses a very elaborate Snowflake SQL query with multiple Common Table Expressions (CTEs) (`base_contracts`, `payment_schedule_totals`, `contract_fee_tax`, `deed_fee_tax`, `contract_tax_totals`, `contract_net_prices`, `contract_writers`, `item_counts`, `primary_contacts`, `deceased_contacts`) to aggregate and transform data.
*   **CRM Sync Logic:** Both `PlotBoxHubSpotService` and `HmisHubSpotService` implement similar high-level logic for syncing data to HubSpot: fetching data, mapping it, processing primary contacts, deceased contacts, deals, and creating associations with locations.
*   **Error Handling and Logging:** Both HubSpot services use `try-catch` blocks around major processing steps and log errors (`Log::error`), indicating a focus on resilience and observability.
*   **Rate Limiting Mitigation:** `sleep()` calls (e.g., `sleep(10)`, `sleep(5)`) are used within the `processContacts` methods of HubSpot services, suggesting an awareness of and strategy for handling API rate limits during batch operations.
*   **Data Segmentation:** The `HmisHubSpotService` specifically demonstrates logic for segmenting data based on `serviceTypeCode` ('SHIPOUT' vs. others) into different batches for processing.

## 1:09:00 PM
The code changes primarily involve two areas: a Laravel Eloquent model for PlotBox contacts (`Contact.php`) and two HubSpot integration services (`PlotBoxHubSpotService.php` and `HmisHubSpotService.php`).

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
    *   **1/21/2026, 12:51:05 PM (Initial State):** The file defines a `Contact` Eloquent model connected to a Snowflake database. It includes a `getDataWithDateRange` static method that executes a complex SQL query using multiple Common Table Expressions (CTEs) to fetch contract and contact details. This initial version filters data by a date range for both contract and contact last updated dates and includes `cancelled_contract_fee_tax` in total tax calculations.
    *   **1/21/2026, 12:52:00 PM:** The date range filter in the `base_contracts` CTE was commented out and replaced with a fixed filter for a specific `CONTRACT_NUMBER = '645-110814'`. This change likely indicates a testing or debugging phase.
    *   **1/21/2026, 12:54:01 PM:** The `Purchase_Price` calculation in the final `SELECT` statement was adjusted to use `COALESCE(cnp.net_price, 0)` instead of falling back to `pc.TOTAL_CASH_PRICE`.
    *   **1/21/2026, 3:57:10 PM:** The `cancelled_contract_fee_tax` CTE and its inclusion in `contract_tax_totals` were commented out, effectively removing them from the query logic.
    *   **1/21/2026, 4:05:53 PM & 4:16:07 PM:** Minor corrections were made to tax amount calculations in `contract_fee_tax` and `deed_fee_tax` CTEs. The `SUM` aggregate for tax was changed from using `f.TAX_AMOUNT` to `cf.TAX_AMOUNT` or `df.TAX_AMOUNT`, implying the tax amount is now directly available on the contract/deed fee items. A case change `LOWER(f.FEE_TYPE) != 'interest'` to `'Interest'` also occurred.
    *   **1/21/2026, 4:20:08 PM & 4:20:13 PM:** An explicit `CAST(... AS INT)` was temporarily added to subqueries within `WHERE ... IN` clauses (e.g., `WHERE cf.CONTRACT_ID IN (CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))`) for `contract_fee_tax` and `deed_fee_tax`. The hardcoded `CONTRACT_NUMBER` was also slightly changed from `'645-110814'` to `'110814'`.
    *   **1/21/2026, 4:23:56 PM & 4:26:14 PM:** The explicit `CAST(... AS INT)` was removed, and a syntax error (`IN SELECT`) introduced during the previous change was corrected.
    *   **1/21/2026, 4:26:47 PM & 4:27:14 PM & 4:27:46 PM:** A temporary and erroneous re-inclusion of `cancelled_fee_tax_total` in `contract_tax_totals` was quickly reverted.
    *   **1/21/2026, 4:31:12 PM:** The fixed `CONTRACT_NUMBER` filter was commented out, reactivating the original date range filter `(CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN '{$fromDate}' AND '{$toDate}' OR EXISTS (...))`. This suggests the debugging with a specific contract number concluded.
    *   **1/22/2026, 11:24:20 AM:** The `cancelled_contract_fee_tax` CTE and its related join in `contract_tax_totals` were permanently removed from the query, and the `SELECT` statement was fully completed (no longer truncated).

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**
    *   **1/21/2026, 12:54:56 PM (Initial State):** This service is designed to sync PlotBox data to HubSpot, handling primary and deceased contacts, deals, and their associations with locations. It uses `sleep()` calls (10 seconds and 5 seconds) after processing batches, likely for API rate limiting or to allow HubSpot to process. A `dd($dealsBatch)` debug statement was present in `syncPlotBoxData`.
    *   **1/22/2026, 11:19:31 AM:** The `dd($dealsBatch)` debug statement in `syncPlotBoxData` was removed.
    *   **1/22/2026, 11:24:34 AM:** The `dd($dealsBatch)` debug statement was reintroduced.
    *   **1/22/2026, 11:25:42 AM:** The `dd($dealsBatch)` debug statement was removed again.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`**
    *   **1/30/2026, 3:02:18 PM (Initial State):** Similar to the PlotBox service, this service syncs HMIS data to HubSpot, distinguishing between 'SHIPOUT' and non-'SHIPOUT' service types. It uses a similar pattern of batch processing, mapping, and HubSpot API interactions (contacts, deals, locations). It included a `dd($primaryContactBatch)` debug call. Additional `checkContactOwnerExists` and `checkDealOwnerExists` methods are called before updating contacts and deals.
    *   **1/30/2026, 3:50:31 PM:** A `dd($primaryContactsToCreateOrUpdate)` debug statement was added *inside* the `processContacts` method, specifically within the primary contacts processing logic.
    *   **1/30/2026, 3:50:42 PM:** The `dd($primaryContactBatch)` in `syncData` was commented out, while the newly added `dd($primaryContactsToCreateOrUpdate)` remained active.
    *   **1/30/2026, 4:06:43 PM:** The entire primary contacts processing block (`try-catch`) within `processContacts` was commented out. A `dd($deceasedContactsToCreateOrUpdate)` debug statement was added within the deceased contacts processing block.
    *   **1/30/2026, 4:08:13 PM:** No functional changes from the previous timestamp, retaining the commented-out primary contact processing and the deceased contact debug statement.

**Patterns and Recurring Elements:**

*   **Iterative Debugging:** A prominent pattern across both HubSpot service files is the frequent addition, removal, or commenting-out of `dd()` (dump and die) statements, indicating an active and iterative debugging process. This suggests the developers were testing specific parts of the data processing and API calls.
*   **HubSpot Service Architecture:** Both `PlotBoxHubSpotService` and `HmisHubSpotService` share a common structure for interacting with HubSpot, involving data retrieval, mapping to CRM properties, batch processing of contacts and deals, and associating them with locations. They both employ `sleep()` calls, likely for HubSpot API rate limit management, and extensive `try-catch` blocks for error handling and resilience.
*   **Complex SQL Queries:** The `Contact` model consistently utilizes multi-CTE SQL queries for data aggregation, reflecting a need for comprehensive and structured data from the Snowflake warehouse.
*   **Production Environment Filtering:** The `PlotBox\Contact.php` model consistently includes a conditional filter (`AND DIM_CONTRACT.STATUS = 'Approved'`) for production environments, ensuring only approved contracts are processed.
*   **Error Logging:** Both HubSpot services make consistent use of `Log::error` to capture and log exceptions, including detailed messages and stack traces, which is crucial for monitoring data synchronization processes.

## 2:08:37 PM
The `config/database.php` file, last modified on 2/2/2026 at 2:03:30 PM, centralizes the application's database connection configurations. It defines a default Laravel MySQL connection and several other named connections for distinct services: `sims`, `home_office`, `contract_margin`, `corpstruct`, and `keyserver`, all configured for MySQL. An `sqlsrv` connection for MSSQL is also present, pulling details for a `STONEMOR_PROD` database from environment variables, including a `trust_server_certificate` setting.

A significant portion of the file is dedicated to a `carlib` connection, explicitly configured for DB2 using the `db2_ibmi_odbc` driver. This connection includes numerous specific `odbc_keywords` for detailed setup, such as `CommitMode`, `Naming`, `DateFormat`, and `CCSID`, among others. There are also extensive commented-out sections indicating previous attempts and explorations with PostgreSQL (`pgsql`) and various ODBC/DB2 driver configurations, suggesting historical troubleshooting or alternative connection strategies. The file ends abruptly within the `odbc_keywords` array.

**Patterns and Recurring Elements:**

*   **Environment Variable Dependence:** A strong pattern across all active database configurations is the reliance on environment variables (e.g., `env('DB_HOST')`, `env('SIMS_DATABASE')`) for sensitive credentials and connection details, promoting secure and flexible deployment.
*   **Multi-Database Environment:** The application is designed to interact with a diverse ecosystem of database systems, including multiple MySQL instances (for core application, SIMS, Home Office, Contract Margin, Corporate Structure, and Key Server), MSSQL (for `sqlsrv` connections), and specifically DB2 (for `carlib`). This indicates a complex integration hub.
*   **Integration Focus:** The presence of distinct connections for systems like SIMS, Home Office, Contract Margin, Corporate Structure, and Key Server highlights the application's role as an integration point for various internal and external data sources.
*   **DB2 Connectivity Challenges/Refinements:** The numerous commented-out DB2 connection attempts and the detailed, specific configuration for the `carlib` DB2 connection suggest a focused effort or past challenges in establishing robust connectivity with DB2 systems.

## 2:09:13 PM
The log primarily details development and debugging efforts across two core components: a Laravel Eloquent Model `Contact.php` responsible for querying PlotBox data from a Snowflake warehouse, and two HubSpot integration services, `PlotBoxHubSpotService.php` and `HmisHubSpotService.php`, which sync data to HubSpot.

### File-Specific Updates:

**`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**

*   **1/21/2026, 12:51:05 PM:** The initial state of the `Contact` model is shown, featuring a complex `getDataWithDateRange` SQL query using multiple Common Table Expressions (CTEs) to retrieve contact, contract, fee, and item count data, filtering by a date range and `DIM_CONTRACT.STATUS = 'Approved'` in production environments. It includes calculations for `total_cash_price`, various tax components, and categorizes contract items (e.g., caskets, cremation products).
*   **1/21/2026, 12:52:00 PM - 1/21/2026, 1:37:28 PM:** The primary filtering mechanism in the `base_contracts` CTE's `WHERE` clause was temporarily changed from a dynamic date range to a hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'`, effectively disabling the date filter for specific contract testing.
*   **1/21/2026, 3:57:10 PM:** The `cancelled_contract_fee_tax` CTE and its corresponding summation in `contract_tax_totals` were entirely commented out, indicating a temporary removal or refactoring of cancelled fee tax calculations.
*   **1/21/2026, 4:05:53 PM:** A bug was introduced in the `contract_fee_tax` and `deed_fee_tax` CTEs where the `SUM` calculation incorrectly referenced `cf.TAX_AMOUNT` instead of `f.TAX_AMOUNT` (from the joined `DIM_FEE` table). The `deed_fee_tax` calculation also incorrectly used `cf.TAX_AMOUNT` where `cf` was not defined.
*   **1/21/2026, 4:16:07 PM:** The `contract_fee_tax` calculation was corrected back to `SUM(f.TAX_AMOUNT * cf.QUANTITY)`. However, the `deed_fee_tax` calculation was partially fixed to `SUM(df.TAX_AMOUNT * df.QUANTITY)`, which was still incorrect as `df` (DIM_DEED_FEE) does not contain `TAX_AMOUNT`. A minor case change was also made in `LOWER(f.FEE_TYPE) != 'Interest'`.
*   **1/21/2026, 4:20:08 PM - 1/21/2026, 4:20:28 PM:** An attempt to explicitly cast `CONTRACT_ID` in the `IN` subqueries to `INT` was introduced with the potentially erroneous syntax `IN (CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))`. The hardcoded contract number filter in `base_contracts` was also adjusted to `'110814'`.
*   **1/21/2026, 4:23:56 PM:** The casting syntax in `IN` clauses was further modified, introducing a clear syntax error in the `deed_fee_tax` CTE.
*   **1/21/2026, 4:26:14 PM:** The problematic `CAST` syntax in the `IN` clauses was reverted, restoring them to `IN (SELECT CONTRACT_ID FROM base_contracts)`. The `deed_fee_tax` calculation remained incorrect.
*   **1/21/2026, 4:26:47 PM:** The commented-out `cancelled_fee_tax_total` was reintroduced into the `contract_tax_totals` sum, but with a typo (`cft.cancelled_fee_tax_total` instead of `ccft.cancelled_fee_tax_total`), while the `cancelled_contract_fee_tax` CTE itself remained commented out.
*   **1/21/2026, 4:27:14 PM - 1/21/2026, 4:29:42 PM:** The line attempting to include `cancelled_fee_tax_total` in `contract_tax_totals` was progressively commented out and then cleanly removed from the sum, finalizing its exclusion.
*   **1/21/2026, 4:31:12 PM:** The hardcoded `DIM_CONTRACT.CONTRACT_NUMBER` filter was commented out, and the original dynamic date range filter in `base_contracts` was re-enabled, restoring the intended functionality for date-based data retrieval.
*   **1/22/2026, 11:24:20 AM:** The bug in the `deed_fee_tax` calculation was finally resolved, reverting it to the correct `COALESCE(SUM(f.TAX_AMOUNT * df.QUANTITY), 0)`. The cleanup of the `contract_tax_totals` CTE was also finalized.
*   **1/22/2026, 11:25:33 AM & 1/22/2026, 2:29:50 PM:** These timestamps reflect the stable, corrected state of the `Contact.php` model with the date range filter active, and the `cancelled_contract_fee_tax` explicitly excluded.

**`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**

*   **1/21/2026, 12:54:56 PM:** An initial version of the PlotBox HubSpot integration service is shown. It fetches PlotBox data, maps it to HubSpot entities (primary/deceased contacts, deals), and processes them for creation, update, and association with locations. A `dd($dealsBatch)` statement is present in the `syncPlotBoxData` method, indicating debugging.
*   **1/22/2026, 11:19:31 AM:** The `dd($dealsBatch)` debugging statement was removed, suggesting that the debugging phase for deals data was completed or moved.
*   **1/22/2026, 11:24:34 AM - 1/22/2026, 11:25:42 AM:** The `dd($dealsBatch)` statement was re-introduced into the `syncPlotBoxData` method, indicating a return to or continuation of debugging that specific data batch.

**`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`**

*   **1/30/2026, 3:02:18 PM:** A new HubSpot integration service for HMIS data (`HmisHubSpotService`) was introduced. This service is structurally similar to `PlotBoxHubSpotService` but includes logic to differentiate and process "SHIPOUT" and non-"SHIPOUT" `serviceTypeCode`s into separate batches. A `dd($primaryContactBatch)` statement is present in `syncData`. New methods `checkContactOwnerExists` and `checkDealOwnerExists` are called within `processContacts` before updates.
*   **1/30/2026, 3:50:31 PM:** No functional changes. The `dd($primaryContactBatch)` persists.
*   **1/30/2026, 3:50:42 PM:** The `dd($primaryContactBatch)` debugging statement was commented out.
*   **1/30/2026, 4:06:43 PM - 1/30/2026, 4:08:13 PM:** The entire processing block for primary contacts within the `processContacts` method was commented out, and a `dd($deceasedContactsToCreateOrUpdate)` statement was inserted into the deceased contacts processing block. This indicates a shift in debugging focus from primary to deceased contacts, temporarily disabling primary contact synchronization.

### Patterns and Recurring Elements:

*   **Debugging with `dd()` and commenting out code:** A strong recurring pattern is the use of `dd()` (dump and die) statements for debugging specific data batches or intermediate results, and temporarily commenting out large blocks of code (SQL `WHERE` clauses, CTEs, or entire PHP processing steps) to isolate and test functionalities. These are often re-enabled or removed after debugging.
*   **Iterative SQL Refinement:** The `Contact.php` file shows an iterative process of refining a complex SQL query, including introducing, attempting to fix, and finally correcting bugs related to tax calculations and subquery casting.
*   **Modular HubSpot Integration Services:** Both `PlotBoxHubSpotService` and `HmisHubSpotService` demonstrate a consistent architectural pattern for integrating external data into HubSpot, involving data fetching, mapping, batched processing (create/update/search), and association management, all within robust `try-catch` blocks and incorporating `sleep()` calls for API interaction management.
*   **Consistent Data Structures:** Both HubSpot services process data into similar batch structures for primary contacts, deceased contacts, and deals, and manage location associations.
*   **Clear Timestamp Progression:** The timestamps clearly show a progression of development work: initial implementation, debugging phases (marked by `dd()` and commenting), bug introduction, and subsequent fixes or feature refinements.

## 4:08:58 PM
The log details changes across two main files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`, with later additions for `c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`.

**File-specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` (Multiple timestamps on 1/21/2026 and 1/22/2026):**
    *   This file defines an Eloquent model for `Contact` that interacts with a Snowflake warehouse, primarily through a `getDataWithDateRange` static method containing a large SQL query.
    *   **SQL Query Iteration:** The most significant changes involve the refinement and debugging of this complex SQL query.
        *   **Initial Debugging (1/21/2026, 12:52 PM - 4:27 PM):** The `base_contracts` Common Table Expression (CTE) was temporarily modified to filter by a hardcoded `CONTRACT_NUMBER` (`'645-110814'`, then `'110814'`) instead of the dynamic date range, likely for isolated testing.
        *   **Tax Calculation Logic (1/21/2026, 4:05 PM - 4:16 PM):** Corrections were made in the `contract_fee_tax` and `deed_fee_tax` CTEs, changing the source of `TAX_AMOUNT` from the `DIM_FEE` table (`f.TAX_AMOUNT`) to the respective contract/deed fee tables (`cf.TAX_AMOUNT`, `df.TAX_AMOUNT`). A minor capitalization change from `'interest'` to `'Interest'` was also applied in a `LOWER(f.FEE_TYPE)` comparison.
        *   **CTE Management (1/21/2026, 3:57 PM - 4:26 PM; 1/22/2026, 11:24 AM):** The `cancelled_contract_fee_tax` CTE was initially commented out, and its reference in `contract_tax_totals` was eventually commented out and then completely removed, streamlining the tax calculation to `contract_fee_tax_total` and `deed_fee_tax_total`.
        *   **Type Casting Attempts (1/21/2026, 4:20 PM - 4:26 PM):** There were attempts to explicitly cast `CONTRACT_ID` to `INT` within `WHERE ... IN (SELECT ...)` clauses in `contract_fee_tax`, `deed_fee_tax`, and `cancelled_contract_fee_tax` (when it was present/commented), which led to a temporary syntax error (missing parenthesis) before being fully reverted.
        *   **Reversion to Dynamic Filter (1/21/2026, 4:31 PM):** The `base_contracts` CTE's filter was reverted from the hardcoded contract number back to the original date range logic.
        *   **Full Query Visibility (1/22/2026, 11:24 AM):** The final log entry for this file shows the complete SQL `SELECT` statement, which was truncated in all previous log entries, indicating the full query structure and selected columns are now stable.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (Multiple timestamps on 1/21/2026 and 1/22/2026):**
    *   This service handles syncing PlotBox data to HubSpot. The key changes revolve around debugging statements.
    *   **Debugging Sessions (1/21/2026, 12:54 PM - 1/22/2026, 11:25 AM):** The `dd($dealsBatch);` statement was repeatedly added and removed within the `syncPlotBoxData` method, indicating ongoing inspection of the `$dealsBatch` variable during development or testing.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php` (Multiple timestamps on 1/30/2026):**
    *   This service handles syncing HMIS data to HubSpot, including logic for "SHIPOUT" service types.
    *   **Tiered Debugging (1/30/2026, 3:02 PM - 4:08 PM):** Debugging `dd()` statements were progressively introduced and adjusted to inspect different stages of the contact processing:
        *   Initially, `dd($primaryContactBatch);` was used in `syncData`.
        *   Later, `dd($primaryContactsToCreateOrUpdate);` was added inside the `processContacts` method to inspect the results of contact searching.
        *   The debugging focus then shifted, with the primary contacts processing `try` block being entirely commented out, and `dd($deceasedContactsToCreateOrUpdate);` being added to inspect deceased contacts. This suggests a step-by-step approach to debug different parts of the sync logic.

**Timestamps of Significant Changes:**

*   **1/21/2026, 12:52:00 PM:** Initial implementation of hardcoded contract number filter in `PlotBox\Contact.php` for debugging.
*   **1/21/2026, 3:57:10 PM:** `cancelled_contract_fee_tax` CTE is commented out in `PlotBox\Contact.php`.
*   **1/21/2026, 4:05:53 PM:** Correction of `TAX_AMOUNT` source in `PlotBox\Contact.php` SQL.
*   **1/21/2026, 4:31:12 PM:** Reversion of contract number filter to date range in `PlotBox\Contact.php`, signifying completion of contract-specific debugging.
*   **1/22/2026, 11:19:31 AM:** Removal of `dd()` in `PlotBoxHubSpotService.php`, indicating a temporary debugging phase concluded.
*   **1/22/2026, 11:24:20 AM:** Final cleanup and full disclosure of the SQL query in `PlotBox\Contact.php` (removing `cancelled_contract_fee_tax` CTE and completing the `SELECT` clause).
*   **1/30/2026, 3:50:31 PM:** Introduction of deeper, staged `dd()` debugging in `HmisHubSpotService.php` to analyze `primaryContactsToCreateOrUpdate`.
*   **1/30/2026, 4:06:43 PM:** Temporary commenting out of the entire primary contact processing in `HmisHubSpotService.php` and shifting debug `dd()` to deceased contacts.

**Patterns or Recurring Elements:**

1.  **Iterative Debugging with `dd()`:** A prominent pattern is the frequent use of `dd()` (dump and die) statements to pause execution and inspect variables. These statements are added, moved, commented out, and removed across both `PlotBoxHubSpotService.php` and `HmisHubSpotService.php`, indicating an active, step-by-step debugging process.
2.  **SQL Query Evolution:** The `PlotBox\Contact.php` file shows a continuous refinement of a complex SQL query, involving:
    *   Temporary hardcoding of filters for specific contract testing.
    *   Adjustments to join conditions and aggregate functions (e.g., `TAX_AMOUNT` sourcing).
    *   Experimentation with and eventual removal of specific CTEs (like `cancelled_contract_fee_tax`).
    *   Attempts and reversals of explicit type casting in subqueries.
3.  **HubSpot Integration Structure:** Both HubSpot service files (`PlotBoxHubSpotService.php` and `HmisHubSpotService.php`) share a common architecture for data synchronization: fetching, mapping, batching (primary contacts, deceased contacts, deals), and processing these batches (search, create, update, associate). They also consistently employ `try-catch` blocks for resilience and `sleep()` calls, likely to manage API rate limits.
4.  **Content Truncation in Logs:** Many log entries for `PlotBox\Contact.php` show truncation at the end of the SQL query, which only resolves in the final entry for that file. This highlights the large size of the SQL query being developed.