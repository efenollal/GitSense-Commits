# Activity Summary for 2/6/2026

## 3:28:03 AM
The provided log details changes across two main files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and two HubSpot service files, `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`.

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` (Multiple timestamps on 1/21/2026 and 1/22/2026):**
    *   **SQL Query Filtering:** The primary focus of changes in this file revolves around the `getDataWithDateRange` static method's complex SQL query.
        *   Initially, the `base_contracts` Common Table Expression (CTE) filters data by a date range using `LAST_UPDATED_DATE_TIME_UTC` or `dc.LAST_UPDATED_DATETIME`. (1/21/2026, 12:51:05 PM)
        *   Between 1/21/2026, 12:52:00 PM, and 1/21/2026, 4:27:46 PM, the date range filter was repeatedly commented out and replaced with a hardcoded `DIM_CONTRACT.CONTRACT_NUMBER` filter (e.g., `'645-110814'`, then `'110814'`). This suggests a phase of focused debugging or testing on specific contracts rather than a broad date range.
        *   The original date range filter was restored, and the hardcoded contract number removed, at 1/21/2026, 4:31:12 PM. This indicates a return to the intended production logic.
    *   **Tax Calculation Logic:**
        *   The `cancelled_contract_fee_tax` CTE was initially included, then completely commented out at 1/21/2026, 3:57:10 PM, and its reference in `contract_tax_totals` was also commented out.
        *   At 1/21/2026, 4:05:53 PM, a bug was introduced in `contract_fee_tax` and `deed_fee_tax` where `cf.TAX_AMOUNT` was mistakenly used instead of `f.TAX_AMOUNT` or `df.TAX_AMOUNT` for tax calculation. This was partially corrected for `deed_fee_tax` at 1/21/2026, 4:16:07 PM, using `df.TAX_AMOUNT`.
    *   **SQL Type Casting:**
        *   At 1/21/2026, 4:20:08 PM, explicit `CAST(... AS INT)` was added to subqueries within `WHERE ... IN` clauses (e.g., `cf.CONTRACT_ID IN (CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))`), likely addressing a type mismatch or stricter database requirement.
        *   This syntax was then incorrectly altered at 1/21/2026, 4:23:56 PM, introducing SQL syntax errors (missing `CAST` keyword or parenthesis for one case).
        *   These syntax errors were reverted at 1/21/2026, 4:26:14 PM, by removing the explicit `CAST` from the subquery entirely, effectively reverting to the implicit casting or original behavior.
    *   **Code Truncation:** Several entries in the log for this file show truncated SQL queries at the end of the `SELECT` statement, suggesting an artifact of the log generation or display rather than intentional code truncations. The full query appears to be restored in the final entries.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (1/21/2026, 12:54:56 PM to 1/22/2026, 11:25:42 AM):**
    *   The `syncPlotBoxData` method, responsible for syncing PlotBox data to HubSpot, frequently had a `dd($dealsBatch);` debugging statement added (1/21/2026, 12:54:56 PM), removed (1/22/2026, 11:19:31 AM), and then re-added (1/22/2026, 11:24:34 AM). This indicates active testing and debugging of the deal processing flow.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php` (1/30/2026, 3:02:18 PM to 1/30/2026, 4:08:13 PM):**
    *   The `syncData` method, which syncs Hmis data to HubSpot, also saw debugging statements being introduced and modified.
    *   A `dd($primaryContactBatch);` was present in `syncData` (1/30/2026, 3:02:18 PM) and later commented out (1/30/2026, 3:50:42 PM).
    *   A `dd($primaryContactsToCreateOrUpdate);` was introduced within the `processContacts` method for primary contacts (1/30/2026, 3:50:31 PM).
    *   Later, the entire primary contacts processing block in `processContacts` was commented out, and a `dd($deceasedContactsToCreateOrUpdate);` was added for deceased contacts (1/30/2026, 4:06:43 PM). This indicates a shift in debugging focus from initial data preparation to primary contact processing, and then to deceased contact processing, while temporarily disabling previous steps.

**Timestamps of Significant Changes:**

*   **1/21/2026, 12:52:00 PM:** Hardcoded contract number filter introduced in `PlotBox\Contact.php` for debugging.
*   **1/21/2026, 3:57:10 PM:** `cancelled_contract_fee_tax` CTE commented out in `PlotBox\Contact.php`.
*   **1/21/2026, 4:05:53 PM:** Introduction of a bug in `TAX_AMOUNT` calculation in `contract_fee_tax` and `deed_fee_tax` in `PlotBox\Contact.php`.
*   **1/21/2026, 4:16:07 PM:** Partial fix for `TAX_AMOUNT` bug in `deed_fee_tax` and minor case change in `LOWER(f.FEE_TYPE) != 'Interest'` in `PlotBox\Contact.php`.
*   **1/21/2026, 4:20:08 PM:** Attempt to introduce explicit `CAST(... AS INT)` in SQL subqueries within `PlotBox\Contact.php`.
*   **1/21/2026, 4:23:56 PM:** Introduction of SQL syntax errors related to `CAST` in `PlotBox\Contact.php`.
*   **1/21/2026, 4:31:12 PM:** Reversion of `PlotBox\Contact.php`'s `getDataWithDateRange` SQL query to use date range filtering and removal of hardcoded contract number. Also, the SQL query is fully presented, suggesting the previous truncations were logging artifacts.
*   **1/22/2026, 11:19:31 AM:** Removal of `dd($dealsBatch);` debugging halt in `PlotBoxHubSpotService.php`.
*   **1/22/2026, 11:24:34 AM:** Re-introduction of `dd($dealsBatch);` debugging halt in `PlotBoxHubSpotService.php`.
*   **1/30/2026, 3:50:31 PM:** Introduction of `dd($primaryContactsToCreateOrUpdate);` for debugging primary contacts in `HmisHubSpotService.php`.
*   **1/30/2026, 4:06:43 PM:** Primary contact processing commented out and `dd($deceasedContactsToCreateOrUpdate);` introduced for debugging deceased contacts in `HmisHubSpotService.php`.

**Patterns or Recurring Elements:**

*   **Frequent Debugging:** The most prominent pattern is the repeated insertion, removal, or commenting out of `dd()` (dump and die) statements, and temporary hardcoding of filters in SQL queries. This strongly suggests an active development or debugging phase across these services, where specific data flows are being inspected or isolated.
*   **Iterative SQL Refinement:** The `PlotBox\Contact.php` file shows an iterative process of adjusting, breaking, and fixing the embedded SQL query, particularly concerning type casting and tax calculation logic.
*   **Similar Service Structure:** Both `PlotBoxHubSpotService` and `HmisHubSpotService` follow a consistent architecture for integrating with HubSpot, using similar batch processing for primary contacts, deceased contacts, deals, and location associations, leveraging common HubSpot service components. This indicates a shared design pattern for CRM data synchronization.
*   **Focus on Contact and Deal Synchronization:** All changes revolve around the core functionality of syncing contact and deal data from internal systems (PlotBox, Hmis) to HubSpot, including handling different types of contacts (primary, deceased) and their associations.