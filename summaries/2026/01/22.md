# Activity Summary for 1/22/2026

## 3:26:10 AM
**File: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**

This file, representing the `Contact` Eloquent model for the `PLOTBOX_WAREHOUSE` database, underwent numerous iterative changes throughout the log. The core functionality is a `getDataWithDateRange` static method that executes a complex Snowflake SQL query to retrieve contract and contact-related data, including various fee and tax calculations, as well as item counts and details about primary and deceased contacts.

**Key Updates and Timestamps:**

*   **1/21/2026, 12:51:05 PM:** The initial version includes a date range filter in the `base_contracts` CTE and logic for `cancelled_contract_fee_tax`. The `contract_fee_tax` WHERE clause specifically excludes 'interest' fees (case-insensitive).
*   **1/21/2026, 12:52:00 PM & 12:54:01 PM:** The original date range filtering in `base_contracts` is commented out and replaced with a hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'`. This was likely done for focused debugging or testing of a specific contract. A minor regression or intended change occurred in the final `SELECT` for `Purchase_Price`, where `COALESCE(cnp.net_price, pc.TOTAL_CASH_PRICE, 0)` was simplified to `COALESCE(cnp.net_price, 0)`, omitting `pc.TOTAL_CASH_PRICE` as a fallback.
*   **1/21/2026, 3:57:10 PM:** The `cancelled_contract_fee_tax` CTE and its inclusion in the `contract_tax_totals` calculation are commented out, indicating that cancelled fees are temporarily or permanently excluded from the tax calculation.
*   **1/21/2026, 4:05:53 PM:** There's a change in the `contract_fee_tax` and `deed_fee_tax` CTEs where `SUM(f.TAX_AMOUNT * cf.QUANTITY)` became `SUM(cf.TAX_AMOUNT * cf.QUANTITY)` (and similarly for `deed_fee_tax` incorrectly referencing `cf.TAX_AMOUNT`), suggesting an adjustment in how tax amounts are sourced (from fee table `f` to contract fee table `cf`).
*   **1/21/2026, 4:16:07 PM:** The `deed_fee_tax` CTE is corrected to use `df.TAX_AMOUNT` (from the `DIM_DEED_FEE` table) instead of `cf.TAX_AMOUNT`. Also, the `LOWER(f.FEE_TYPE)` comparison is changed from `'interest'` to `'Interest'`, suggesting a case-specific adjustment.
*   **1/21/2026, 4:20:08 PM & 4:20:13 PM:** Explicit casting `(CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))` is added to `WHERE ... IN` clauses within several CTEs, indicating attempts to resolve potential type mismatch issues. Concurrently, the hardcoded contract number for testing is changed from `'645-110814'` to `'110814'`.
*   **1/21/2026, 4:23:56 PM:** The `CAST(... AS INT)` syntax for the `IN` subqueries is corrected (or reverted) by removing the `AS INT` from inside the subquery's parentheses, implying the previous change introduced a syntax error.
*   **1/21/2026, 4:26:47 PM & 4:27:14 PM & 4:29:42 PM:** Further refinements are made to the `contract_tax_totals` CTE, specifically addressing the (still commented out) `cancelled_contract_fee_tax`. An erroneous reference to `cft.cancelled_fee_tax_total` is removed, ultimately solidifying the exclusion of cancelled fee tax from the total calculation.
*   **1/21/2026, 4:31:12 PM & 4:32:48 PM:** The hardcoded `CONTRACT_NUMBER` filter is finally commented out, and the original date range filtering logic in `base_contracts` is uncommented, restoring the method to its intended production-like functionality based on `fromDate` and `toDate` parameters.

**File: `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**

*   **1/21/2026, 12:54:56 PM:** This file defines `PlotBoxHubSpotService`, a service responsible for syncing PlotBox data to HubSpot. It integrates with various HubSpot services (Contact, Deal, Location) and uses a `PlotBoxDataToCrmMapper` to transform data. The `syncPlotBoxData` method fetches data for a given date range, processes it into batches for primary contacts, deceased contacts, and deals. A `dd($dealsBatch)` statement is present, indicating that the synchronization process was paused for debugging purposes at the deal batching stage. The service includes robust error handling with individual `try-catch` blocks for processing primary contacts, deceased contacts, contact associations, deals, and location associations, along with strategic `sleep()` calls to manage API rate limits or allow for data propagation within HubSpot.

**Patterns and Recurring Elements:**

*   **Iterative SQL Debugging:** The `Contact.php` file shows a clear pattern of iterative development and debugging within its SQL query. This includes commenting out/in large sections, testing specific data points (e.g., `CONTRACT_NUMBER = '...'`), experimenting with data types (`CAST(... AS INT)`), and refining calculations.
*   **Focus on Tax Calculations:** Several changes in `Contact.php` revolve around the calculation of `contract_fee_tax`, `deed_fee_tax`, and `cancelled_contract_fee_tax`, indicating these were areas requiring precise adjustment and potentially encountering issues. The `cancelled_contract_fee_tax` repeatedly being commented out or having its inclusion in `contract_tax_totals` removed suggests ongoing challenges or a decision to exclude it.
*   **Data Consistency Issue:** The omission of `pc.TOTAL_CASH_PRICE` from the `Purchase_Price` `COALESCE` statement (`COALESCE(cnp.net_price, 0)`) in the final `SELECT` in `Contact.php` after the first few changes is a recurring potential bug throughout almost all subsequent log entries for this file.
*   **Robust HubSpot Integration:** The `PlotBoxHubSpotService.php` demonstrates a structured and resilient approach to external API integration, featuring clear separation of concerns (mapping, service calls), batch processing, detailed logging, and error handling. The use of `sleep()` calls indicates an awareness of external API limitations.

## 11:14:43 AM
The log primarily details changes within two PHP files related to a data synchronization process: `app\Models\PlotBox\Contact.php` and `app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`.

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**: This file contains an Eloquent model with a complex `getDataWithDateRange` static method that executes a large SQL query against a Snowflake database.
    *   **Initial State (1/21/2026, 12:51:05 PM)**: The SQL query includes a date range filter and a CTE for `cancelled_contract_fee_tax`.
    *   **Testing & Debugging Phase (1/21/2026, 12:52:00 PM - 1/21/2026, 4:29:42 PM)**:
        *   The primary date range filter was commented out and replaced with hardcoded `DIM_CONTRACT.CONTRACT_NUMBER` filters (e.g., `'645-110814'`, then `'110814'`), indicating focused testing on specific contract data.
        *   The calculation of `Purchase_Price` was adjusted from `COALESCE(cnp.net_price, pc.TOTAL_CASH_PRICE, 0)` to `COALESCE(cnp.net_price, 0)`.
        *   The `cancelled_contract_fee_tax` CTE and its reference in `contract_tax_totals` were repeatedly commented out or removed, suggesting this functionality is either under review, incomplete, or temporarily disabled.
        *   The sourcing of tax amounts in `contract_fee_tax` and `deed_fee_tax` CTEs changed from `f.TAX_AMOUNT` to `cf.TAX_AMOUNT` or `df.TAX_AMOUNT`, indicating a shift in the data source for tax calculation.
        *   An attempt was made to explicitly cast `CONTRACT_ID` to `INT` in `IN` clauses (e.g., `CAST(SELECT CONTRACT_ID FROM base_contracts AS INT)`), which was then partially reverted due to syntax errors or perceived unnecessity.
        *   A minor case sensitivity fix for the `LOWER(f.FEE_TYPE) != 'Interest'` condition was applied.
    *   **Restoration (1/21/2026, 4:31:12 PM)**: The hardcoded contract number filter was commented out, and the original dynamic date range filter was re-enabled, suggesting the testing phase for specific contract numbers concluded.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (1/21/2026, 12:54:56 PM)**: This file introduces a new service responsible for syncing PlotBox data to HubSpot.
    *   It defines a `syncPlotBoxData` method to retrieve data, map it, and then process batches of primary contacts, deceased contacts, and deals, including associating them with HubSpot locations.
    *   The presence of `dd($dealsBatch);` (dump and die) indicates this file was actively being developed and debugged at this timestamp.
    *   The `processContacts` method utilizes individual `try-catch` blocks for CRM operations and includes `sleep()` calls (e.g., `sleep(10)`, `sleep(5)`) to manage API rate limits or ensure sequential processing in HubSpot.

**Timestamps of Significant Changes:**

*   **1/21/2026, 12:52:00 PM**: Introduction of hardcoded `CONTRACT_NUMBER` for testing in `Contact.php`.
*   **1/21/2026, 12:54:56 PM**: First appearance and active development/debugging (`dd`) of `PlotBoxHubSpotService.php`.
*   **1/21/2026, 3:57:10 PM**: Commenting out of `cancelled_contract_fee_tax` CTE in `Contact.php`.
*   **1/21/2026, 4:05:53 PM**: Change in tax amount sourcing logic in `Contact.php`'s SQL query.
*   **1/21/2026, 4:20:08 PM**: Attempt to add explicit `CAST` for `CONTRACT_ID` in `IN` clauses in `Contact.php`.
*   **1/21/2026, 4:31:12 PM**: Reversion in `Contact.php` to dynamic date range filtering and removal of the hardcoded contract number filter.

**Patterns and Recurring Elements:**

*   **SQL Query Iteration:** The `Contact.php` file shows a strong pattern of iterative refinement and debugging of a large, complex SQL query. This includes commenting out sections, adding temporary filters, and adjusting calculation logic.
*   **Debugging Practices:** The use of hardcoded filters in SQL and `dd()` statements in PHP clearly indicates an active development and debugging environment.
*   **Modular CRM Integration:** The new `PlotBoxHubSpotService.php` demonstrates a structured approach to integrating with a CRM, handling different entity types (contacts, deals) and their associations, with an emphasis on error handling and rate limiting.
*   **Consistency in Database Schema References:** Both files consistently reference tables within `PLOTBOX_WAREHOUSE.WAREHOUSE_EVERSTORYPARTNERS` (e.g., `DIM_CONTRACT`, `DIM_CONTACT`, `DIM_CONTRACT_OWNER`, `DIM_FEE`, `DIM_CONTRACT_ITEM`, `DIM_PAYMENT_SCHEDULE`, `DIM_SYSTEM_USER`, `DIM_FACILITY`), indicating a well-defined data warehousing structure.
*   **Object-Oriented Design:** The use of Eloquent models and dedicated service classes (e.g., `PlotBoxHubSpotService`, `HubSpotContactService`, `HubSpotDealService`, `HubSpotLocationService`) points to an object-oriented design approach.

## 1:15:22 PM
The changes log details modifications across two primary files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`.

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
    *   **Initial State (1/21/2026, 12:51:05 PM):** This file, representing an Eloquent model for PlotBox contacts, contains a comprehensive Snowflake SQL query within its `getDataWithDateRange` method. This query is designed to extract detailed contract, contact, and item information, including various tax calculations (contract, deed, and cancelled contract fees) and categorizations of owned items (caskets, cremations, etc.), filtered by a date range.
    *   **SQL Query Modification & Debugging (1/21/2026, 12:52:00 PM - 4:29:42 PM):**
        *   The original date-range filter for `base_contracts` was repeatedly commented out and replaced with a hardcoded `DIM_CONTRACT.CONTRACT_NUMBER` (initially `'645-110814'`, then `'110814'`). This pattern suggests active debugging or testing on specific contract data.
        *   The `cancelled_contract_fee_tax` CTE and its inclusion in the `contract_tax_totals` were entirely commented out during this period (starting 1/21/2026, 3:57:10 PM).
        *   Minor corrections were made to the calculation of `contract_fee_tax_total` and `deed_fee_tax_total`, specifically adjusting the source of the `TAX_AMOUNT` column in the `SUM` function (e.g., from `f.TAX_AMOUNT` to `cf.TAX_AMOUNT` or `df.TAX_AMOUNT`) and a casing change for the 'interest' fee type.
        *   There were brief attempts to explicitly cast `CONTRACT_ID` to `INT` in subqueries, followed by a reversion to the simpler, implicit subquery syntax to resolve potential errors.
    *   **Functionality Restoration & Cleanup (1/21/2026, 4:31:12 PM - 1/22/2026, 11:24:20 AM):**
        *   The hardcoded contract number filter was commented out, and the original date-range filtering logic was restored in `base_contracts` (1/21/2026, 4:31:12 PM).
        *   The `cancelled_contract_fee_tax` CTE and its related join and `COALESCE` in `contract_tax_totals` were definitively removed, not just commented out (1/22/2026, 11:24:20 AM).
        *   The full SQL `SELECT` statement, which was truncated in previous log entries, was shown as complete, confirming all necessary joins and output columns.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**
    *   **Debugging `dealsBatch` (1/21/2026, 12:54:56 PM - 1/22/2026, 11:25:42 AM):** The most prominent change in this service file, responsible for syncing PlotBox data to HubSpot, was the repeated insertion and removal of a `dd($dealsBatch);` debugging statement. This indicates a focused debugging effort on the `dealsBatch` data at different points in time.
    *   The core logic of the `syncPlotBoxData` and `processContacts` methods, which handle data retrieval, mapping, contact/deal creation/update, and associations with locations, remained consistent throughout the logged changes, emphasizing robust error handling and logging.

**Timestamps of Significant Changes:**

*   **1/21/2026, 12:52:00 PM:** Initial SQL filter change for debugging in `Contact.php`.
*   **1/21/2026, 12:54:56 PM:** Debugging `dd($dealsBatch);` first appears in `PlotBoxHubSpotService.php`.
*   **1/21/2026, 3:57:10 PM:** `cancelled_contract_fee_tax` CTE commented out in `Contact.php`.
*   **1/21/2026, 4:05:53 PM & 4:16:07 PM:** Tax calculation adjustments and corrections in `Contact.php`.
*   **1/21/2026, 4:31:12 PM:** Restoration of original date filter in `Contact.php`.
*   **1/22/2026, 11:19:31 AM:** `dd($dealsBatch);` removed from `PlotBoxHubSpotService.php`.
*   **1/22/2026, 11:24:20 AM:** Final cleanup of `cancelled_contract_fee_tax` and full SQL query visible in `Contact.php`.
*   **1/22/2026, 11:24:34 AM:** `dd($dealsBatch);` re-introduced in `PlotBoxHubSpotService.php`.

**Patterns or Recurring Elements in the Content:**

*   **Iterative Debugging:** A clear pattern of iterative debugging is evident, particularly with the SQL query in `Contact.php` (commenting/uncommenting filters) and the `dd()` statement in `PlotBoxHubSpotService.php`.
*   **SQL Query Refinement:** The `Contact.php` file shows continuous refinement of a complex SQL query, including structural changes (commenting/removing CTEs), value corrections, and syntax adjustments.
*   **Focus on Data Integration:** Both files are integral to a data integration pipeline from PlotBox to HubSpot, indicating ongoing development and maintenance for CRM synchronization.
*   **Error Handling and Logging:** Both files demonstrate consistent use of `try-catch` blocks and `Log::error` statements for robust error handling, especially in the HubSpot service.