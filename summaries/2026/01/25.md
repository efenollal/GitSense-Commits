# Activity Summary for 1/25/2026

## 12:24:20 AM
The changes primarily focus on two files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`.

### File-specific Updates:

**`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`** (Multiple timestamps: 1/21/2026, 12:51:05 PM to 1/22/2026, 2:29:50 PM)

The modifications in this file are concentrated within the `getDataWithDateRange` static method, which queries data from a Snowflake database. The changes involve various adjustments and commented-out sections in the SQL query, primarily related to contract tax calculations and filtering.

*   **1/21/2026, 12:51:05 PM**: Initial state, the `base_contracts` CTE included a date range filter `(CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN '{$fromDate}' AND '{$toDate}' OR EXISTS (...) )`. The `contract_tax_totals` CTE explicitly summed `contract_fee_tax_total`, `deed_fee_tax_total`, and `cancelled_fee_tax_total`.
*   **1/21/2026, 12:52:00 PM - 1/21/2026, 1:37:28 PM**: The date range filter in the `base_contracts` CTE was commented out and replaced with a hardcoded `WHERE DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'`. The trailing part of the `SELECT` statement in the main query was truncated.
*   **1/21/2026, 12:54:01 PM**: A minor change to `COALESCE(cnp.net_price, pc.TOTAL_CASH_PRICE, 0)` which became `COALESCE(cnp.net_price, 0)`. The `TOTAL_CASH_PRICE` fallback was removed from the `net_price` calculation in the main SELECT clause.
*   **1/21/2026, 3:57:10 PM**: The `cancelled_contract_fee_tax` CTE was entirely commented out. Consequently, the `contract_tax_totals` CTE was also modified to remove its reference (`// LEFT JOIN cancelled_contract_fee_tax ccft ON bc.CONTRACT_ID = ccft.CONTRACT_ID`).
*   **1/21/2026, 4:05:53 PM**: The `SUM` calculations in `contract_fee_tax` and `deed_fee_tax` CTEs were changed. Specifically, `SUM(f.TAX_AMOUNT * cf.QUANTITY)` became `SUM(cf.TAX_AMOUNT * cf.QUANTITY)` (likely a typo correction or schema change where `TAX_AMOUNT` moved from `f` to `cf`). The `cancelled_contract_fee_tax` CTE (still commented out) also had a similar `ccf.TAX_AMOUNT` adjustment.
*   **1/21/2026, 4:16:07 PM**: A minor correction in the `contract_fee_tax` CTE, changing `LOWER(f.FEE_TYPE) != 'interest'` to `LOWER(f.FEE_TYPE) != 'Interest'`. Also, `SUM(df.TAX_AMOUNT * df.QUANTITY)` (typo `cf.TAX_AMOUNT` corrected to `df.TAX_AMOUNT`) was updated in `deed_fee_tax`. The commented `cancelled_contract_fee_tax` also saw `ccf.TAX_AMOUNT` change.
*   **1/21/2026, 4:20:08 PM - 1/21/2026, 4:20:28 PM**: Casts to `INT` were added to subqueries for `CONTRACT_ID` in `contract_fee_tax`, `deed_fee_tax`, and the commented `cancelled_contract_fee_tax` CTEs: `WHERE cf.CONTRACT_ID IN (CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))`. The hardcoded contract number filter in `base_contracts` was changed from `'645-110814'` to `'110814'`.
*   **1/21/2026, 4:23:56 PM**: Some syntax issues in the `CAST` statements for `CONTRACT_ID` subqueries in `contract_fee_tax` and `deed_fee_tax` were introduced, with `IN (SELECT CONTRACT_ID FROM base_contracts AS INT)` missing parentheses around the subquery.
*   **1/21/2026, 4:26:14 PM**: The incorrect `CAST` syntax was fixed by removing the `AS INT` part directly after the subquery: `WHERE cf.CONTRACT_ID IN (SELECT CONTRACT_ID FROM base_contracts)`.
*   **1/21/2026, 4:26:47 PM - 1/21/2026, 4:27:14 PM**: In the `contract_tax_totals` CTE, the `COALESCE(ccft.cancelled_fee_tax_total, 0)` part was moved to a comment and removed from the sum, even though the `cancelled_contract_fee_tax` CTE itself was already commented out. This seems like further cleanup.
*   **1/21/2026, 4:27:46 PM - 1/21/2026, 4:31:12 PM**: A significant change: the hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '110814'` filter in `base_contracts` was commented out, and the original date range filter `(CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN '{$fromDate}' AND '{$toDate}' OR EXISTS (...) )` was restored. This suggests a shift back to dynamic date-based filtering.
*   **1/22/2026, 11:24:20 AM**: The `cancelled_contract_fee_tax` CTE and its reference in `contract_tax_totals` were fully removed (no longer just commented out). The main `SELECT` statement in `getDataWithDateRange` was completed, re-adding the omitted `item_counts` and `facility` joins and the final `SELECT` fields.
*   **1/22/2026, 11:24:43 AM - 1/22/2026, 2:29:50 PM**: No substantial code changes were observed, mostly re-runs of the same code or minor whitespace differences/truncations in the provided logs.

**`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`** (Multiple timestamps: 1/21/2026, 12:54:56 PM to 1/22/2026, 11:25:42 AM)

Changes in this file indicate debugging or testing efforts within the `syncPlotBoxData` method.

*   **1/21/2026, 12:54:56 PM**: A `dd($dealsBatch);` statement was added after populating the `primaryContactBatch`, `deceasedContactBatch`, and `dealsBatch` arrays. This is a Laravel debug helper that dumps the variable and stops script execution.
*   **1/22/2026, 11:19:31 AM**: The `dd($dealsBatch);` line was removed, allowing the `processContacts` method to be called. This suggests the debugging for `dealsBatch` was completed.
*   **1/22/2026, 11:24:34 AM - 1/22/2026, 11:25:42 AM**: The `dd($dealsBatch);` line was re-introduced. This indicates a re-run of debugging for the `dealsBatch` array, possibly after other changes or to re-verify its contents.

### Patterns and Recurring Elements:

*   **Debugging with `dd()`**: The repeated addition and removal of `dd($dealsBatch);` in `PlotBoxHubSpotService.php` indicates active debugging around the data mapping and batch preparation before processing contacts and deals.
*   **SQL Query Iteration**: The `Contact.php` file shows extensive iteration on a complex SQL query. This includes:
    *   **Comment/Uncomment**: Frequent commenting and uncommenting of a specific contract number filter and the original date range filter in `base_contracts`. This suggests switching between testing specific cases and the general functionality.
    *   **CTE Modifications**: Regular changes to CTEs (Common Table Expressions) like `cancelled_contract_fee_tax` (commented out/removed) and `contract_tax_totals` (adjusted to reflect the former's status).
    *   **Typo Corrections/Schema Adaptations**: Adjustments like `f.TAX_AMOUNT` to `cf.TAX_AMOUNT` and `df.TAX_AMOUNT` suggest adapting the SQL to correct column references or changes in the underlying database schema.
    *   **Data Type Casting**: Attempted (and corrected) explicit casting of `CONTRACT_ID` to `INT` in subqueries (`CAST(SELECT CONTRACT_ID FROM base_contracts AS INT)`).
*   **Focus on `getDataWithDateRange`**: All changes in `Contact.php` are confined to this single static method, indicating a dedicated effort to refine its data retrieval logic.
*   **Timestamp Proximity**: Many changes within `Contact.php` occur within very short timeframes (e.g., seconds to minutes), suggesting rapid experimentation and small iterative fixes.