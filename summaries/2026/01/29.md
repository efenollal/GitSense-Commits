# Activity Summary for 1/29/2026

## 8:58:58 AM
The changes primarily focus on two files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`.

**File-specific updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` (multiple timestamps between 1/21/2026, 12:51:05 PM and 1/22/2026, 2:29:50 PM):**
    *   This file, a Laravel Eloquent model named `Contact` for the `PlotBox` namespace, is responsible for retrieving contact and contract data from a Snowflake warehouse (`PLOTBOX_WAREHOUSE.WAREHOUSE_EVERSTORYPARTNERS.DIM_CONTACT`).
    *   The core changes revolve around the `getDataWithDateRange` static method, which executes a complex SQL query.
    *   **Initial Change (1/21/2026, 12:52:00 PM):** A significant modification was made to the `WHERE` clause of the `base_contracts` CTE (Common Table Expression). The original date range filtering `(CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN '{$fromDate}' AND '{$toDate}' OR EXISTS (...))` was commented out and replaced with a hardcoded filter `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'`. This suggests a debugging or specific contract testing scenario.
    *   **Subsequent Changes (1/21/2026, 12:54:01 PM to 1/21/2026, 4:20:08 PM):** The hardcoded `CONTRACT_NUMBER` filter in `base_contracts` was slightly modified from `'645-110814'` to `'110814'`. Additionally, `CAST(... AS INT)` was added around `(SELECT CONTRACT_ID FROM base_contracts)` in the `WHERE` clauses for `contract_fee_tax`, `deed_fee_tax`, and `cancelled_contract_fee_tax` CTEs.
    *   **Further Refinements (1/21/2026, 4:23:56 PM to 1/21/2026, 4:29:42 PM):** The `CAST(... AS INT)` was removed from the `WHERE` clauses of `contract_fee_tax` and `deed_fee_tax`, reverting to `(SELECT CONTRACT_ID FROM base_contracts)`. The `cancelled_contract_fee_tax` CTE block, including its `LEFT JOIN` in `contract_tax_totals` and its contribution to `total_tax`, was consistently commented out and then re-commented out, indicating its removal or temporary deactivation from the tax calculation logic.
    *   **Final Reversion (1/21/2026, 4:31:12 PM to 1/22/2026, 2:29:50 PM):** The hardcoded `DIM_CONTRACT.CONTRACT_NUMBER` filter was commented out, effectively reactivating the original date range and `EXISTS` subquery logic for `LAST_UPDATED_DATE_TIME_UTC` and `LAST_UPDATED_DATETIME` in the `base_contracts` CTE. The `cancelled_contract_fee_tax` CTE remained commented out, and the reference to `ccft.cancelled_fee_tax_total` in `contract_tax_totals` was also removed from the `total_tax` calculation.
    *   **Additional join in the final `SELECT` (1/22/2026, 11:24:20 AM):** The final version of the query introduces three `LEFT JOIN` statements to bring in data from `deceased_contacts`, `contract_writers`, and `item_counts` into the main `SELECT` statement, based on `CONTRACT_ID` and `CREATED_BY` (for deceased contacts) or `rn` (for contract writers and deceased contacts) for proper aggregation and display.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (1/21/2026, 12:54:56 PM and 1/22/2026, 11:19:31 AM, 1/22/2026, 11:24:34 AM, 1/22/2026, 11:25:42 AM):**
    *   This file is a service responsible for syncing PlotBox data to HubSpot.
    *   **Initial state (1/21/2026, 12:54:56 PM):** The `syncPlotBoxData` method included a `dd($dealsBatch);` statement (a Laravel debug helper that dumps and dies) directly after populating the batch arrays, preventing the rest of the sync logic from executing.
    *   **Key change (1/22/2026, 11:19:31 AM):** The `dd($dealsBatch);` line was removed from the `syncPlotBoxData` method, allowing the full contact, deal, and location association processing (`$this->processContacts(...)`) to proceed.
    *   **Reversion (1/22/2026, 11:24:34 AM):** The `dd($dealsBatch);` line was reintroduced.
    *   **Final state (1/22/2026, 11:25:42 AM):** The `dd($dealsBatch);` line remains in the code, indicating that the full sync process is still being short-circuited for debugging purposes.

**Timestamps of significant changes:**

*   **1/21/2026, 12:52:00 PM:** Introduction of a hardcoded contract number filter in `Contact.php`, temporarily disabling date range filtering.
*   **1/21/2026, 4:31:12 PM:** Reversion of the `Contact.php` SQL query to enable date range filtering again, by commenting out the hardcoded contract number.
*   **1/22/2026, 11:19:31 AM:** Removal of a `dd()` debug statement in `PlotBoxHubSpotService.php`, allowing the sync process to complete.
*   **1/22/2026, 11:24:34 AM:** Reintroduction of the `dd()` debug statement in `PlotBoxHubSpotService.php`.
*   **1/22/2026, 11:24:20 AM:** Addition of crucial `LEFT JOIN` clauses in the final `SELECT` of `Contact.php` to include `item_counts`, `contract_writers`, and `deceased_contacts` in the output.

**Patterns or recurring elements:**

*   **SQL Query Iteration:** The `Contact.php` file shows frequent modifications to a complex SQL query within the `getDataWithDateRange` method. This includes commenting/uncommenting specific filters (like date ranges vs. `CONTRACT_NUMBER`), adding/removing `CAST` operations, and commenting out entire CTEs (like `cancelled_contract_fee_tax`). This indicates an iterative development and debugging process for refining the data retrieval logic.
*   **Debugging with `dd()`:** The `PlotBoxHubSpotService.php` shows a pattern of adding and removing `dd($dealsBatch);` for debugging, which pauses execution and inspects the `$dealsBatch` variable. This suggests active debugging of the HubSpot synchronization logic.
*   **Focus on PlotBox Integration:** Both files are clearly part of an application integrating with "PlotBox" data, implying a system that processes and potentially syncs cemetery/funeral home management data to a CRM like HubSpot. The `PlotBoxDataTransferObject` and `PlotBoxDataToCrmMapper` also reinforce this.
*   **Snowflake Database:** The constant `const CONNECTION = 'snowflake';` and table names like `PLOTBOX_WAREHOUSE.WAREHOUSE_EVERSTORYPARTNERS.DIM_CONTACT` consistently indicate the use of Snowflake as the primary data source.
*   **Contract-related Data:** A significant portion of the SQL query in `Contact.php` focuses on retrieving detailed contract information, including owners, payment schedules, fees, and various types of purchased items (caskets, cremation products, ground, markers, etc.).

## 9:59:06 AM
The changes primarily affect two PHP files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`. The timestamps indicate that all changes occurred on January 21st and 22nd, 2026, primarily during the afternoon/evening hours, suggesting active development or debugging sessions.

### File-Specific Updates:

**1. `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` (Multiple timestamps from 1/21/2026 12:51:05 PM to 1/22/2026 2:29:50 PM):**

*   **Initial State (1/21/2026, 12:51:05 PM):** The `getDataWithDateRange` method in the `Contact` model included a SQL query with a `WHERE` clause that filtered contracts based on `LAST_UPDATED_DATE_TIME_UTC` or `DIM_CONTACT.LAST_UPDATED_DATETIME` within a given `{$fromDate}` and `{$toDate}`. It also included a `cancelled_contract_fee_tax` CTE and included its sum in `contract_tax_totals`.
*   **Debug/Testing Phase (1/21/2026, 12:52:00 PM - 1/21/2026, 1:37:28 PM):** The date range filtering in the `base_contracts` CTE's `WHERE` clause was commented out. A hardcoded filter `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` was introduced, likely for testing a specific contract.
*   **Continued Debug/Refinement (1/21/2026, 3:57:10 PM - 1/21/2026, 4:29:42 PM):**
    *   The `cancelled_contract_fee_tax` CTE was commented out. Consequently, the `contract_tax_totals` CTE was also modified to remove the `COALESCE(ccft.cancelled_fee_tax_total, 0)` part, indicating that cancelled contract fees are no longer being included in the total tax calculation.
    *   Further changes in this timeframe involved modifications to the `WHERE cf.CONTRACT_ID IN (SELECT CONTRACT_ID FROM base_contracts)` clauses within `contract_fee_tax` and `deed_fee_tax` CTEs. Initially, `CAST(SELECT CONTRACT_ID FROM base_contracts AS INT)` was added (1/21/2026, 4:20:08 PM), then removed (1/21/2026, 4:26:14 PM). This indicates experimentation with explicit type casting for subqueries, which was later reverted.
    *   The hardcoded contract number filter in `base_contracts` was changed from `'645-110814'` to `'110814'` (1/21/2026, 4:20:13 PM).
    *   A significant change occurred where the `total_tax` calculation in `contract_tax_totals` was explicitly simplified by commenting out the `COALESCE(ccft.cancelled_fee_tax_total, 0)` part entirely, leaving only `COALESCE(cft.contract_fee_tax_total, 0) + COALESCE(dft.deed_fee_tax_total, 0)` as the sum (1/21/2026, 4:29:42 PM). This implies a decision to exclude cancelled contract fees from total tax.
*   **Reversion to Original Logic (1/22/2026, 11:24:20 AM - 1/22/2026, 2:29:50 PM):**
    *   The hardcoded `DIM_CONTRACT.CONTRACT_NUMBER` filter was commented out again.
    *   The original date range filtering logic in the `base_contracts` CTE's `WHERE` clause was uncommented, restoring the filtering by `LAST_UPDATED_DATE_TIME_UTC` for contracts and `LAST_UPDATED_DATETIME` for contacts associated with contracts.
    *   The `cancelled_contract_fee_tax` CTE remains commented out, and its exclusion from `contract_tax_totals` is maintained.

**2. `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (Timestamps: 1/21/2026, 12:54:56 PM and 1/22/2026, 11:19:31 AM, 1/22/2026, 11:25:42 AM):**

*   **Initial Addition of `dd($dealsBatch)` (1/21/2026, 12:54:56 PM):** A `dd($dealsBatch)` statement (Laravel's "dump and die" for debugging) was added within the `syncPlotBoxData` method, right before the `processContacts` call. This indicates an immediate need to inspect the contents of `$dealsBatch` during the data synchronization process.
*   **Removal of `dd($dealsBatch)` (1/22/2026, 11:19:31 AM):** The `dd($dealsBatch)` statement was removed, suggesting the immediate debugging step was resolved or no longer needed.
*   **Re-introduction of `dd($dealsBatch)` (1/22/2026, 11:25:42 AM):** The `dd($dealsBatch)` statement was added back in, indicating that the developer needed to re-examine the `$dealsBatch` content for further debugging or verification, possibly after other changes.

### Patterns and Recurring Elements:

*   **Debugging via Commenting/Uncommenting and `dd()`:** There's a clear pattern of using commenting/uncommenting of SQL `WHERE` clauses (specifically date filters and `cancelled_contract_fee_tax` CTE) and the `dd($dealsBatch)` function to debug and test the `getDataWithDateRange` method's SQL query and the subsequent data processing. This suggests an iterative, trial-and-error approach to development or problem-solving.
*   **Focus on Contract Data Retrieval:** All changes in `Contact.php` revolve around refining the `getDataWithDateRange` SQL query, indicating a critical need to accurately retrieve and calculate contract-related financial data (taxes, net price) and contact information from the Snowflake warehouse.
*   **HubSpot Integration Troubleshooting:** The changes in `PlotBoxHubSpotService.php` directly relate to ensuring the correct data is being prepared and mapped for synchronization with HubSpot, specifically focusing on the `dealsBatch`. The repeated addition and removal of `dd($dealsBatch)` highlight debugging efforts related to the deal data before it's sent to HubSpot.
*   **Temporary Hardcoding for Testing:** The temporary hardcoding of `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` and then `'110814'` in `Contact.php` is a common debugging practice to isolate and test specific data points rather than processing a full date range.
*   **Consistency in Model Structure:** Despite the extensive SQL query modifications, the core Eloquent model structure (`$table`, `$primaryKey`, `$fillable`, relationships) in `Contact.php` remains unchanged throughout the log, indicating that the structural definition of the `Contact` model itself was stable.
*   **Snowflake Database Interaction:** The constant `const CONNECTION = 'snowflake';` and the repeated `DB::connection(self::CONNECTION)->select(...)` confirm that the application is consistently interacting with a Snowflake database for its data warehousing needs.
*   **Exclusion of Cancelled Contract Fees:** The repeated commenting out of the `cancelled_contract_fee_tax` CTE and its removal from the `contract_tax_totals` calculation suggests a deliberate decision to exclude these types of fees from the `total_tax` and `net_price` calculations, likely based on business logic or data reporting requirements.

## 10:59:12 AM
The provided log details changes across two files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`.

### File-Specific Updates:

**1. `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**

This file, which defines an Eloquent model for `Contact` and includes a `getDataWithDateRange` static method to query PlotBox warehouse data, saw numerous changes throughout January 21-22, 2026. The modifications were primarily focused on refining the SQL query within the `getDataWithDateRange` method.

*   **1/21/2026, 12:51:05 PM (Initial State):** The query included a date range filter in the `base_contracts` CTE, checking `LAST_UPDATED_DATE_TIME_UTC` for `DIM_CONTRACT` or `LAST_UPDATED_DATETIME` for `DIM_CONTACT` (through `DIM_CONTRACT_OWNER`). It also defined CTEs for `payment_schedule_totals`, `contract_fee_tax`, `deed_fee_tax`, `cancelled_contract_fee_tax`, `contract_tax_totals`, `contract_net_prices`, `contract_writers`, `item_counts`, `primary_contacts`, and `deceased_contacts` to gather comprehensive contract and contact information, including various owned items (caskets, cremation products, ground, etc.).

*   **1/21/2026, 12:52:00 PM - 1/21/2026, 1:37:28 PM:** The primary filter in the `base_contracts` CTE was commented out and replaced with a hardcoded `WHERE DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'`. This suggests a debugging phase, focusing on a specific contract. The `COALESCE` for `Purchase_Price` in the final `SELECT` statement still included `pc.TOTAL_CASH_PRICE`.

*   **1/21/2026, 12:54:01 PM:** A minor change at the end of the file in the `SELECT` statement, removing `COALESCE(ic.other_services_owned, 0)` from the partial line. This appears to be a truncation.

*   **1/21/2026, 3:57:10 PM:** The `cancelled_contract_fee_tax` CTE and its inclusion in `contract_tax_totals` were commented out. This indicates a decision to temporarily or permanently exclude cancelled contract fee tax calculations from the total tax.

*   **1/21/2026, 4:05:53 PM:** Small corrections were made in the `contract_fee_tax` and `deed_fee_tax` CTEs where `f.TAX_AMOUNT` was changed to `cf.TAX_AMOUNT` and `df.TAX_AMOUNT` respectively. The initial values for `contract_fee_tax_total` and `deed_fee_tax_total` within `COALESCE` now correctly reference `cf.TAX_AMOUNT` and `df.TAX_AMOUNT`.

*   **1/21/2026, 4:16:07 PM:** The literal string 'interest' in the `contract_fee_tax` CTE was changed to 'Interest' (capitalized 'I') in the `LOWER(f.FEE_TYPE) != 'Interest'` condition.

*   **1/21/2026, 4:20:08 PM:** Type casting `(CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))` was introduced in the `WHERE cf.CONTRACT_ID IN (...)` and `WHERE df.CONTRACT_ID IN (...)` clauses for `contract_fee_tax` and `deed_fee_tax` CTEs, and similarly for the commented `cancelled_contract_fee_tax` CTE. The hardcoded contract number was changed from `'645-110814'` to `'110814'`.

*   **1/21/2026, 4:20:13 PM:** The `contract_number` filter in `base_contracts` was simplified from `'645-110814'` to `'110814'`.

*   **1/21/2026, 4:23:56 PM:** The type casting `(CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))` in `contract_fee_tax`, `deed_fee_tax`, and `cancelled_contract_fee_tax` CTEs was syntactically corrected (removed `AS INT` from inside the subquery's `SELECT`). It now appears as `(SELECT CONTRACT_ID FROM base_contracts)` with an external `CAST` where relevant. There's also a syntactical error in `deed_fee_tax` where `IN (SELECT CONTRACT_ID FROM base_contracts AS INT)` is missing a parenthesis before `SELECT`.

*   **1/21/2026, 4:26:14 PM:** The incorrect `CAST` syntax `(SELECT CONTRACT_ID FROM base_contracts AS INT)` in the `contract_fee_tax` and `deed_fee_tax` CTEs was corrected to `(SELECT CONTRACT_ID FROM base_contracts)`. The commented `cancelled_contract_fee_tax` CTE also reflects this correction.

*   **1/21/2026, 4:26:47 PM:** A bug was introduced in the `contract_tax_totals` CTE: `COALESCE(cft.cancelled_fee_tax_total, 0)` was added back to the sum, but the `cancelled_contract_fee_tax` CTE itself was still commented out. This would lead to an undefined `ccft` alias.

*   **1/21/2026, 4:27:14 PM:** The `COALESCE(ccft.cancelled_fee_tax_total, 0)` from `contract_tax_totals` was commented out again, fixing the previous bug.

*   **1/21/2026, 4:27:46 PM:** The `COALESCE(ccft.cancelled_fee_tax_total, 0)` was again commented out of `contract_tax_totals`.

*   **1/21/2026, 4:31:12 PM:** The hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '110814'` filter in `base_contracts` was commented out, restoring the original date range filter for `LAST_UPDATED_DATE_TIME_UTC` and `LAST_UPDATED_DATETIME` in `DIM_CONTACT` via `DIM_CONTRACT_OWNER`.

*   **1/21/2026, 4:32:48 PM:** No functional change was observed, appears to be a save or formatting change.

*   **1/22/2026, 11:24:20 AM:** The `cancelled_contract_fee_tax` CTE was fully removed (uncommented lines are gone), and consequently, its reference in `contract_tax_totals` was also removed. The final `SELECT` statement was extended to include all `item_counts` properties. Also, several `LEFT JOIN` clauses were added at the very end of the main `SELECT` statement, specifically joining `deceased_contacts`, `contract_writers`, `item_counts`, and `DIM_FACILITY` (`df`). These joins were previously implicit or handled differently.

*   **1/22/2026, 11:24:43 AM - 1/22/2026, 2:29:50 PM:** No functional changes in the displayed log excerpt for these timestamps; appears to be further minor saves or formatting adjustments. The last entry for this file `1/22/2026, 2:29:50 PM` is identical to `1/22/2026, 11:24:20 AM` from the snippet provided, including the extended `SELECT` and `JOIN` clauses.

**2. `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**

This file is responsible for syncing PlotBox data to HubSpot, handling contacts, deals, and associations.

*   **1/21/2026, 12:54:56 PM (Initial State):** The `syncPlotBoxData` method, after preparing `primaryContactBatch`, `deceasedContactBatch`, `dealsBatch`, and `locationAssociations`, included a `dd($dealsBatch);` statement. This `dd()` (dump and die) function is typically used for debugging and would halt script execution.

*   **1/22/2026, 11:19:31 AM:** The `dd($dealsBatch);` statement was removed from the `syncPlotBoxData` method. This indicates the debugging step was completed and the script is now intended to run its full synchronization logic.

*   **1/22/2026, 11:24:34 AM - 1/22/2026, 11:25:42 AM:** The `dd($dealsBatch);` statement was re-introduced. This suggests a re-entry into a debugging phase for the deal batch, or perhaps testing different scenarios where early termination is desired. The later entry `11:25:42 AM` is identical to `11:24:34 AM`, indicating no further change in the shown snippet for that time.

### Timestamps of Significant Changes:

*   **1/21/2026, 12:52:00 PM:** Start of SQL query modification in `Contact.php` for debugging (hardcoded contract number).
*   **1/21/2026, 3:57:10 PM:** Exclusion of `cancelled_contract_fee_tax` from calculation in `Contact.php`.
*   **1/21/2026, 4:05:53 PM:** Correction of `TAX_AMOUNT` source in `contract_fee_tax` and `deed_fee_tax` CTEs in `Contact.php`.
*   **1/21/2026, 4:20:08 PM:** Introduction of `CAST` attempts for `CONTRACT_ID` in `IN` clauses within `Contact.php`.
*   **1/21/2026, 4:31:12 PM:** Restoration of the original date range filter in `Contact.php`, ending the contract-specific debugging.
*   **1/22/2026, 11:19:31 AM:** Removal of `dd($dealsBatch);` in `PlotBoxHubSpotService.php`, indicating progression beyond initial debugging.
*   **1/22/2026, 11:24:20 AM:** Major structural changes to the SQL query in `Contact.php`: complete removal of `cancelled_contract_fee_tax` CTE and explicit `JOIN` clauses added in the final `SELECT`.
*   **1/22/2026, 11:24:34 AM:** Re-introduction of `dd($dealsBatch);` in `PlotBoxHubSpotService.php`, suggesting renewed debugging focus.

### Patterns or Recurring Elements:

*   **Debugging Focus:** A clear pattern of debugging is evident in both files. In `Contact.php`, the original date-range filter was replaced with a hardcoded `CONTRACT_NUMBER` filter, and then restored, indicating localized testing of the SQL query. In `PlotBoxHubSpotService.php`, the `dd($dealsBatch);` statement was added, removed, and then re-added, strongly suggesting iterative debugging of the deal batch processing.
*   **SQL Query Refinement:** The `Contact.php` file undergoes continuous refinement of its complex SQL query, particularly concerning tax calculations (commenting out `cancelled_contract_fee_tax`), data type handling (`CAST` attempts), and ultimately, the final structure of the `SELECT` statement with explicit joins.
*   **Consistency in Model Structure:** The basic Eloquent model structure (`CONNECTION`, `table`, `primaryKey`, `timestamps`, `fillable`, relationships) in `Contact.php` remains consistent across all changes, highlighting that the modifications are internal to the `getDataWithDateRange` method's SQL logic.
*   **HubSpot Service Workflow:** The `PlotBoxHubSpotService.php` consistently follows a workflow of fetching data, mapping it, batching contacts and deals, and then processing them (search, create/update, associate). Error logging and structured return values are also consistent.
*   **Repetitive `COALESCE` and `SUM(CASE WHEN LOWER(fc.FEE_CATEGORY_NAME) LIKE '%...' THEN ... ELSE 0 END)` patterns** are heavily used within the SQL query in `Contact.php` for calculating item counts based on fee categories, indicating a standardized way of categorizing and summing different types of owned items.

## 12:59:09 PM
The provided log details changes across two PHP files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`.

### File-Specific Updates:

**1. `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` (Multiple timestamps from 1/21/2026 to 1/22/2026)**

This file, representing an Eloquent Model for `Contact` within the `PlotBox` namespace, primarily deals with fetching complex contract and contact data from a Snowflake database (`PLOTBOX_WAREHOUSE.WAREHOUSE_EVERSTORYPARTNERS`). The `getDataWithDateRange` static method contains a large SQL query built using CTEs (Common Table Expressions).

The key changes observed in this file are predominantly within the `getDataWithDateRange` method's SQL query:

*   **1/21/2026, 12:52:00 PM**: A specific filter `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` was added to the `base_contracts` CTE. The original date range filter (`CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN '{$fromDate}' AND '{$toDate}' ...`) was commented out, indicating a switch to test/debug a specific contract.
*   **1/21/2026, 12:54:01 PM**: No functional change visible in the provided diff.
*   **1/21/2026, 3:57:10 PM**: The `cancelled_contract_fee_tax` CTE was entirely commented out. Consequently, the reference to `ccft.cancelled_fee_tax_total` was also commented out in the `contract_tax_totals` CTE.
*   **1/21/2026, 4:05:53 PM**: In `contract_fee_tax` and `deed_fee_tax` CTEs, the calculation `SUM(f.TAX_AMOUNT * cf.QUANTITY)` was changed to `SUM(cf.TAX_AMOUNT * cf.QUANTITY)` and `SUM(df.TAX_AMOUNT * df.QUANTITY)` respectively. This implies a correction in the column reference for `TAX_AMOUNT` from the `f` (DIM_FEE) alias to the `cf` (DIM_CONTRACT_FEE) or `df` (DIM_DEED_FEE) alias. The `cancelled_contract_fee_tax` CTE (still commented out) also reflected this change in its commented code.
*   **1/21/2026, 4:16:07 PM**: The `LOWER(f.FEE_TYPE) != 'interest'` condition was changed to `LOWER(f.FEE_TYPE) != 'Interest'` in `contract_fee_tax` CTE, suggesting a case-sensitivity adjustment. Similarly, the `cancelled_contract_fee_tax` (commented out) also reflected this case change and changed its `TAX_AMOUNT` reference from `ccf.TAX_AMOUNT` to `ccf.TAX_AMOUNT * ccf.QUANTITY`.
*   **1/21/2026, 4:20:08 PM**: `CAST(... AS INT)` was added around `SELECT CONTRACT_ID FROM base_contracts` in the `WHERE cf.CONTRACT_ID IN (...)` clauses for `contract_fee_tax`, `deed_fee_tax`, and the commented `cancelled_contract_fee_tax` CTEs, indicating a type casting attempt for contract IDs.
*   **1/21/2026, 4:20:13 PM**: The hardcoded `DIM_CONTRACT.CONTRACT_NUMBER` filter in `base_contracts` was changed from `'645-110814'` to `'110814'`.
*   **1/21/2026, 4:20:28 PM**: No functional change visible in the provided diff.
*   **1/21/2026, 4:23:56 PM**: `CAST(... AS INT)` syntax appears to have been slightly malformed (missing parenthesis closure) or an attempt to use `IN (SELECT ... AS INT)`.
*   **1/21/2026, 4:26:14 PM**: The `CAST(... AS INT)` was removed from the `WHERE cf.CONTRACT_ID IN (...)` clauses in `contract_fee_tax` and `deed_fee_tax` (and the commented `cancelled_contract_fee_tax`). The syntax from `SELECT CONTRACT_ID FROM base_contracts AS INT)` changed to `(SELECT CONTRACT_ID FROM base_contracts)`.
*   **1/21/2026, 4:26:47 PM**: A change in the `contract_tax_totals` CTE: `COALESCE(ccft.cancelled_fee_tax_total, 0)` (which was previously commented out) was added back, but with the alias `cft.cancelled_fee_tax_total`, which seems incorrect given `cft` is for `contract_fee_tax`. This suggests a potential bug or an in-progress change. The `cancelled_contract_fee_tax` CTE remained commented out.
*   **1/21/2026, 4:27:14 PM**: `COALESCE(ccft.cancelled_fee_tax_total, 0)` in `contract_tax_totals` was commented out again.
*   **1/21/2026, 4:27:46 PM**: `//+` was added before the commented `COALESCE(ccft.cancelled_fee_tax_total, 0)` line in `contract_tax_totals`, likely for commenting clarity or further in-progress testing.
*   **1/21/2026, 4:29:42 PM**: `AS total_tax` was moved from the end of the `total_tax` calculation to the end of the `COALESCE(dft.deed_fee_tax_total, 0)` part in `contract_tax_totals`, essentially removing `cancelled_fee_tax_total` from the sum.
*   **1/21/2026, 4:31:12 PM**: The specific `DIM_CONTRACT.CONTRACT_NUMBER = '110814'` filter in `base_contracts` was commented out, reverting the query to use the original date range filter `(CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN '{$fromDate}' AND '{$toDate}' OR EXISTS (...))`. This marks a return from specific contract testing to general date-range functionality. The `cancelled_contract_fee_tax` CTE and its reference in `contract_tax_totals` remained commented out.
*   **1/21/2026, 4:32:48 PM**: No functional change visible in the provided diff.
*   **1/22/2026, 11:24:20 AM**: The SQL query's `SELECT` statement was extended to include all remaining `COALESCE(ic.property_owned, 0)` fields from `item_counts` (e.g., `Niche_Owned`, `OC_Owned`, `Other_Merchandise_Owned`, `Other_Services_Owned`, `Private_Estates_Owned`, `Urns_Owned`, `Vaults_Owned`). Also, the final `FROM` and `LEFT JOIN` clauses were added to complete the main `SELECT` statement: `FROM primary_contacts pc LEFT JOIN deceased_contacts dc ... LEFT JOIN contract_writers cw ... LEFT JOIN item_counts ic ...`. This completes the definition of the final result set.
*   **1/22/2026, 11:24:43 AM** and **1/22/2026, 11:25:33 AM**: No functional changes visible in the provided diff. These entries likely represent minor formatting changes or saving without material code alteration.

**2. `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (Timestamps: 1/21/2026, 12:54:56 PM and 1/22/2026, 11:19:31 AM, 1/22/2026, 11:25:42 AM)**

This file is responsible for syncing PlotBox data to HubSpot.

*   **1/21/2026, 12:54:56 PM**: A `dd($dealsBatch);` statement was temporarily added just before the main processing logic in the `syncPlotBoxData` method. This `dd()` (dump and die) is a debugging function in Laravel, indicating an active debugging session to inspect the `$dealsBatch` variable.
*   **1/22/2026, 11:19:31 AM**: The `dd($dealsBatch);` debugging line was removed. This indicates the debugging session for `$dealsBatch` concluded, and the code was prepared for normal execution flow.
*   **1/22/2026, 11:25:42 AM**: A `dd($dealsBatch);` statement was re-added at the same location, suggesting another debugging session related to the `$dealsBatch` variable or its downstream processing was initiated.

### Patterns and Recurring Elements:

*   **Continuous Iteration on SQL Query**: The `PlotBox\Contact.php` file saw frequent, small adjustments to its complex SQL query within the `getDataWithDateRange` method. These changes included:
    *   Commenting/uncommenting the date range filter in favor of a hardcoded contract number for targeted testing.
    *   Commenting/uncommenting and attempting to fix calculations related to `cancelled_contract_fee_tax`, indicating instability or ongoing development in that specific part of the tax calculation logic.
    *   Corrections to column aliases (`f.TAX_AMOUNT` to `cf.TAX_AMOUNT`) and case sensitivity (`'interest'` to `'Interest'`).
    *   Attempts at explicit type casting (`CAST(... AS INT)`) for `CONTRACT_ID` in `IN` clauses, which were later reverted.
    *   Final completion of the `SELECT` statement and `JOIN` clauses.
*   **Debugging Activities**: The `PlotBoxHubSpotService.php` file shows a clear pattern of debugging using `dd($dealsBatch);` being added and removed. This suggests that the HubSpot data synchronization process, particularly related to how "deals" data is prepared, was actively being investigated and tested.
*   **"PLOTBOX_WAREHOUSE.WAREHOUSE_EVERSTORYPARTNERS"**: This database schema and tables (e.g., `DIM_CONTRACT`, `DIM_CONTACT`, `DIM_CONTRACT_OWNER`, `DIM_CONTRACT_FEE`, `DIM_DEED_FEE`, `DIM_PAYMENT_SCHEDULE`, `DIM_FEE`, `DIM_FEE_CATEGORY`, `DIM_CONTRACT_WRITER`, `DIM_SYSTEM_USER`) are consistently referenced across all SQL queries, indicating a robust, specific data source for PlotBox information.
*   **Focus on Contract and Contact Data**: Both files are heavily centered around `Contract` and `Contact` entities, their relationships (`contractOwners`, `contracts`), and derived data like total cash price, various fees, taxes, and item counts (caskets, cremation products, ground, markers, mausoleum, niche, OC, merchandise, services, private estates, urns, vaults).
*   **Production Environment Filtering**: The `$contractStatusFilter` in `getDataWithDateRange` (`AND DIM_CONTRACT.STATUS = 'Approved'`) is consistently applied only in a production environment, implying a difference in data retrieval behavior between development/staging and live systems.
*   **HubSpot Integration**: The `PlotBoxHubSpotService` explicitly outlines a process for syncing PlotBox data to HubSpot, involving mapping data, searching for existing contacts/deals, creating/updating them, and associating them with locations. It handles primary and deceased contacts separately.

## 1:59:06 PM
The changes primarily revolve around two files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`.

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` (Multiple timestamps between 1/21/2026, 12:51:05 PM and 1/22/2026, 2:29:50 PM):**
    *   This file, a Laravel Eloquent model named `Contact`, is responsible for querying PlotBox data from a Snowflake warehouse.
    *   The most significant changes occur within the `getDataWithDateRange` static method, which contains a large SQL query.
    *   **Initial Change (1/21/2026, 12:51:05 PM):** The `WHERE` clause in the `base_contracts` CTE (Common Table Expression) originally filtered by `LAST_UPDATED_DATE_TIME_UTC` or `dc.LAST_UPDATED_DATETIME` within a specified date range (`$fromDate` and `$toDate`).
    *   **Frequent Modifications (1/21/2026, 12:52:00 PM to 1/21/2026, 4:29:42 PM):** The `WHERE` clause in the `base_contracts` CTE was repeatedly modified.
        *   Initially, the date range filter was commented out and replaced with a hardcoded filter: `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'`.
        *   Later, this contract number was changed to `'110814'`.
        *   The commented-out section for date range filtering and `EXISTS` subquery remained consistent throughout this period.
    *   **SQL `CAST` operations (1/21/2026, 4:20:08 PM to 1/21/2026, 4:23:56 PM):** In `contract_fee_tax`, `deed_fee_tax`, and `cancelled_contract_fee_tax` CTEs, `CONTRACT_ID IN (SELECT CONTRACT_ID FROM base_contracts)` was briefly changed to `CONTRACT_ID IN (CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))`, then reverted back to `CONTRACT_ID IN (SELECT CONTRACT_ID FROM base_contracts)` in subsequent changes. This suggests an attempt to cast the subquery result to an integer, which was then removed.
    *   **Commented-out `cancelled_contract_fee_tax` (1/21/2026, 3:57:10 PM to 1/21/2026, 4:29:42 PM):** The entire `cancelled_contract_fee_tax` CTE and its inclusion in the `contract_tax_totals` calculation were commented out.
    *   **Restoration of Date Range Filter (1/21/2026, 4:31:12 PM):** The hardcoded `DIM_CONTRACT.CONTRACT_NUMBER` filter was commented out, and the original date range filtering logic using `(CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN '{$fromDate}' AND '{$toDate}' OR EXISTS (...))` was uncommented and reactivated.
    *   **Final SQL Query Structure Refinement (1/22/2026, 11:24:20 AM and 1/22/2026, 2:29:50 PM):**
        *   The `cancelled_contract_fee_tax` CTE remains commented out.
        *   The `total_tax` calculation in `contract_tax_totals` was simplified to exclude the `cancelled_fee_tax_total` (due to the CTE being commented out).
        *   The final `SELECT` statement in the SQL query added `LEFT JOIN item_counts ic` which was incomplete in earlier versions. The join conditions for `deceased_contacts`, `contract_writers`, and `item_counts` were fully defined at the very end of the SQL query.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (Multiple timestamps between 1/21/2026, 12:54:56 PM and 1/22/2026, 11:25:42 AM):**
    *   This file is a service responsible for syncing PlotBox data to HubSpot.
    *   **Debugging `dd($dealsBatch)` (1/21/2026, 12:54:56 PM and 1/22/2026, 11:24:34 AM):** A `dd($dealsBatch)` (dump and die) statement was present immediately after populating `primaryContactBatch`, `deceasedContactBatch`, and `dealsBatch`. This suggests active debugging of the data mapping and batching process for deals.
    *   **Removal of `dd($dealsBatch)` (1/22/2026, 11:19:31 AM):** The `dd($dealsBatch)` line was removed in this version, indicating the debugging step was complete or temporarily halted.
    *   **Re-introduction of `dd($dealsBatch)` (1/22/2026, 11:24:34 AM):** The `dd($dealsBatch)` was re-added very shortly after its removal, suggesting further debugging or re-testing of the deal data. This was subsequently removed again in the very next timestamp.

**Timestamps of Significant Changes:**

*   **1/21/2026, 12:51:05 PM:** Initial capture of a complex SQL query with a date range filter in `Contact.php`.
*   **1/21/2026, 12:52:00 PM:** Introduction of a hardcoded `DIM_CONTRACT.CONTRACT_NUMBER` filter in `Contact.php`, commenting out the date range logic.
*   **1/21/2026, 3:57:10 PM:** Commenting out of `cancelled_contract_fee_tax` CTE and its impact on `contract_tax_totals` calculation in `Contact.php`.
*   **1/21/2026, 4:20:08 PM - 1/21/2026, 4:23:56 PM:** Brief introduction and removal of `CAST(SELECT CONTRACT_ID FROM base_contracts AS INT)` in `Contact.php`.
*   **1/21/2026, 4:31:12 PM:** Reinstatement of the original date range filter in `Contact.php` (commenting out the hardcoded contract number).
*   **1/22/2026, 11:19:31 AM:** Removal of the `dd($dealsBatch)` debugging statement in `PlotBoxHubSpotService.php`.
*   **1/22/2026, 11:24:20 AM:** Finalization of the SQL query structure in `Contact.php`, including complete `LEFT JOIN` clauses.
*   **1/22/2026, 11:24:34 AM:** Temporary re-introduction of `dd($dealsBatch)` debugging statement in `PlotBoxHubSpotService.php`.

**Patterns or Recurring Elements:**

*   **Frequent Modifications to `Contact.php`:** This file was modified numerous times within a short period, especially its `getDataWithDateRange` method's SQL query. This suggests active development, testing, and refinement of the data retrieval logic.
*   **SQL Query Iteration:** The core SQL query within `getDataWithDateRange` is highly complex, involving multiple CTEs for `base_contracts`, `payment_schedule_totals`, `contract_fee_tax`, `deed_fee_tax`, `cancelled_contract_fee_tax`, `contract_tax_totals`, `contract_net_prices`, `contract_writers`, `item_counts`, `primary_contacts`, and `deceased_contacts`. The changes show a pattern of selectively commenting and uncommenting parts of this query (like the date filter or the `cancelled_contract_fee_tax` CTE), indicating a process of testing different filtering or calculation approaches.
*   **Debugging in `PlotBoxHubSpotService.php`:** The repeated insertion and removal of `dd($dealsBatch)` in `PlotBoxHubSpotService.php` clearly indicates a debugging cycle focused on the `dealsBatch` data, likely to verify the data being passed to the HubSpot API.
*   **Focus on Contract Data:** Both files are concerned with PlotBox contract data. `Contact.php` extracts detailed contract and contact information, while `PlotBoxHubSpotService.php` prepares and syncs this data to HubSpot.
*   **Snowflake Database:** The `Contact` model consistently uses a `snowflake` connection and queries tables prefixed with `PLOTBOX_WAREHOUSE.WAREHOUSE_EVERSTORYPARTNERS.DIM_`.
*   **Hardcoded vs. Dynamic Filtering:** There's a back-and-forth between using a dynamic date range filter and a hardcoded `CONTRACT_NUMBER` filter in the SQL query, suggesting testing specific contract scenarios before enabling the general date range filtering.