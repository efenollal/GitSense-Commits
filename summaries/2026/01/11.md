# Activity Summary for 1/11/2026

## 10:21:19 PM
The changes primarily revolve around HubSpot CRM integration for contacts, deals, and locations, with a focus on data mapping and synchronization from a PlotBox data source. There are also updates to general PHP helper functions related to date and time conversions.

**File-specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Crm\Hubspot\HubSpotContactService.php` (Multiple timestamps between 1/2/2026, 11:41:48 AM and 1/9/2026, 3:21:01 PM):**
    *   **1/2/2026, 11:41:48 AM:** Initial comprehensive implementation of `HubSpotContactService`, including methods for `createContact`, `updateContact`, and `associatePrimaryAndDeceasedContacts`. It handles API calls to HubSpot, logging, and error management, with specific properties (`loc_id`, `last_update_dt`, `exists`, `service_type_code`) being unset before sending data to HubSpot.
    *   **1/2/2026, 12:01:48 PM:** A `dd($apiToken)` (dump and die) statement was temporarily added to the constructor, likely for debugging purposes.
    *   **1/2/2026, 12:03:11 PM:** The `dd($apiToken)` debugging statement was removed from the constructor.
    *   **1/2/2026, 12:16:54 PM:** The constructor's `$apiToken` parameter type hint was changed from `string` to `?string`, allowing it to accept `null`.
    *   **1/9/2026, 12:44:20 PM:** A `var_dump($contactProperties)` debugging statement was added within the `updateContact` method.
    *   **1/9/2026, 3:21:01 PM:** The `var_dump` debugging statement was removed from the `updateContact` method.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Crm\Hubspot\HubSpotDealService.php` (Multiple timestamps between 1/2/2026, 11:41:59 AM and 1/2/2026, 12:17:50 PM):**
    *   **1/2/2026, 11:41:59 AM:** Initial implementation of `HubSpotDealService`, providing functionality to `createDeal`, `updateDeal`, and `associateDealWithContact`. Similar to contacts, it handles HubSpot API interactions, logging, and removing specific properties (`loc_id`, `last_update_dt`, `exists`, `hmis_account_number`) before sending data.
    *   **1/2/2026, 12:17:50 PM:** The constructor's `$apiToken` parameter type hint was changed from `string` to `?string`.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Crm\Hubspot\HubSpotLocationService.php` (Multiple timestamps between 1/2/2026, 11:42:16 AM and 1/2/2026, 12:17:39 PM):**
    *   **1/2/2026, 11:42:16 AM:** Initial implementation of `HubSpotLocationService`, which includes methods for `getLocationIdByCode`, `getAssociationTypeId`, `associateContactToLocation`, `associateDealToLocation`, and `batchAssociateWithLocation`. It uses caching for association types and includes detailed error logging for HubSpot API calls.
    *   **1/2/2026, 12:17:39 PM:** The constructor's `$apiToken` parameter type hint was changed from `string` to `?string`.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Crm\Hubspot\HubSpotOwnerService.php` (Multiple timestamps between 1/2/2026, 11:43:42 AM and 1/2/2026, 12:17:13 PM):**
    *   **1/2/2026, 11:43:42 AM:** Initial implementation of `HubSpotOwnerService`, providing methods to `getOwnersList` and `getOwnerByEmailAddress`, with error handling and logging.
    *   **1/2/2026, 12:17:13 PM:** The constructor's `$apiToken` parameter type hint was changed from `string` to `?string`.

*   **`c:\Users\efeno\dev\datalink\app\Providers\HubSpotServiceProvider.php` (Multiple timestamps between 1/2/2026, 11:47:45 AM and 1/2/2026, 12:00:29 PM):**
    *   **1/2/2026, 11:47:45 AM:** Registration of `PlotBoxHubSpotService` and `HmisHubSpotService` with their respective `HubSpotContactService` and `HubSpotDealService` instances, injecting HubSpot API tokens from configuration. A `dd($hmisToken)` debugging statement was added for HMIS token.
    *   **1/2/2026, 12:00:29 PM:** The `dd($hmisToken)` debugging statement was removed.

*   **`c:\Users\efeno\dev\datalink\config\services.php` (Timestamp: 1/2/2026, 12:08:26 PM):**
    *   This file defines HubSpot service configurations, including various association type IDs, lifecycle stages, pipeline IDs, object type IDs, deal search configurations for 'hmis' and 'plotbox', and API access tokens for different data sources (`hmis`, `plotbox`) along with their respective property mappings.

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` (Multiple timestamps between 1/6/2026, 3:15:57 PM and 1/9/2026, 3:21:23 PM):**
    *   **1/6/2026, 3:15:57 PM:** Introduction of a complex SQL query within `getDataWithDateRange` to fetch contact, contract, and item count data from Snowflake. It includes CTEs (Common Table Expressions) for `base_contracts`, `contract_writers`, `item_counts`, `primary_contacts`, and `deceased_contacts`, joining them to produce a comprehensive dataset. A `Log::info` statement was added to log the first query result.
    *   **1/8/2026, 10:29:41 AM:** A `LIMIT 1` clause was added to the main SQL query within `getDataWithDateRange`.
    *   **1/8/2026, 10:31:58 AM:** Added `df.FACILITY_ID AS Facility_ID` and `df.FACILITY_NAME AS Facility_Name` to the SELECT statement and `LEFT JOIN WAREHOUSE_EVERSTORYPARTNERS.DIM_FACILITY df ON pc.FACILITY_KEY = df.FACILITY_KEY` to the SQL query within `getDataWithDateRange`.
    *   **1/8/2026, 10:33:02 AM:** Reverted the `DIM_FACILITY` join from `pc.FACILITY_KEY = df.FACILITY_KEY` back to `LEFT JOIN DIM_FACILITY df ON pc.FACILITY_KEY = df.FACILITY_KEY`, removing specific warehouse prefix.
    *   **1/8/2026, 10:40:26 AM:** The `getDataWithDateRange` function was renamed to `getDataWithDateRange1`, and a new `getDataWithDateRange` function was introduced with a hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '660-1004010262'` filter, and commented out date range and `EXISTS` clause.
    *   **1/8/2026, 10:52:47 AM:** The hardcoded `CONTRACT_NUMBER` filter was removed from the second `getDataWithDateRange`, restoring the original date range filtering logic.
    *   **1/8/2026, 10:55:03 AM - 1/8/2026, 11:04:46 AM:** These logs show the presence of two `getDataWithDateRange` functions and one `getDataWithDateRange1` which are identical, likely due to refactoring or testing. The change in 10:55:03 AM has a comment in the code that is incomplete.
    *   **1/8/2026, 11:04:55 AM:** Removed `df.FACILITY_ID` and `df.FACILITY_NAME` from the `SELECT` list and the `LEFT JOIN DIM_FACILITY` clause. Changed `Location_Cd` to use `SUBSTRING(CAST(pc.CONTACT_KEY AS STRING), 1, 3)`.
    *   **1/8/2026, 11:05:24 AM:** Reintroduced `LEFT JOIN DIM_FACILITY` and reverted `Location_Cd` to `df.FACILITY_SHORT_NAME`.
    *   **1/8/2026, 11:06:38 AM:** Renamed `getDataWithDateRange1` to `getDataWithDateRange2`, and duplicated `getDataWithDateRange1` again with identical content. This seems like a temporary debugging/refactoring step.
    *   **1/8/2026, 11:09:22 AM:** Corrected `bc.CREATED_BY_KEY` to `bc.CREATED_BY` in the `primary_contacts` and `deceased_contacts` CTEs' `INNER JOIN` conditions for `DIM_CONTRACT_OWNER` and `DIM_CONTACT`.
    *   **1/8/2026, 11:10:18 AM:** Fixed `dc.CONTACT_KEY` to `dc.CONTACT_ID` in `DIM_CONTRACT_OWNER` join for `primary_contacts` and `deceased_contacts` CTEs.
    *   **1/8/2026, 11:10:53 AM:** Reverted the previous change, changing `dc.CONTACT_ID` back to `dc.CONTACT_KEY` in `DIM_CONTRACT_OWNER` join for `primary_contacts` and `deceased_contacts` CTEs. This seems like a revert of the previous change.
    *   **1/8/2026, 11:11:00 AM:** No functional change observed from previous log.
    *   **1/8/2026, 11:18:21 AM:** Changed `DIM_CONTRACT.CREATED_BY_KEY` to `DIM_CONTRACT.CREATED_BY` in `base_contracts` CTE. Also updated join conditions in `primary_contacts` and `deceased_contacts` CTEs to match `dco.CREATED_BY = dc.CREATED_BY`.
    *   **1/8/2026, 11:19:46 AM:** Modified join conditions in `primary_contacts` and `deceased_contacts` CTEs: `dco.CONTACT_KEY = dc.CONTACT_KEY` became `dco.CONTACT_ID = dc.CONTACT_KEY`, and `dco.CONTRACT_KEY = DIM_CONTRACT.CONTRACT_KEY` became `dco.CONTRACT_ID = DIM_CONTRACT.CONTRACT_KEY` in `EXISTS` clause of `base_contracts`. Similar changes for `contract_writers` and `item_counts` CTEs were made. Added `df.FACILITY_ID AS Facility_ID` and changed `LEFT JOIN DIM_FACILITY df ON pc.FACILITY_KEY = df.FACILITY_KEY` to `LEFT JOIN DIM_FACILITY df ON pc.FACILITY_ID = df.FACILITY_ID` in the final SELECT.
    *   **1/8/2026, 11:42:34 AM:** Corrected join condition `dco.CONTACT_ID = dc.CONTACT_KEY` to `dco.CONTACT_ID = dc.CONTACT_KEY` and `dco.CONTRACT_ID = DIM_CONTRACT.CONTRACT_KEY` to `dco.CONTRACT_ID = DIM_CONTRACT.CONTRACT_KEY` in `base_contracts` and `primary_contacts`.
    *   **1/8/2026, 11:44:53 AM:** Modified `DIM_CONTRACT_WRITER` join logic to use `cw.USER_ID` for system user key lookup.
    *   **1/8/2026, 11:48:11 AM:** Changed `DIM_CONTRACT_ITEM` joins to use `FEE_ID` and `FEE_CATEGORY_ID` instead of `FEE_KEY` and `FEE_CATEGORY_KEY`.
    *   **1/8/2026, 12:23:40 PM:** The previous change for `DIM_CONTRACT_ITEM` joins was reverted (from ID to KEY).
    *   **1/8/2026, 12:25:13 PM:** Reverted `DIM_CONTRACT_ITEM` joins to use `FEE_ID` and `FEE_CATEGORY_ID`.
    *   **1/8/2026, 12:29:38 PM:** Removed `pc.CREATED_BY AS Created_By_Key` from the final SELECT statement and related `dco.CREATED_BY` joins.
    *   **1/8/2026, 12:30:57 PM:** Reverted `pc.CREATED_BY AS Created_By_Key` back into the final SELECT, along with its related joins.
    *   **1/9/2026, 11:29:14 AM:** Added `DIM_CONTRACT.CONTRACT_NUMBER = '660-1004010262'` filter in `base_contracts` CTE of `getDataWithDateRange` and commented out the date range and `EXISTS` clause. This makes the query target a specific contract.
    *   **1/9/2026, 11:29:23 AM:** Added `limit 1` to the end of the `getDataWithDateRange` SQL query.

*   **`\response_fd37b194-620b-4981-a320-76fc5f36551b\0` (Timestamp: 1/9/2026, 11:14:12 AM - This is a temporary file, likely reflecting changes to `PlotBoxDataToCrmMapper.php`):**
    *   Initial implementation of `PlotBoxDataToCrmMapper`, responsible for mapping PlotBox DTOs to HubSpot CRM formats for contacts and deals. It handles owner and location lookups, date validation, and specific data transformations (e.g., uppercasing state, normalizing pipeline/dealstage). Includes a destructor for cleanup. Introduces `mergePreNeedItemCountsToPrimaryContact` for conditional data merging. Contains `var_dump` debugging statements in `mapDeceasedContact` and `listAllLocations` (`Log::warning`).

*   **`c:\Users\efeno\dev\datalink\app\Mappers\PlotBoxDataToCrmMapper.php` (Multiple timestamps between 1/9/2026, 11:15:29 AM and 1/9/2026, 3:20:18 PM):**
    *   **1/9/2026, 11:15:29 AM:** In `mapContact`, the logic for determining `phoneNumber` was simplified to directly use `phone2` (landline) and `phone1` (mobile). The `date_of_birth` mapping for primary contact was also updated to explicitly reference `primaryDateOfBirth` from `PlotBoxDataTransferObject`.
    *   **1/9/2026, 11:15:37 AM:** No significant functional change compared to the previous entry, but `date_of_birth` and `date_of_death` were directly assigned using `date_string_to_midnight_utc_millis` in `mapDeceasedContact` without prior `isValidDate` check.
    *   **1/9/2026, 11:20:17 AM:** Corrected `mapDeceasedContact` to use `isValidDate` for `deceasedBirthDate` and `deceasedDeathDate` before applying `date_string_to_midnight_utc_millis`, and added explicit date properties for validation: `datesArray = ['date_of_birth', 'date_of_death']`.
    *   **1/9/2026, 11:24:38 AM:** Removed the explicit array `datesArray` and the loop from `mapDeceasedContact`, directly assigning `date_of_birth` and `date_of_death` in the initial `$data` array and relying on `formatMappedFields` for further processing (though `formatMappedFields` itself doesn't process these date fields). The `isValidDate` checks were also removed from direct assignment in this method.
    *   **1/9/2026, 11:25:29 AM:** The direct assignment of `date_of_birth` and `date_of_death` with `date_string_to_midnight_utc_millis` in `mapDeceasedContact` was restored, along with the `isValidDate` checks. This effectively reverts the previous change.
    *   **1/9/2026, 11:31:54 AM:** The `isValidDate` checks and calls to `date_string_to_midnight_utc_millis` for `date_of_birth` and `date_of_death` in `mapDeceasedContact` were again temporarily removed, along with the `datesArray` loop.
    *   **1/9/2026, 11:32:58 AM:** The `isValidDate` checks and calls to `date_string_to_midnight_utc_millis` for `date_of_birth` and `date_of_death` were restored to `mapDeceasedContact`. Debug `var_dump('here')` and `var_dump('there')` statements were added.
    *   **1/9/2026, 11:43:23 AM:** Modified `formatMappedFields` to normalize `pipeline` and `dealstage` values by removing spaces and lowercasing before checking against 'at-need' or 'pre-need' related constants. Also, added `birthday` field to `mapContact` using `primaryDateOfBirth`.
    *   **1/9/2026, 1:41:35 PM:** Added `birthday` field to `mapDeceasedContact` using `deceasedBirthDate`, similar to the primary contact. The `var_dump` statements are still present.
    *   **1/9/2026, 1:41:42 PM:** No functional change from the previous entry.
    *   **1/9/2026, 1:45:03 PM:** The `var_dump` debugging statements were removed from `mapDeceasedContact`.
    *   **1/9/2026, 3:20:18 PM:** No functional change from the previous entry.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (Multiple timestamps between 1/9/2026, 11:26:48 AM and 1/9/2026, 12:31:34 PM):**
    *   **1/9/2026, 11:26:48 AM:** Introduces the `PlotBoxHubSpotService` for syncing PlotBox data. It orchestrates the mapping of data to HubSpot contacts and deals, handles location associations, and includes a `processContacts` method with robust error handling for individual HubSpot API operations (create/update contacts, create associations, create/update deals, associate to locations). Debugging `dd($dealsBatch, $primaryContactBatch)` statement present.
    *   **1/9/2026, 11:26:59 AM:** No functional change from the previous entry.
    *   **1/9/2026, 11:45:09 AM:** Modified the debugging `dd()` statement to also dump `$deceasedContactBatch`.
    *   **1/9/2026, 11:53:47 AM:** The `dd()` debugging statement was removed from `syncPlotBoxData`.
    *   **1/9/2026, 12:17:46 PM:** Reintroduced a `dd($deceasedContactBatch)` debugging statement in `syncPlotBoxData`.
    *   **1/9/2026, 12:31:34 PM:** The `dd($deceasedContactBatch)` debugging statement was removed.

*   **`c:\Users\efeno\dev\datalink\app\helpers.php` (Multiple timestamps between 1/9/2026, 12:26:40 PM and 1/9/2026, 1:10:08 PM):**
    *   **1/9/2026, 12:26:40 PM:** Added a new helper function `date_string_to_midnight_utc_millis` to convert a date string to milliseconds since epoch at midnight UTC, assuming 'America/New_York' timezone initially. The function also checks for invalid or empty date strings.
    *   **1/9/2026, 12:26:57 PM:** The `date_string_to_midnight_utc_millis` function was modified to remove the `setTime(0, 0, 0)` call, meaning it converts the exact time from the input date string to UTC milliseconds.
    *   **1/9/2026, 12:29:20 PM:** The `date_string_to_midnight_utc_millis` function was reverted to convert to *seconds* since epoch (removed `* 1000`) and the `setTime(0,0,0)` was also removed. This means it calculates epoch seconds at the input time.
    *   **1/9/2026, 12:30:41 PM:** The `convert_utc_date_to_epoch` function was modified to return `strtotime($dateString)` instead of `strtotime($dateString) * 1000`, effectively returning seconds instead of milliseconds.
    *   **1/9/2026, 12:32:57 PM:** The `convert_utc_date_to_epoch` function was reverted to return milliseconds (`strtotime($dateString) * 1000`).
    *   **1/9/2026, 12:51:15 PM:** In `date_string_to_midnight_utc_millis`, the `DateTime` constructor was updated to use `new DateTime($dateString, new \DateTimeZone($original_timezone))` instead of `new DateTime($dateString . ' 00:00:00', ...)` and `setTime(0,0,0)` was also added again explicitly.
    *   **1/9/2026, 12:52:33 PM:** In `date_string_to_midnight_utc_millis`, the `DateTime` constructor was changed back to `new DateTime($dateString . ' 00:00:00', ...)` and `setTime(0,0,0)` was retained.
    *   **1/9/2026, 12:54:35 PM:** No functional change from previous entry.
    *   **1/9/2026, 12:58:10 PM:** Added a check `if ($timestamp < 0) return $dateString;` to `date_string_to_midnight_utc_millis` to handle cases where `strtotime` might fail or return a non-positive value, indicating an invalid date, returning the original string in such cases.
    *   **1/9/2026, 1:03:46 PM:** No functional change from previous entry.
    *   **1/9/2026, 1:04:51 PM:** No functional change from previous entry.
    *   **1/9/2026, 1:04:57 PM:** No functional change from previous entry.
    *   **1/9/2026, 1:05:08 PM:** No functional change from previous entry.
    *   **1/9/2026, 1:09:16 PM:** Added new validation for `date_string_to_midnight_utc_millis` to explicitly check if the `$dateString` matches `'/^\d{4}-\d{2}-\d{2}$/'` after truncating it to 10 characters. If not, it returns `null`.
    *   **1/9/2026, 1:09:50 PM:** No functional change from previous entry.
    *   **1/9/2026, 1:10:08 PM:** No functional change from previous entry.

**Patterns and Recurring Elements:**

*   **HubSpot API Integration:** A consistent pattern of integrating with HubSpot's CRM API is observed across `HubSpotContactService`, `HubSpotDealService`, `HubSpotLocationService`, and `HubSpotOwnerService`. All these services use `HubSpot\Factory::createWithAccessToken` and `config('services.hubspot. ...')` to retrieve API tokens and configuration details.
*   **Error Handling and Logging:** Extensive try-catch blocks are used with `Log::error` and `Log::info` to log detailed information about API successes and failures, including error codes, messages, and response bodies. This is prevalent in all HubSpot service files and the `exception_wrapper` helper.
*   **Data Transformation/Mapping:** The `PlotBoxDataToCrmMapper` class (and related temporary log) specifically focuses on transforming data from `PlotBoxDataTransferObject` into the format required by HubSpot. This includes trimming strings, mapping fields, and converting dates.
*   **Date Conversion:** Multiple helper functions (`date_string_to_midnight_utc_millis`, `convert_utc_date_to_epoch`) were added and iteratively refined to handle date string conversions to Unix epoch milliseconds, often considering specific timezones (`America/New_York`) and performing validation checks.
*   **Property Filtering:** The `createContact` and `updateContact` methods in `HubSpotContactService` and `createDeal`, `updateDeal` in `HubSpotDealService` consistently remove specific internal properties (e.g., `loc_id`, `last_update_dt`, `exists`, `service_type_code`, `hmis_account_number`) before sending data to HubSpot, indicating a need to clean data before CRM ingestion.
*   **Debugging Statements:** The presence and subsequent removal or modification of `dd()` and `var_dump()` statements in `HubSpotContactService` and `PlotBoxHubSpotService` indicate active development and debugging cycles.
*   **Code Duplication/Refactoring:** In `PlotBox\Contact.php`, there were instances of renamed and duplicated `getDataWithDateRange` methods, sometimes with temporary hardcoded SQL filters, suggesting a period of refactoring or feature development around the data retrieval logic.
*   **Association Management:** All HubSpot CRM services (`Contact`, `Deal`, `Location`) have methods dedicated to creating associations between different HubSpot objects (contacts, deals, locations), indicating a complex relational data model in the CRM.