# Activity Summary for 1/26/2026

## 12:24:06 AM
The logs show continuous development and debugging activity primarily focused on two PHP files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`. The timestamp range for these changes is from 1/21/2026, 12:51:05 PM to 1/22/2026, 2:29:50 PM.

### File-Specific Updates:

**1. `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
This file, representing an Eloquent Model for `Contact` in a `PlotBox` namespace, undergoes numerous modifications across multiple timestamps on both 1/21/2026 and 1/22/2026. The core of the changes is within the `getDataWithDateRange` static method, which executes a complex SQL query to retrieve contract and contact data from a Snowflake warehouse.

*   **Initial State (1/21/2026, 12:51:05 PM):** The query uses a `WHERE` clause to filter `DIM_CONTRACT` records by `LAST_UPDATED_DATE_TIME_UTC` or by the `LAST_UPDATED_DATETIME` of associated `DIM_CONTACT` records, both within a specified `fromDate` and `toDate` range. It also includes a `cancelled_contract_fee_tax` Common Table Expression (CTE) and references it in `contract_tax_totals`.
*   **Introduced Debugging/Testing (1/21/2026, 12:52:00 PM - 1/21/2026, 4:05:53 PM):** A significant pattern emerges where the original date range filtering in the `base_contracts` CTE's `WHERE` clause is commented out. In its place, a specific `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` filter is added, suggesting a shift to target specific contract data for testing or debugging.
    *   Around 1/21/2026, 3:57:10 PM, the `cancelled_contract_fee_tax` CTE is commented out entirely, and its reference in `contract_tax_totals` is also commented out. This change persists in subsequent versions, implying it was intentionally removed or temporarily disabled.
    *   At 1/21/2026, 4:05:53 PM, a subtle change occurs in `contract_fee_tax` and `deed_fee_tax` CTEs: `SUM(f.TAX_AMOUNT * cf.QUANTITY)` is changed to `SUM(cf.TAX_AMOUNT * cf.QUANTITY)` and `SUM(f.TAX_AMOUNT * df.QUANTITY)` to `SUM(df.TAX_AMOUNT * df.QUANTITY)`. This is a bug fix, correcting the tax amount aggregation by referencing `cf.TAX_AMOUNT` and `df.TAX_AMOUNT` (which are non-existent or incorrect aliases) instead of `f.TAX_AMOUNT`. This is likely an error introduced and corrected in a short span.
*   **Further Refinements (1/21/2026, 4:16:07 PM - 1/21/2026, 4:20:08 PM):** The `LOWER(f.FEE_TYPE) != 'interest'` condition is updated to `LOWER(f.FEE_TYPE) != 'Interest'` in the `contract_fee_tax` CTE, indicating a case-sensitivity correction.
    *   At 1/21/2026, 4:20:08 PM, an attempt is made to cast `SELECT CONTRACT_ID FROM base_contracts` to an integer `(CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))` within the `WHERE` clauses of `contract_fee_tax`, `deed_fee_tax`, and the commented `cancelled_contract_fee_tax` CTE. This syntax is incorrect for subqueries in `IN` clauses.
*   **Correction and Reversion (1/21/2026, 4:20:13 PM - 1/21/2026, 4:29:42 PM):** The specific `CONTRACT_NUMBER` used in the `base_contracts` CTE is changed from `'645-110814'` to `'110814'`. The incorrect `CAST(SELECT ... AS INT)` syntax is removed from the `WHERE` clauses of the tax-related CTEs (seen around 1/21/2026, 4:26:14 PM), reverting to `(SELECT CONTRACT_ID FROM base_contracts)`.
    *   The commented out `cancelled_contract_fee_tax` CTE and its reference in `contract_tax_totals` remain consistent.
*   **Final State (1/21/2026, 4:31:12 PM - 1/22/2026, 2:29:50 PM):** The hardcoded `CONTRACT_NUMBER` filter `'110814'` is commented out in `base_contracts`, re-enabling the original date range filtering `(CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN '{$fromDate}' AND '{$toDate}' OR EXISTS (...))`. The `cancelled_contract_fee_tax` CTE remains commented out throughout, and its reference is also consistently commented out in `contract_tax_totals`. The SQL joins in the final `SELECT` statement are expanded to include `item_counts` and other CTEs.

**2. `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**
This file handles the synchronization of PlotBox data to HubSpot.

*   **Snapshot 1 (1/21/2026, 12:54:56 PM):** This version includes a `dd($dealsBatch)` statement (a `die()` and `var_dump()` equivalent in Laravel), indicating that the code execution was halted here for inspection during development or debugging.
*   **Snapshot 2 (1/22/2026, 11:19:31 AM):** The `dd($dealsBatch)` statement is removed. This suggests the debugging related to `dealsBatch` was completed, and the sync process was allowed to continue past that point.
*   **Snapshot 3 (1/22/2026, 11:24:34 AM):** The `dd($dealsBatch)` statement is re-introduced, indicating a return to debugging at the same point, likely to re-verify the `dealsBatch` data or investigate a subsequent issue.
*   **Final State (1/22/2026, 11:25:42 AM):** The `dd($dealsBatch)` statement is removed again, allowing the script to proceed.

### Timestamps of Significant Changes:

*   **1/21/2026, 12:52:00 PM:** Introduction of hardcoded `CONTRACT_NUMBER` filter and commenting out date range in `Contact.php`.
*   **1/21/2026, 12:54:56 PM:** Addition of `dd($dealsBatch)` in `PlotBoxHubSpotService.php` to pause execution for debugging.
*   **1/21/2026, 3:57:10 PM:** Commenting out `cancelled_contract_fee_tax` CTE in `Contact.php`.
*   **1/21/2026, 4:05:53 PM:** Bug fix attempt in `contract_fee_tax` and `deed_fee_tax` CTEs (incorrect `cf.TAX_AMOUNT`/`df.TAX_AMOUNT` reference) in `Contact.php`.
*   **1/21/2026, 4:20:08 PM:** Introduction of incorrect `CAST(... AS INT)` syntax in `WHERE` clauses in `Contact.php`.
*   **1/21/2026, 4:26:14 PM:** Removal of incorrect `CAST(... AS INT)` syntax in `Contact.php`.
*   **1/21/2026, 4:31:12 PM:** Re-enabling of date range filter and commenting out hardcoded `CONTRACT_NUMBER` in `Contact.php`.
*   **1/22/2026, 11:19:31 AM:** Removal of `dd($dealsBatch)` in `PlotBoxHubSpotService.php`.
*   **1/22/2026, 11:24:34 AM:** Re-introduction of `dd($dealsBatch)` in `PlotBoxHubSpotService.php`.
*   **1/22/2026, 11:25:42 AM:** Final removal of `dd($dealsBatch)` in `PlotBoxHubSpotService.php`.
*   **1/22/2026, 2:29:50 PM:** The `Contact.php` file reaches a state similar to its initial version regarding the main `WHERE` clause, but the `cancelled_contract_fee_tax` CTE remains commented out.

### Patterns or Recurring Elements:

*   **Consistent File Modification:** Almost all changes revolve around the `Contact.php` model, specifically the large SQL query within the `getDataWithDateRange` method. This indicates active development or debugging of data retrieval logic.
*   **SQL Query Iteration:** The SQL query is repeatedly modified, often with minor adjustments, commenting/uncommenting sections, and introducing/correcting syntax, suggesting a process of trial and error or fine-tuning the data extraction.
*   **Debugging Markers:** The `dd($dealsBatch)` function is used multiple times in `PlotBoxHubSpotService.php` as a temporary debug step to inspect data at a particular point in the execution flow.
*   **Commented-Out Code:** Both files show patterns of commenting out sections of code for temporary disabling or testing, most notably the date range filter in `Contact.php` (replaced by a hardcoded contract number) and the `cancelled_contract_fee_tax` CTE.
*   **Focus on Contract Data:** The changes in `Contact.php` consistently aim to refine how contract, contact, fee, and item count data are aggregated and joined, primarily from `PLOTBOX_WAREHOUSE.WAREHOUSE_EVERSTORYPARTNERS` tables.
*   **Minor Syntax Fixes:** The `LOWER(f.FEE_TYPE) != 'interest'` capitalization and the `CAST(... AS INT)` subquery error indicate attempts to correct SQL syntax or logic.

## 1:24:23 AM
The provided log details changes across two files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`.

### File-Specific Updates:

#### `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`

This file, a Laravel Eloquent model for `Contact` within the `PlotBox` namespace, primarily deals with fetching contract and contact data from a Snowflake data warehouse. The changes observed are consistently focused on the `getDataWithDateRange` static method, which executes a complex SQL query.

*   **1/21/2026, 12:51:05 PM (Initial State):** The query filters `DIM_CONTRACT` based on `LAST_UPDATED_DATE_TIME_UTC` or `DIM_CONTACT.LAST_UPDATED_DATETIME` within a `{$fromDate}` and `{$toDate}` range. It includes `cancelled_contract_fee_tax` in the `contract_tax_totals` CTE.

*   **1/21/2026, 12:52:00 PM - 1/21/2026, 3:57:10 PM:** A notable and recurring pattern begins. The date range filter in the `base_contracts` CTE's `WHERE` clause is commented out. In its place, a hardcoded filter `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` is introduced. This suggests a debugging or specific data testing phase. The `cancelled_contract_fee_tax` CTE and its inclusion in `contract_tax_totals` are also consistently commented out during this period, indicating that tax calculation for cancelled contracts was temporarily removed or disabled.

*   **1/21/2026, 4:05:53 PM:** Small changes appear in the `contract_fee_tax` and `deed_fee_tax` CTEs. The `SUM` aggregations change from `SUM(f.TAX_AMOUNT * cf.QUANTITY)` to `SUM(cf.TAX_AMOUNT * cf.QUANTITY)` for `contract_fee_tax` and `SUM(df.TAX_AMOUNT * df.QUANTITY)` for `deed_fee_tax`. It seems there was a typo where `cf.TAX_AMOUNT` was used instead of `f.TAX_AMOUNT` in `contract_fee_tax` and `cf.TAX_AMOUNT` instead of `df.TAX_AMOUNT` in `deed_fee_tax`. The `LOWER(f.FEE_TYPE) != 'interest'` filter in `contract_fee_tax` also changes to `'Interest'` (capital 'I'). The `cancelled_contract_fee_tax` CTE remains commented out.

*   **1/21/2026, 4:16:07 PM:** Corrects the tax amount in `contract_fee_tax` and `deed_fee_tax` from `cf.TAX_AMOUNT` / `df.TAX_AMOUNT` to `f.TAX_AMOUNT` and `f.TAX_AMOUNT` respectively. The `LOWER(f.FEE_TYPE) != 'Interest'` casing remains. The `cancelled_contract_fee_tax` CTE and its reference are still commented out.

*   **1/21/2026, 4:20:08 PM - 1/21/2026, 4:20:28 PM:** Further adjustments are made within the SQL query, specifically adding `CAST(... AS INT)` around `SELECT CONTRACT_ID FROM base_contracts` in the `WHERE` clauses of `contract_fee_tax`, `deed_fee_tax`, and the commented-out `cancelled_contract_fee_tax` CTE. This indicates a type casting issue or a move to enforce integer types for contract IDs in subqueries. The hardcoded `CONTRACT_NUMBER` changes from `'645-110814'` to `'110814'`.

*   **1/21/2026, 4:23:56 PM - 1/21/2026, 4:29:42 PM:** The `CAST(... AS INT)` is removed again in `contract_fee_tax` and `deed_fee_tax` subqueries. There are several minor changes in commenting/uncommenting the `COALESCE(ccft.cancelled_fee_tax_total, 0)` line in `contract_tax_totals`, suggesting back-and-forth testing or decision-making regarding cancelled contract fees.

*   **1/21/2026, 4:31:12 PM - 1/22/2026, 11:25:33 AM:** The hardcoded `DIM_CONTRACT.CONTRACT_NUMBER` filter is removed, and the original date range filtering logic based on `LAST_UPDATED_DATE_TIME_UTC` and `DIM_CONTACT.LAST_UPDATED_DATETIME` is restored. The `cancelled_contract_fee_tax` CTE remains commented out. The `contract_tax_totals` CTE also definitively removes its reference to `ccft.cancelled_fee_tax_total`. In the final state (1/22/2026, 11:24:20 AM onwards), the `FROM` clause of the main `SELECT` statement is fully defined, joining `primary_contacts`, `deceased_contacts`, `contract_writers`, `contract_net_prices`, `item_counts`, and `WAREHOUSE_EVERSTORYPARTNERS.DIM_FACILITY` tables.

#### `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`

This file is responsible for syncing PlotBox data to HubSpot CRM.

*   **1/21/2026, 12:54:56 PM:** A `dd($dealsBatch);` (dump and die) statement is added after populating the batch arrays (`primaryContactBatch`, `deceasedContactBatch`, `dealsBatch`, `locationAssociations`) in the `syncPlotBoxData` method. This line would halt execution to inspect the contents of `$dealsBatch`.

*   **1/22/2026, 11:19:31 AM:** The `dd($dealsBatch);` statement is removed. This indicates that the debugging step for `$dealsBatch` was completed.

*   **1/22/2026, 11:24:34 AM:** The `dd($dealsBatch);` statement is reintroduced in the `syncPlotBoxData` method, suggesting a re-initiation of debugging for the `dealsBatch` or related data mapping.

*   **1/22/2026, 11:25:42 AM:** The `dd($dealsBatch);` statement is removed again, completing the second debugging session.

### Timestamps of Significant Changes:

*   **1/21/2026, 12:52:00 PM - 1/21/2026, 3:57:10 PM:** Initial debugging phase in `Contact.php` using a hardcoded `CONTRACT_NUMBER` filter and commenting out date range and cancelled fee tax.
*   **1/21/2026, 4:05:53 PM:** Correction of tax amount source (`f.TAX_AMOUNT` vs `cf.TAX_AMOUNT`/`df.TAX_AMOUNT`) and casing of 'Interest' fee type in `Contact.php`.
*   **1/21/2026, 4:20:08 PM:** Introduction of `CAST(... AS INT)` for subqueries and a change in the hardcoded `CONTRACT_NUMBER` to `'110814'` in `Contact.php`.
*   **1/21/2026, 4:31:12 PM:** Reversion of `Contact.php`'s `getDataWithDateRange` method to use the original date range filtering and permanent removal of cancelled fee tax calculation.
*   **1/21/2026, 12:54:56 PM, 1/22/2026, 11:24:34 AM:** `dd($dealsBatch);` is added to `PlotBoxHubSpotService.php`, indicating debugging.
*   **1/22/2026, 11:19:31 AM, 1/22/2026, 11:25:42 AM:** `dd($dealsBatch);` is removed from `PlotBoxHubSpotService.php`, indicating completion of debugging.
*   **1/22/2026, 11:24:20 AM:** The SQL query's final `FROM` clause in `Contact.php` is fully formed with all necessary `LEFT JOIN` statements.

### Patterns and Recurring Elements:

*   **Debugging Cycle:** The `Contact.php` file shows a clear pattern of introducing a hardcoded `CONTRACT_NUMBER` filter and commenting out date range logic for focused testing/debugging, followed by reverting these changes. Similarly, `PlotBoxHubSpotService.php` exhibits a pattern of adding and removing `dd($dealsBatch);` for inspection.
*   **SQL Query Refinement:** The `getDataWithDateRange` method's SQL query is constantly being modified, primarily in its `WHERE` clause conditions (date range vs. specific contract number) and calculations for `contract_tax_totals`, specifically the inclusion/exclusion of `cancelled_contract_fee_tax`. There were also adjustments related to correct tax column referencing and explicit type casting.
*   **Incremental Development:** Changes are mostly small and iterative, suggesting continuous development, testing, and refinement of the data retrieval and synchronization logic.
*   **Focus on PlotBox Integration:** Both files are related to the "PlotBox" system, implying ongoing work on data integration or synchronization processes.
*   **Database Interaction:** Both files heavily interact with a database, specified as `snowflake`, and reference various `WAREHOUSE_EVERSTORYPARTNERS.DIM_` tables (e.g., `DIM_CONTRACT`, `DIM_CONTACT`, `DIM_PAYMENT_SCHEDULE`, `DIM_CONTRACT_FEE`, `DIM_DEED_FEE`, `DIM_CANCELLED_CONTRACT_FEE`, `DIM_CONTRACT_WRITER`, `DIM_SYSTEM_USER`, `DIM_CONTRACT_ITEM`, `DIM_FEE`, `DIM_FEE_CATEGORY`, `DIM_FACILITY`).
*   **Error Handling and Logging:** The `PlotBoxHubSpotService.php` consistently includes `try-catch` blocks with `Log::error` calls, highlighting a focus on robust error handling during the HubSpot synchronization process.

## 10:37:40 AM
The changes primarily involve two files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`. The bulk of the modifications occurred on January 21, 2026, and January 22, 2026.

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
    *   **Timestamps:** This file was modified repeatedly on January 21, 2026, between 12:51 PM and 4:32 PM, and then again on January 22, 2026, at 11:24 AM and 11:25 AM, and a final time at 2:29 PM.
    *   **Content Changes:**
        *   **SQL Query in `getDataWithDateRange` method:** The most consistent changes were to the large SQL query within the `getDataWithDateRange` static method.
        *   **Contract Number Filtering:** The `WHERE` clause in the `base_contracts` CTE (Common Table Expression) was frequently toggled between a specific `DIM_CONTRACT.CONTRACT_NUMBER` filter (e.g., `'645-110814'`, then `'110814'`) and a commented-out date range filter.
            *   Initially (1/21/2026, 12:51:05 PM), the date range filter was active.
            *   From 1/21/2026, 12:52:00 PM, a hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` filter was introduced, and the date range filter was commented out. This specific contract number changed to `'110814'` at 1/21/2026, 4:20:13 PM.
            *   At 1/21/2026, 4:31:12 PM, and consistently thereafter until 1/22/2026, 2:29:50 PM, the hardcoded contract number filter was commented out, and the original date range filter was reactivated.
        *   **`cancelled_contract_fee_tax` CTE:** This CTE was consistently commented out and then re-commented out in multiple commits (e.g., 1/21/2026, 3:57:10 PM, 4:05:53 PM, 4:16:07 PM, 4:20:08 PM, 4:20:13 PM, 4:20:28 PM, 4:23:56 PM, 4:26:14 PM, 4:26:47 PM, 4:27:14 PM, 4:29:42 PM, 4:31:12 PM, 4:32:48 PM). The commenting out of `ccft.cancelled_fee_tax_total` from the `contract_tax_totals` CTE, which was dependent on this, also occurred in conjunction.
        *   **Type Casting in `WHERE` Clauses:** On 1/21/2026, 4:20:08 PM, and subsequent commits until 1/21/2026, 4:26:14 PM, there were attempts to cast the subquery `(SELECT CONTRACT_ID FROM base_contracts)` to `INT` within the `WHERE` clauses of `contract_fee_tax`, `deed_fee_tax`, and `cancelled_contract_fee_tax` CTEs. These `CAST` operations were removed at 1/21/2026, 4:26:14 PM.
        *   **Column Aliases in `SELECT` Statement:** The final `SELECT` statement had its ending truncated in several logs (e.g., 1/21/2026, 12:51:05 PM, 12:52:00 PM, 12:54:01 PM), indicating a copy-paste error in the logging, but the actual code shows that the `COALESCE(ic.other_services_owned, 0)` was sometimes truncated as well, and was fully restored at 1/22/2026, 11:24:20 AM. The final join `LEFT JOIN item_counts ic` also appears truncated in many logs.
*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**
    *   **Timestamps:** This file was modified on January 21, 2026, at 12:54:56 PM, and again on January 22, 2026, at 11:19:31 AM and 11:25:42 AM.
    *   **Content Changes:**
        *   **`dd($dealsBatch)` call:** A `dd($dealsBatch)` (dump and die) statement was present immediately after populating the batch arrays within the `syncPlotBoxData` method at 1/21/2026, 12:54:56 PM and 1/22/2026, 11:25:42 AM. This `dd()` call was removed in the commit at 1/22/2026, 11:19:31 AM, indicating debugging activity, and then re-introduced later at 1/22/2026, 11:25:42 AM.
        *   The rest of the `PlotBoxHubSpotService.php` code remained largely consistent throughout the logged changes, focusing on synchronizing PlotBox data to HubSpot, handling contacts, deals, and location associations with error logging and retry mechanisms (sleeps).

**Patterns and Recurring Elements:**

*   **Debugging Focus:** The most prominent pattern is the repeated toggling of a specific `CONTRACT_NUMBER` filter and the commenting out/in of the date range filter in `Contact.php`, along with the presence and removal of `dd($dealsBatch)` in `PlotBoxHubSpotService.php`. This strongly suggests active debugging and testing of the SQL query and data processing logic.
*   **Consistent Structure:** Despite the debugging changes, the overall structure of the `Contact.php` model, including its Eloquent relationships, fillable properties, and the multi-CTE SQL query, remained stable.
*   **Snowflake Connection:** The `const CONNECTION = 'snowflake';` in the `Contact` model indicates a consistent use of Snowflake as the database.
*   **PlotBox Integration:** Both files are heavily involved in the "PlotBox" domain, with `Contact.php` fetching data from `PLOTBOX_WAREHOUSE` tables and `PlotBoxHubSpotService.php` handling synchronization of this data to HubSpot.
*   **Error Handling:** Both files include `try-catch` blocks and `Log::error` calls, indicating robust error handling in the data fetching and synchronization processes.

## 11:37:59 AM
The log details changes across two files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`.

**File-Specific Updates:**

**`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
This file, a Laravel Eloquent model for `Contact` data, primarily saw iterative changes to the `getDataWithDateRange` SQL query.

*   **1/21/2026, 12:51:05 PM (Initial State):** The `getDataWithDateRange` method contains a complex SQL query joining numerous `PLOTBOX_WAREHOUSE.WAREHOUSE_EVERSTORYPARTNERS` tables (`DIM_CONTRACT`, `DIM_CONTRACT_OWNER`, `DIM_CONTACT`, `DIM_PAYMENT_SCHEDULE`, `DIM_CONTRACT_FEE`, `DIM_DEED_FEE`, `DIM_CANCELLED_CONTRACT_FEE`, `DIM_FEE`, `DIM_SYSTEM_USER`, `DIM_CONTRACT_ITEM`, `DIM_FEE_CATEGORY`, `DIM_FACILITY`). The query aims to retrieve detailed contact and contract information, including various item counts (caskets, cremation products, ground, markers, mausoleum, niche, OC, other merchandise/services, private estates, urns, vaults) and financial totals (total cash price, total tax, net price). A `contractStatusFilter` is applied in production to include only 'Approved' contracts. The `base_contracts` CTE filters records by `LAST_UPDATED_DATE_TIME_UTC` or `LAST_UPDATED_DATETIME` within a given date range.

*   **1/21/2026, 12:52:00 PM to 1/21/2026, 1:37:28 PM:** A significant, repeated pattern of change occurred here. The date range filtering in the `base_contracts` CTE (i.e., `(CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN '{$fromDate}' AND '{$toDate}' OR EXISTS (...)`) was **commented out**, and a hardcoded filter `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` was added. This suggests debugging or testing for a specific contract. The rest of the SQL query remained largely the same, but the previous `dd($dealsBatch)` debug statement from the HubSpot service (below) was not present in this file.

*   **1/21/2026, 3:57:10 PM:** The `cancelled_contract_fee_tax` CTE was entirely **commented out**. Consequently, the `contract_tax_totals` CTE also had its join to `cancelled_contract_fee_tax` and the `COALESCE` for `ccft.cancelled_fee_tax_total` commented out. This indicates a decision to temporarily or permanently exclude cancelled contract fees from the tax calculation.

*   **1/21/2026, 4:05:53 PM:** Small but critical change in `contract_fee_tax` and `deed_fee_tax` CTEs: `SUM(f.TAX_AMOUNT * cf.QUANTITY)` was changed to `SUM(cf.TAX_AMOUNT * cf.QUANTITY)` and `SUM(f.TAX_AMOUNT * df.QUANTITY)` was changed to `SUM(df.TAX_AMOUNT * df.QUANTITY)` respectively. This implies a correction in how tax amounts were retrieved or calculated for contract and deed fees, moving from `f.TAX_AMOUNT` (from `DIM_FEE`) to `cf.TAX_AMOUNT` or `df.TAX_AMOUNT` (presumably from `DIM_CONTRACT_FEE` or `DIM_DEED_FEE`).

*   **1/21/2026, 4:16:07 PM:** Minor case change in `contract_fee_tax` CTE: `LOWER(f.FEE_TYPE) != 'interest'` was changed to `LOWER(f.FEE_TYPE) != 'Interest'`.

*   **1/21/2026, 4:20:08 PM:** An attempt to explicitly cast subquery results to `INT` was made in `contract_fee_tax`, `deed_fee_tax`, and `cancelled_contract_fee_tax` (though `cancelled_contract_fee_tax` remained commented out). Specifically, `WHERE cf.CONTRACT_ID IN (SELECT CONTRACT_ID FROM base_contracts)` became `WHERE cf.CONTRACT_ID IN (CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))`. Also, the hardcoded contract number filter changed from `'645-110814'` to `'110814'`.

*   **1/21/2026, 4:20:13 PM to 1/21/2026, 4:26:14 PM:** The explicit `CAST(SELECT ... AS INT)` syntax for `IN` clauses in the tax-related CTEs (`contract_fee_tax`, `deed_fee_tax`, `cancelled_contract_fee_tax` - the latter still commented) was reverted. It went from `(CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))` back to `(SELECT CONTRACT_ID FROM base_contracts)`. The hardcoded contract number filter remained `'110814'`.

*   **1/21/2026, 4:26:47 PM:** In the `contract_tax_totals` CTE, `COALESCE(ccft.cancelled_fee_tax_total, 0)` was explicitly uncommented and included in the sum for `total_tax`. This reverses the prior change that removed cancelled fees from tax calculations.

*   **1/21/2026, 4:27:14 PM to 1/21/2026, 4:29:42 PM:** The line `COALESCE(ccft.cancelled_fee_tax_total, 0)` in `contract_tax_totals` was commented out again. The `cancelled_contract_fee_tax` CTE itself remained commented out.

*   **1/21/2026, 4:31:12 PM:** The hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '110814'` filter in `base_contracts` was **commented out**, and the original date range filtering logic (based on `LAST_UPDATED_DATE_TIME_UTC` or `LAST_UPDATED_DATETIME`) was **re-enabled**. This indicates the return to dynamic date range filtering for the main query.

*   **1/22/2026, 11:24:20 AM:** The `cancelled_contract_fee_tax` CTE, along with its reference in `contract_tax_totals`, was completely **removed** (not just commented out). This suggests a final decision to exclude cancelled fees from tax calculations. Additionally, the final `SELECT` statement was extended to explicitly `LEFT JOIN` `deceased_contacts`, `contract_writers`, and `item_counts` on `primary_contacts` using specific `CONTRACT_ID` and `CREATED_BY` (or `rn`) conditions, and it also includes a `LEFT` join to `DIM_FACILITY` (`df`). The previous versions of the code had an implicit join to `df` in the final SELECT, but this version explicitly shows its connection point.

**`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**
This file handles syncing PlotBox data to HubSpot.

*   **1/21/2026, 12:54:56 PM (Initial State):** Contains a `dd($dealsBatch)` statement right after populating the batch arrays, indicating a debugging breakpoint.
*   **1/22/2026, 11:19:31 AM:** The `dd($dealsBatch)` debugging statement was **removed**. This suggests the debugging session related to deals batch was completed.
*   **1/22/2026, 11:24:34 AM to 1/22/2026, 11:25:42 AM:** The `dd($dealsBatch)` debugging statement was **re-introduced** again. This indicates a resumed debugging or testing phase, focusing on the `dealsBatch` content before further processing.

**Timestamps of Significant Changes:**

*   **1/21/2026, 12:51:05 PM:** Initial complex SQL query structure established in `Contact.php`.
*   **1/21/2026, 12:52:00 PM:** Start of a series of changes in `Contact.php` involving commenting out the date filter and adding a hardcoded contract number filter for debugging.
*   **1/21/2026, 12:54:56 PM:** Introduction of a `dd($dealsBatch)` debugging statement in `PlotBoxHubSpotService.php`.
*   **1/21/2026, 3:57:10 PM:** Major change in `Contact.php` by commenting out the `cancelled_contract_fee_tax` CTE.
*   **1/21/2026, 4:05:53 PM:** Correction in tax amount retrieval logic (`f.TAX_AMOUNT` to `cf.TAX_AMOUNT`/`df.TAX_AMOUNT`) in `Contact.php`.
*   **1/21/2026, 4:20:08 PM:** Attempted `CAST` in SQL `IN` clauses and contract number change in `Contact.php`.
*   **1/21/2026, 4:31:12 PM:** Reversion in `Contact.php` to the original dynamic date range filtering, removing the hardcoded contract number.
*   **1/22/2026, 11:19:31 AM:** Removal of the `dd($dealsBatch)` debugging statement in `PlotBoxHubSpotService.php`.
*   **1/22/2026, 11:24:20 AM:** Final removal of `cancelled_contract_fee_tax` CTE and explicit join statements in `Contact.php`.
*   **1/22/2026, 11:24:34 AM:** Re-introduction of the `dd($dealsBatch)` debugging statement in `PlotBoxHubSpotService.php`.

**Patterns or Recurring Elements:**

*   **Debugging Activity:** A strong pattern of debugging is evident, particularly in `Contact.php` with the repeated commenting/uncommenting of the date range filter and temporary insertion of a hardcoded contract number (`'645-110814'`, then `'110814'`). Similarly, the `PlotBoxHubSpotService.php` shows repeated addition and removal of `dd($dealsBatch)` statements. This suggests an iterative development and testing process to refine the data retrieval and mapping logic.
*   **SQL Query Refinement:** In `Contact.php`, the core activity revolved around refining a complex SQL query. This included adjustments to tax calculation logic (e.g., source of `TAX_AMOUNT`), changes in how subqueries are handled (`CAST` attempts), and decisions about including/excluding specific fee categories (`cancelled_contract_fee_tax`).
*   **Consistency in Model Structure:** The `Contact` model's basic PHP structure (namespace, traits, constants, table, primary key, timestamps, fillable fields, and Eloquent relationships) remained consistent throughout the logs, indicating that the foundational model definition was stable, while the data retrieval logic within `getDataWithDateRange` was actively being worked on.
*   **HubSpot Integration Focus:** The `PlotBoxHubSpotService.php` file indicates an ongoing effort to integrate PlotBox data with HubSpot, involving mapping, searching, creating, updating contacts/deals, and associating them with locations. The `dd()` statements suggest testing specific parts of this sync process.
*   **Iterative commenting/uncommenting:** Both files show a tendency to comment out and then potentially uncomment or remove code sections (e.g., date filters in SQL, `cancelled_contract_fee_tax` CTE, `dd()` calls). This is typical for debugging, testing, and temporarily disabling features during development.