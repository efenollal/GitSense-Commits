# Activity Summary for 1/24/2026

## 3:29:32 AM
The provided log details changes across two files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`.

**File-Specific Updates:**

**1. `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
This file, representing an Eloquent Model for `Contact` in a PlotBox context, undergoes numerous changes primarily focused on its `getDataWithDateRange` static method, which queries a Snowflake data warehouse.

*   **1/21/2026, 12:51:05 PM (Initial State):** The `getDataWithDateRange` method contains a complex SQL query that retrieves contract and contact information, calculates total taxes, net prices, identifies contract writers, and counts various item types (caskets, cremation products, ground, markers, mausoleums, niches, OCs, merchandise, services, private estates, urns, vaults). The `WHERE` clause for `base_contracts` filters based on `LAST_UPDATED_DATE_TIME_UTC` or `dc.LAST_UPDATED_DATETIME` within a given date range. A `contractStatusFilter` is applied conditionally for production environments.

*   **1/21/2026, 12:52:00 PM:** A significant change is introduced in the `base_contracts` CTE's `WHERE` clause. The original date range filtering and the `EXISTS` subquery are **commented out**, and a hardcoded filter `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` is added. This indicates a temporary change, likely for testing or debugging a specific contract. The `contract_tax_totals` CTE still includes a reference to `ccft.cancelled_fee_tax_total` even though `cancelled_contract_fee_tax` is not fully calculated in the current snippet (it's cut off, but the reference remains). The final `SELECT` statement is also truncated.

*   **1/21/2026, 12:54:01 PM:** No functional change is observed in the provided snippet. The hardcoded contract number filter and the commented-out date range logic persist. The truncation of the `SELECT` statement also remains.

*   **1/21/2026, 3:57:10 PM:**
    *   The `cancelled_contract_fee_tax` CTE is **commented out entirely**.
    *   Consequently, the `contract_tax_totals` CTE has its reference to `COALESCE(ccft.cancelled_fee_tax_total, 0)` **commented out**. This indicates a decision to temporarily or permanently exclude cancelled contract fees from the total tax calculation.

*   **1/21/2026, 4:05:53 PM:**
    *   A critical bug fix is applied: in the `contract_fee_tax` CTE, `SUM(f.TAX_AMOUNT * cf.QUANTITY)` is changed to `SUM(cf.TAX_AMOUNT * cf.QUANTITY)`. It appears the table alias `f` was incorrectly used instead of `cf` for `TAX_AMOUNT`.
    *   Similarly, in the `deed_fee_tax` CTE, `SUM(f.TAX_AMOUNT * df.QUANTITY)` is changed to `SUM(cf.TAX_AMOUNT * df.QUANTITY)`. This seems to be another correction, assuming `cf.TAX_AMOUNT` was intended, although `df.TAX_AMOUNT` might have been the correct original intention given the `df` alias for `DIM_DEED_FEE`. This specific change looks like a potential copy-paste error where `cf.TAX_AMOUNT` (from `contract_fee_tax`) was used instead of `df.TAX_AMOUNT`.

*   **1/21/2026, 4:16:07 PM:**
    *   The bug in `deed_fee_tax` is corrected: `SUM(cf.TAX_AMOUNT * df.QUANTITY)` is changed to `SUM(df.TAX_AMOUNT * df.QUANTITY)`, correctly using `df.TAX_AMOUNT`.
    *   In `contract_fee_tax`, the `LOWER(f.FEE_TYPE) != 'interest'` condition is changed to `LOWER(f.FEE_TYPE) != 'Interest'` (capital 'I'), indicating a case-sensitivity adjustment.
    *   The `cancelled_contract_fee_tax` CTE remains commented out.

*   **1/21/2026, 4:20:08 PM:**
    *   The `WHERE` clauses for `cf.CONTRACT_ID` and `df.CONTRACT_ID` in `contract_fee_tax` and `deed_fee_tax` (and implicitly for the commented-out `cancelled_contract_fee_tax`) are changed to include a `CAST(...) AS INT)` for the subquery `(SELECT CONTRACT_ID FROM base_contracts)`. This suggests a type casting issue or a requirement for explicit type conversion in the Snowflake query.
    *   The hardcoded contract number filter in `base_contracts` is changed from `'645-110814'` to `'110814'`.

*   **1/21/2026, 4:20:13 PM:** No functional change is observed in the provided snippet, continuing the previous change of the hardcoded contract number filter.

*   **1/21/2026, 4:20:28 PM:** No functional change is observed in the provided snippet.

*   **1/21/2026, 4:23:56 PM:** The `CAST(... AS INT)` syntax is adjusted slightly in the `WHERE` clauses for `cf.CONTRACT_ID` and `df.CONTRACT_ID`. For `deed_fee_tax`, it changes from `IN (CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))` to `IN SELECT CONTRACT_ID FROM base_contracts AS INT)`. This looks like a syntax error in the provided log, missing the opening parenthesis for `SELECT CONTRACT_ID FROM base_contracts`.

*   **1/21/2026, 4:26:14 PM:** The `CAST(... AS INT)` is **removed** from the `WHERE` clauses of `contract_fee_tax` and `deed_fee_tax`, reverting to `IN (SELECT CONTRACT_ID FROM base_contracts)`. This indicates the explicit casting was either unnecessary or caused issues.

*   **1/21/2026, 4:26:47 PM:** In the `contract_tax_totals` CTE, `COALESCE(ccft.cancelled_fee_tax_total, 0)` is **uncommented and included in the sum**, despite the `cancelled_contract_fee_tax` CTE itself remaining commented out. This introduces a potential bug where `ccft.cancelled_fee_tax_total` will always be `0` or cause an error if `ccft` is not defined.

*   **1/21/2026, 4:27:14 PM:** In `contract_tax_totals`, the `COALESCE(ccft.cancelled_fee_tax_total, 0)` part is commented out again, indicating the previous change was erroneous given that `cancelled_contract_fee_tax` CTE is still commented out.

*   **1/21/2026, 4:27:46 PM:** No functional change is observed in the provided snippet.

*   **1/21/2026, 4:29:42 PM:** In `contract_tax_totals`, the `COALESCE(ccft.cancelled_fee_tax_total, 0)` part is completely removed from the calculation (not just commented out), and the line now simply sums `cft.contract_fee_tax_total` and `dft.deed_fee_tax_total`. This suggests a decision to entirely exclude cancelled fees from the total tax for now.

*   **1/21/2026, 4:31:12 PM:** The hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '110814'` filter in the `base_contracts` CTE's `WHERE` clause is **commented out**, and the original date range filtering logic is **uncommented and reinstated**. This returns the query to its intended date-range-based filtering behavior.

*   **1/21/2026, 4:32:48 PM:** The final `SELECT` statement now includes all previously truncated fields (e.g., `OC_Owned`, `Other_Merchandise_Owned`, `Other_Services_Owned`, `Private_Estates_Owned`, `Urns_Owned`, `Vaults_Owned`) and adds the necessary `LEFT JOIN` clauses for `item_counts`, `contract_net_prices`, `facility_dim`, `contract_writers`, and `deceased_contacts` to the `primary_contacts` base. This completes the SQL query.

**2. `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**
This file handles the synchronization of PlotBox data to HubSpot CRM.

*   **1/21/2026, 12:54:56 PM (Initial State):** The `syncPlotBoxData` method includes a `dd($dealsBatch)` call, which is a Laravel helper for "dump and die," effectively halting execution for debugging purposes.

*   **1/22/2026, 11:19:31 AM:** The `dd($dealsBatch)` line is **removed**. This suggests that the debugging step was completed, and the full synchronization logic can now proceed.

*   **1/22/2026, 11:24:34 AM:** The `dd($dealsBatch)` line is **re-added**. This indicates a reversion, likely due to needing to debug the `dealsBatch` again, or possibly a mistaken revert during another change.

*   **1/22/2026, 11:25:42 AM:** The `dd($dealsBatch)` line is **removed again**. This confirms that the debugging of `dealsBatch` was either temporary or completed and no longer needed for the full sync process.

**Timestamps of Significant Changes:**

*   **1/21/2026, 12:52:00 PM:** Introduction of a hardcoded contract number filter in `Contact.php`, temporarily disabling date range filtering.
*   **1/21/2026, 3:57:10 PM:** Commenting out of the `cancelled_contract_fee_tax` CTE in `Contact.php`.
*   **1/21/2026, 4:05:53 PM:** Correction of `TAX_AMOUNT` reference in `contract_fee_tax` and `deed_fee_tax` CTEs in `Contact.php`.
*   **1/21/2026, 4:16:07 PM:** Further correction in `deed_fee_tax` and case-sensitivity fix for `FEE_TYPE` in `Contact.php`.
*   **1/21/2026, 4:20:08 PM:** Introduction of `CAST(... AS INT)` and change in hardcoded contract number in `Contact.php`.
*   **1/21/2026, 4:23:56 PM:** Minor syntax adjustment (and probable error) in `CAST` usage in `Contact.php`.
*   **1/21/2026, 4:26:14 PM:** Removal of `CAST(... AS INT)` from `WHERE` clauses in `Contact.php`.
*   **1/21/2026, 4:26:47 PM:** Erroneous uncommenting of `ccft.cancelled_fee_tax_total` in `contract_tax_totals` in `Contact.php`.
*   **1/21/2026, 4:27:14 PM:** Re-commenting of `ccft.cancelled_fee_tax_total` in `Contact.php`.
*   **1/21/2026, 4:29:42 PM:** Permanent removal of `ccft.cancelled_fee_tax_total` from `contract_tax_totals` calculation in `Contact.php`.
*   **1/21/2026, 4:31:12 PM:** Reinstatement of date range filtering in `Contact.php` and removal of hardcoded contract number.
*   **1/21/2026, 4:32:48 PM:** Completion of the SQL query's `SELECT` statement and `JOIN` clauses in `Contact.php`.
*   **1/22/2026, 11:19:31 AM:** Removal of `dd($dealsBatch)` from `PlotBoxHubSpotService.php`.
*   **1/22/2026, 11:24:34 AM:** Re-introduction of `dd($dealsBatch)` in `PlotBoxHubSpotService.php`.
*   **1/22/2026, 11:25:42 AM:** Final removal of `dd($dealsBatch)` from `PlotBoxHubSpotService.php`.

**Patterns or Recurring Elements in the Content:**

*   **Repeated SQL Query Structure:** The SQL query within `getDataWithDateRange` in `Contact.php` is consistently complex, involving multiple Common Table Expressions (CTEs) like `base_contracts`, `payment_schedule_totals`, `contract_fee_tax`, `deed_fee_tax`, `cancelled_contract_fee_tax`, `contract_tax_totals`, `contract_net_prices`, `contract_writers`, `item_counts`, `primary_contacts`, and `deceased_contacts`.
*   **Debugging Interventions:** Frequent commenting/uncommenting of the date filter in `Contact.php` to hardcode specific contract numbers, and the addition/removal of `dd($dealsBatch)` in `PlotBoxHubSpotService.php`, indicate an iterative debugging process.
*   **Incremental Refinement of SQL:** The changes to `Contact.php` show a clear pattern of refining the SQL query: initially commenting out parts for testing, then re-enabling them, fixing subtle bugs (like `TAX_AMOUNT` alias and `FEE_TYPE` case), experimenting with type casting, and eventually finalizing the query with all necessary joins and selected fields.
*   **Focus on Tax and Item Calculation:** Several CTEs (e.g., `contract_fee_tax`, `deed_fee_tax`, `cancelled_contract_fee_tax`, `contract_tax_totals`, `item_counts`) and their subsequent modifications highlight an ongoing effort to accurately calculate various financial and inventory-related metrics.
*   **Data Synchronization to HubSpot:** The `PlotBoxHubSpotService.php` consistently aims to synchronize PlotBox data, mapping contacts, deceased contacts, and deals to HubSpot, including associations with locations. The repeated `dd($dealsBatch)` suggests issues or verification steps around the deal mapping or processing.

## 4:29:29 AM
The changes primarily revolve around two files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`.

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` (Multiple timestamps between 1/21/2026, 12:51:05 PM and 1/22/2026, 2:29:50 PM):**
    *   This file, a Laravel Eloquent model for `Contact` within the `PlotBox` namespace, contains a `getDataWithDateRange` static method responsible for querying contract and contact data from a Snowflake warehouse.
    *   **Recurring Changes in SQL Query:** The most significant and frequent changes within this file involve the SQL query embedded in the `getDataWithDateRange` method.
        *   **Initial State (1/21/2026, 12:51:05 PM):** The `base_contracts` CTE included a date range filter: `(CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN '{$fromDate}' AND '{$toDate}' OR EXISTS (...) )`. A `cancelled_contract_fee_tax` CTE was present and included in the `contract_tax_totals`.
        *   **Temporary Hardcoding and Commenting (1/21/2026, 12:52:00 PM to 1/21/2026, 1:37:28 PM):** The date range filter in `base_contracts` was commented out and replaced with a hardcoded `WHERE DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'`. The `cancelled_contract_fee_tax` CTE remained uncommented and included. The `SELECT` statement in `contract_net_prices` for `total_cash_price` also saw `pc.TOTAL_CASH_PRICE` temporarily removed in favor of `0` in `COALESCE` statements for `Purchase_Price`.
        *   **Commenting out `cancelled_contract_fee_tax` (1/21/2026, 3:57:10 PM):** The entire `cancelled_contract_fee_tax` CTE was commented out. Consequently, its inclusion in the `contract_tax_totals` CTE (`COALESCE(ccft.cancelled_fee_tax_total, 0)`) was also commented out.
        *   **Corrections in `SUM` aggregates (1/21/2026, 4:05:53 PM):** In `contract_fee_tax` and `deed_fee_tax` CTEs, the `SUM` aggregate changed from `SUM(f.TAX_AMOUNT * cf.QUANTITY)` to `SUM(cf.TAX_AMOUNT * cf.QUANTITY)` and `SUM(df.TAX_AMOUNT * df.QUANTITY)` respectively. This indicates a potential bug fix or clarification in how tax amounts were calculated.
        *   **Case Sensitivity Fix for 'Interest' (1/21/2026, 4:16:07 PM):** The `LOWER(f.FEE_TYPE) != 'interest'` condition was updated to `LOWER(f.FEE_TYPE) != 'Interest'`, correcting the case for the literal string.
        *   **Type Casting in `WHERE IN` clauses (1/21/2026, 4:20:08 PM):** `WHERE cf.CONTRACT_ID IN (SELECT CONTRACT_ID FROM base_contracts)` was changed to `WHERE cf.CONTRACT_ID IN (CAST(SELECT CONTRACT_ID FROM base_contracts AS INT))`, and similar for `deed_fee_tax` and `cancelled_contract_fee_tax` (even though the latter was commented out). This suggests issues with data types in the subqueries.
        *   **Contract Number Shortening (1/21/2026, 4:20:13 PM):** The hardcoded `DIM_CONTRACT.CONTRACT_NUMBER` filter changed from `'645-110814'` to `'110814'`.
        *   **Removal of `CAST` in `WHERE IN` (1/21/2026, 4:26:14 PM):** The `CAST(SELECT CONTRACT_ID FROM base_contracts AS INT)` was reverted back to `(SELECT CONTRACT_ID FROM base_contracts)`, suggesting the type casting was not necessary or caused other issues.
        *   **Re-commenting tax total (1/21/2026, 4:27:14 PM - 4:29:42 PM):** The `COALESCE(ccft.cancelled_fee_tax_total, 0)` line in `contract_tax_totals` was further commented out in various ways (e.g., `//+ // COALESCE(ccft.cancelled_fee_tax_total, 0) AS total_tax` then `as total_tax //+ // COALESCE(ccft.cancelled_fee_tax_total, 0) AS total_tax`).
        *   **Reinstatement of Date Range Filter (1/21/2026, 4:31:12 PM):** The original date range filter `(CAST(DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC AS DATE) BETWEEN '{$fromDate}' AND '{$toDate}' OR EXISTS (...))` was uncommented, replacing the hardcoded contract number.
        *   **Final SQL Structure Refinement (1/22/2026, 11:24:20 AM - 11:25:33 AM):** The `contract_tax_totals` CTE was simplified to sum only `contract_fee_tax_total` and `deed_fee_tax_total`, permanently removing the `cancelled_fee_tax_total`. The main `SELECT` statement in `getDataWithDateRange` now explicitly joins `primary_contacts` with `deceased_contacts`, `contract_writers`, `item_counts`, and `dim_facility`. The previous code ended abruptly mid-line for this `SELECT` statement.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (Multiple timestamps between 1/21/2026, 12:54:56 PM and 1/22/2026, 11:25:42 AM):**
    *   This service handles syncing PlotBox data to HubSpot.
    *   **Debugging `dd($dealsBatch)` (1/21/2026, 12:54:56 PM and 1/22/2026, 11:24:34 AM):** A `dd($dealsBatch)` (dump and die) statement was temporarily added to halt execution and inspect the `$dealsBatch` variable, likely for debugging purposes, and then removed in a subsequent commit.

**Timestamps of Significant Changes:**

*   **1/21/2026, 12:51:05 PM:** Initial version of the `Contact.php` query, including date range and cancelled fees.
*   **1/21/2026, 12:52:00 PM:** Start of hardcoding a contract number and commenting out the date filter in `Contact.php`, indicating testing/debugging of a specific contract.
*   **1/21/2026, 12:54:56 PM:** Addition of `dd($dealsBatch)` in `PlotBoxHubSpotService.php`, confirming active debugging of the data processing flow.
*   **1/21/2026, 3:57:10 PM:** `cancelled_contract_fee_tax` CTE and its usage were fully commented out in `Contact.php`, suggesting this fee type was being temporarily or permanently excluded from calculations.
*   **1/21/2026, 4:05:53 PM & 4:16:07 PM:** Minor corrections to tax calculation (variable `f.TAX_AMOUNT` vs `cf.TAX_AMOUNT`/`df.TAX_AMOUNT`) and string case in `Contact.php`.
*   **1/21/2026, 4:20:08 PM & 4:26:14 PM:** Experimentation with explicit `CAST` to `INT` in subqueries in `Contact.php`, then reverted, indicating type mismatch or parsing issues were being investigated.
*   **1/21/2026, 4:31:12 PM:** Reinstatement of the original date range filter in `Contact.php`, signifying the end of the specific contract number debugging.
*   **1/22/2026, 11:24:20 AM:** The `cancelled_contract_fee_tax` CTE was completely removed (not just commented out), and the final `SELECT` clause in `Contact.php` was properly concluded and formatted with explicit joins. This suggests a more permanent change to the data aggregation logic.
*   **1/22/2026, 11:24:34 AM:** The `dd($dealsBatch)` was re-introduced in `PlotBoxHubSpotService.php`, restarting the debugging of the data mapping/processing.
*   **1/22/2026, 11:25:33 AM & 11:25:42 AM:** Removal of `dd($dealsBatch)` in `PlotBoxHubSpotService.php`, indicating debugging on the HubSpot service side was potentially resolved or paused. The `Contact.php` update at 11:25:33 AM appears to be identical to the 11:24:20 AM version, possibly a re-save or minor formatting adjustment.

**Patterns and Recurring Elements:**

*   **Debugging Focus:** A strong pattern of active debugging is evident. The `Contact.php` file shows repeated commenting/uncommenting of the date filter and hardcoding specific contract IDs for testing the SQL query. The `PlotBoxHubSpotService.php` file shows the repeated use of `dd($dealsBatch)` for inspecting data batches.
*   **SQL Query Refinement:** Significant effort was spent refining the complex SQL query within `getDataWithDateRange` in `Contact.php`. This included adjustments to `WHERE` clauses (date range vs. specific contract number), calculation of `total_tax` (especially concerning `cancelled_contract_fee_tax`), and type casting.
*   **Incremental Saves:** Multiple timestamps for `Contact.php` within very short periods (e.g., 12:51, 12:52, 12:54 PM) suggest frequent saving of changes during development or debugging sessions.
*   **Data Integration (PlotBox to HubSpot):** The `PlotBoxHubSpotService` aims to sync data from a PlotBox warehouse to HubSpot, involving mapping contacts, deceased contacts, and deals, and then associating them with locations.
*   **Error Handling and Logging:** Both files include `Log::error` and `Log::info` statements, demonstrating a practice of logging important events and errors, especially in the `PlotBoxHubSpotService`.
*   **SQL Structure (Snowflake):** The SQL queries consistently target tables within `PLOTBOX_WAREHOUSE.WAREHOUSE_EVERSTORYPARTNERS`, indicating a specific data warehousing environment (Snowflake) for PlotBox data.
*   **Eloquent Model (`Contact.php`):** The `Contact` model defines standard Eloquent relationships (`hasMany`, `belongsToMany`) and `fillable` properties, typical for a Laravel application interacting with a database.