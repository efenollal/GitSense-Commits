# Activity Summary for 1/27/2026

## 12:38:00 AM
The following summarizes the key changes from the provided code log:

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` (Multiple timestamps from 1/21/2026 to 1/22/2026):**
    *   This file, a Laravel Eloquent Model for `Contact` within the `PlotBox` namespace, consistently defines database connection (`snowflake`), table (`PLOTBOX_WAREHOUSE.WAREHOUSE_EVERSTORYPARTNERS.DIM_CONTACT`), primary key (`CONTACT_KEY`), and fillable attributes.
    *   It includes Eloquent relationships for `contractOwners` (hasMany) and `contracts` (belongsToMany).
    *   The core of the changes revolve around the `getDataWithDateRange` static method, which executes a complex SQL query to retrieve contact and contract data from a Snowflake warehouse.
    *   **SQL Query Evolution:**
        *   **1/21/2026, 12:51:05 PM (Initial State):** The `base_contracts` CTE's `WHERE` clause includes a date range filter on `DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC` and `DIM_CONTACT.LAST_UPDATED_DATETIME`, with a production-only `DIM_CONTRACT.STATUS = 'Approved'` filter. It also includes a `cancelled_contract_fee_tax` CTE and references `ccft.cancelled_fee_tax_total` in `contract_tax_totals`.
        *   **1/21/2026, 12:52:00 PM to 1/21/2026, 1:37:28 PM:** The primary date range filtering condition in the `base_contracts` CTE is commented out, replaced by a hardcoded `WHERE DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'`. The `cancelled_contract_fee_tax` CTE remains active and contributes to `contract_tax_totals`.
        *   **1/21/2026, 3:57:10 PM:** The `cancelled_contract_fee_tax` CTE is commented out, and its reference in `contract_tax_totals` (`COALESCE(ccft.cancelled_fee_tax_total, 0)`) is also commented out (or removed, depending on interpretation of partial code). The hardcoded `CONTRACT_NUMBER` filter remains.
        *   **1/21/2026, 4:05:53 PM:** Small change in `contract_fee_tax` and `deed_fee_tax` CTEs: `SUM(f.TAX_AMOUNT * cf.QUANTITY)` was changed to `SUM(cf.TAX_AMOUNT * cf.QUANTITY)` and `SUM(f.TAX_AMOUNT * df.QUANTITY)` to `SUM(cf.TAX_AMOUNT * df.QUANTITY)`. This looks like a potential copy-paste error where `f.TAX_AMOUNT` should likely be used in `deed_fee_tax` as well.
        *   **1/21/2026, 4:16:07 PM:** Corrected the `SUM` calculation in `deed_fee_tax` back to `SUM(df.TAX_AMOUNT * df.QUANTITY)`. The `cancelled_contract_fee_tax` CTE remains commented out. Changed `LOWER(f.FEE_TYPE) != 'interest'` to `LOWER(f.FEE_TYPE) != 'Interest'` (capital I).
        *   **1/21/2026, 4:20:08 PM:** Added `CAST(... AS INT)` around `SELECT CONTRACT_ID FROM base_contracts` in the `WHERE cf.CONTRACT_ID IN (...)` and `WHERE df.CONTRACT_ID IN (...)` clauses of `contract_fee_tax` and `deed_fee_tax` CTEs, and similarly for the commented-out `cancelled_contract_fee_tax` CTE.
        *   **1/21/2026, 4:20:13 PM:** Changed the hardcoded `CONTRACT_NUMBER` filter in `base_contracts` from `'645-110814'` to `'110814'`.
        *   **1/21/2026, 4:23:56 PM:** Removed `CAST(... AS INT)` around `SELECT CONTRACT_ID FROM base_contracts` in `deed_fee_tax` CTE (`WHERE df.CONTRACT_ID IN SELECT CONTRACT_ID FROM base_contracts AS INT)` -> likely a syntax error that was introduced). The `contract_fee_tax` CTE still has `CAST`.
        *   **1/21/2026, 4:26:14 PM:** Corrected the syntax error in `deed_fee_tax` by removing `AS INT)` from `(SELECT CONTRACT_ID FROM base_contracts AS INT)`. Also removed `CAST` from `contract_fee_tax`. So, the `CAST` operations added earlier were reverted.
        *   **1/21/2026, 4:26:47 PM:** In `contract_tax_totals`, the `COALESCE(ccft.cancelled_fee_tax_total, 0)` was uncommented, but `cancelled_contract_fee_tax` CTE remains commented out, leading to a potential SQL error.
        *   **1/21/2026, 4:27:14 PM:** The `COALESCE(ccft.cancelled_fee_tax_total, 0)` line in `contract_tax_totals` was commented out again.
        *   **1/21/2026, 4:27:46 PM:** The `total_tax` calculation in `contract_tax_totals` was slightly rearranged for `COALESCE(cft.cancelled_fee_tax_total, 0)`. It appears there was an attempt to add it back without the CTE being active, resulting in a syntax error (`//+ // COALESCE...`).
        *   **1/21/2026, 4:31:12 PM:** The hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '110814'` filter was commented out, and the original date range filter on `LAST_UPDATED_DATE_TIME_UTC` for `DIM_CONTRACT` and `DIM_CONTACT` was reinstated. The `COALESCE(ccft.cancelled_fee_tax_total, 0)` in `contract_tax_totals` remains commented out.
        *   **1/22/2026, 11:24:20 AM:** The `cancelled_contract_fee_tax` CTE block is completely removed from the SQL query (it was previously commented out). Consequently, its reference (`COALESCE(ccft.cancelled_fee_tax_total, 0)`) is also removed from `contract_tax_totals`. The final `SELECT` statement also shows a complete set of joins for `df`, `cnp`, `cw`, `ic`.
    *   **Final `SELECT` clause in `getDataWithDateRange`:** Over the course of the changes, the `SELECT` clause consistently returns a wide array of contact, contract, and item-related fields, including calculated net price and aggregated item counts by category. The joins to `DIM_FACILITY`, `contract_net_prices`, `contract_writers`, and `item_counts` are present in all logs.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (1/21/2026, 12:54:56 PM to 1/22/2026, 11:25:42 AM):**
    *   This service is responsible for syncing PlotBox data to HubSpot.
    *   The `syncPlotBoxData` method fetches data using `getDataForCrmSync`, maps it to CRM objects (`mapContact`, `mapDeceasedContact`, `mapDeal`), and then processes them in batches.
    *   It uses `HubSpotContactService`, `HubSpotDealService`, and `HubSpotLocationService` for CRM interactions.
    *   **Timestamp 1/21/2026, 12:54:56 PM:** Includes a `dd($dealsBatch)` call, which would halt execution and dump the `dealsBatch` variable. This indicates a debugging step.
    *   **Timestamp 1/22/2026, 11:19:31 AM:** The `dd($dealsBatch)` debugging line was removed.
    *   **Timestamp 1/22/2026, 11:24:34 AM:** The `dd($dealsBatch)` debugging line was re-added.
    *   **Timestamp 1/22/2026, 11:25:42 AM:** The `dd($dealsBatch)` debugging line was removed again.

**Timestamps of Significant Changes:**

*   **1/21/2026, 12:52:00 PM - 1:37:28 PM:** Introduction and retention of a hardcoded `CONTRACT_NUMBER` filter in the SQL query within `Contact.php`, temporarily disabling the date range filter.
*   **1/21/2026, 3:57:10 PM:** Removal/commenting out of the `cancelled_contract_fee_tax` CTE in `Contact.php`, signifying a change in tax calculation logic or data source.
*   **1/21/2026, 4:05:53 PM & 4:16:07 PM:** Minor corrections to `SUM` aggregation logic and case sensitivity for `FEE_TYPE` in `Contact.php`.
*   **1/21/2026, 4:20:08 PM - 4:26:14 PM:** Introduction and subsequent removal/correction of `CAST(... AS INT)` statements for subqueries in `Contact.php`'s SQL, suggesting experimentation with data type handling.
*   **1/21/2026, 4:26:47 PM - 4:27:46 PM:** Brief re-introduction and then re-commenting/mis-handling of `cancelled_fee_tax_total` in `contract_tax_totals` in `Contact.php`.
*   **1/21/2026, 4:31:12 PM:** Reversion to the original date range filtering logic in `Contact.php`'s SQL, removing the hardcoded contract number.
*   **1/22/2026, 11:19:31 AM:** Removal of the `dd($dealsBatch)` debug statement in `PlotBoxHubSpotService.php`.
*   **1/22/2026, 11:24:20 AM:** Final removal of `cancelled_contract_fee_tax` CTE in `Contact.php`.
*   **1/22/2026, 11:24:34 AM & 11:25:42 AM:** Toggling of the `dd($dealsBatch)` debug statement in `PlotBoxHubSpotService.php`, indicating active debugging sessions.

**Patterns and Recurring Elements:**

*   **Consistent File Modification:** The `Contact.php` model is the primary target for changes, particularly its `getDataWithDateRange` method and the complex SQL query it contains. This suggests ongoing development or refinement of data retrieval for PlotBox contacts and contracts.
*   **SQL Query Refinement:** There's a clear pattern of iterative development and debugging within the embedded SQL query:
    *   Toggling between dynamic date filters and hardcoded contract IDs for testing.
    *   Commenting out/uncommenting/removing specific CTEs (e.g., `cancelled_contract_fee_tax`) and their references, indicating adjustments to how total tax or other financial metrics are calculated.
    *   Minor syntax adjustments and type casting experiments within the SQL.
*   **Debugging Practices:** The repeated addition and removal of `dd($dealsBatch)` in `PlotBoxHubSpotService.php` highlights a pattern of using `var_dump` or `die` style debugging during development.
*   **Data Synchronization Context:** Both files are related to a "datalink" project, with `Contact.php` serving as a data source from `PlotBox_WAREHOUSE` and `PlotBoxHubSpotService.php` handling the synchronization of this data to HubSpot, suggesting an ETL (Extract, Transform, Load) or data integration pipeline.
*   **Snowflake Database:** The explicit `const CONNECTION = 'snowflake'` in `Contact.php` indicates the use of Snowflake as the data warehouse.
*   **Error Handling and Logging:** Both `Contact.php` (implicitly via `Log::error` in the service) and `PlotBoxHubSpotService.php` utilize `Illuminate\Support\Facades\Log` for error reporting, indicating robust error handling in the application.
*   **Partial Code Logs:** Many entries for `Contact.php` end abruptly, indicated by `----------------------------------------`, which suggests the log is showing only a segment of the file, but the start and context of changes are usually clear.

## 1:37:57 AM
The provided log details changes across two PHP files: `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` and `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`.

### File-Specific Updates:

1.  **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
    *   **Timestamp:** Changes occurred frequently between 1/21/2026, 12:51:05 PM and 1/22/2026, 2:29:50 PM.
    *   **Initial State (1/21/2026, 12:51:05 PM):** The `getDataWithDateRange` method contains a complex SQL query. The `WHERE` clause in the `base_contracts` CTE filters records based on `LAST_UPDATED_DATE_TIME_UTC` or `LAST_UPDATED_DATETIME` within a specified date range (`$fromDate` and `$toDate`). A `contractStatusFilter` is applied conditionally for 'production' environment. It also includes a `cancelled_contract_fee_tax` CTE which is then used in `contract_tax_totals`.
    *   **Changes around 1/21/2026, 12:52:00 PM - 1:37:28 PM:**
        *   The original date range filter in the `base_contracts` CTE's `WHERE` clause was commented out.
        *   A hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'` filter was introduced in the `base_contracts` CTE, effectively limiting data retrieval to a specific contract for testing or debugging.
        *   The line `COALESCE(cnp.net_price, pc.TOTAL_CASH_PRICE, 0)` in the final `SELECT` statement was changed to `COALESCE(cnp.net_price, 0)`. This removes `pc.TOTAL_CASH_PRICE` as a fallback for `net_price`.
    *   **Changes around 1/21/2026, 3:57:10 PM - 4:16:07 PM:**
        *   The `cancelled_contract_fee_tax` CTE was commented out.
        *   Consequently, the `COALESCE(ccft.cancelled_fee_tax_total, 0)` part was commented out in the `contract_tax_totals` CTE, removing the cancelled fees from the total tax calculation.
        *   A minor change in the `LOWER(f.FEE_TYPE) != 'interest'` condition was made in `contract_fee_tax` and `deed_fee_tax` CTEs: 'interest' became 'Interest' (capitalized 'I').
        *   A significant change was made to the `SUM` aggregation in `contract_fee_tax` and `deed_fee_tax` CTEs: `SUM(f.TAX_AMOUNT * cf.QUANTITY)` was changed to `SUM(cf.TAX_AMOUNT * cf.QUANTITY)` and `SUM(df.TAX_AMOUNT * df.QUANTITY)`, respectively. This implies `TAX_AMOUNT` is now expected on `DIM_CONTRACT_FEE` and `DIM_DEED_FEE` tables instead of `DIM_FEE`.
    *   **Changes around 1/21/2026, 4:20:08 PM - 4:20:13 PM:**
        *   The `WHERE` clause in `contract_fee_tax`, `deed_fee_tax`, and the commented-out `cancelled_contract_fee_tax` CTEs was modified to include `CAST(... AS INT)` around `(SELECT CONTRACT_ID FROM base_contracts)`.
        *   The hardcoded `CONTRACT_NUMBER` filter in `base_contracts` was changed from `'645-110814'` to `'110814'`.
    *   **Changes around 1/21/2026, 4:23:56 PM:**
        *   The `CAST(... AS INT)` was removed from `deed_fee_tax` CTE, and the subquery syntax was slightly altered (missing parentheses around the subquery). This is likely an error.
    *   **Changes around 1/21/2026, 4:26:14 PM - 4:27:14 PM:**
        *   The `CAST(... AS INT)` in `contract_fee_tax`, `deed_fee_tax` (and implicitly `cancelled_contract_fee_tax` if uncommented) was removed.
        *   The commented-out line `COALESCE(ccft.cancelled_fee_tax_total, 0)` within the `total_tax` calculation in `contract_tax_totals` was further commented out or partially removed, suggesting a shift away from including cancelled fees in the tax total.
    *   **Changes around 1/21/2026, 4:27:46 PM:**
        *   The `total_tax` calculation in `contract_tax_totals` was explicitly simplified to `COALESCE(cft.contract_fee_tax_total, 0) + COALESCE(dft.deed_fee_tax_total, 0)` with the `cancelled_fee_tax_total` line fully commented out.
    *   **Changes around 1/21/2026, 4:31:12 PM - 4:32:48 PM:**
        *   The hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '110814'` filter in `base_contracts` was commented out.
        *   The original date range filter based on `LAST_UPDATED_DATE_TIME_UTC` or `LAST_UPDATED_DATETIME` between `$fromDate` and `$toDate` was restored, making the `getDataWithDateRange` method functional with date inputs again.
        *   The `cancelled_contract_fee_tax` CTE remained commented out, and its inclusion in `contract_tax_totals` also remained commented out.
    *   **Final change on 1/22/2026, 11:24:20 AM - 11:25:33 AM:**
        *   The previously commented-out `cancelled_contract_fee_tax` CTE and its reference in `contract_tax_totals` were completely removed, solidifying the exclusion of cancelled contract fees from total tax calculations.
        *   The final `SELECT` statement had its `LEFT JOIN` clauses fixed and extended to correctly join `item_counts`, `facility_dimension_details`, etc. This looks like a completion of the SQL query.

2.  **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**
    *   **Timestamp:** 1/21/2026, 12:54:56 PM and 1/22/2026, 11:19:31 AM, 11:24:34 AM, 11:25:42 AM.
    *   **Initial State (1/21/2026, 12:54:56 PM):** This service handles syncing PlotBox data to HubSpot. It initializes various HubSpot services and a data mapper. The `syncPlotBoxData` method retrieves data, maps it, and then processes primary contacts, deceased contacts, and deals, attempting to create associations.
    *   **Change at 1/22/2026, 11:19:31 AM:** A `dd($dealsBatch)` line (Laravel's "dump and die" debugging function) was present after populating the batch arrays but before the actual processing logic. This line was removed, indicating the completion of a debugging phase and allowing the sync process to continue.
    *   **Subsequent changes at 1/22/2026, 11:24:34 AM and 11:25:42 AM:** The `dd($dealsBatch)` line reappears at the exact same location, indicating a reintroduction of debugging or an accidental revert/re-save. This suggests an iterative debugging cycle for the HubSpot sync logic.

### Patterns and Recurring Elements:

*   **Iterative Debugging and Refinement:** The `Contact.php` file shows a clear pattern of incrementally modifying a large SQL query. This includes:
    *   Commenting out and re-enabling date filters.
    *   Introducing and removing hardcoded contract numbers for specific testing.
    *   Commenting out and eventually removing a CTE (`cancelled_contract_fee_tax`) and its related calculations.
    *   Correcting column references for `TAX_AMOUNT` and `CONTRACT_ID` casting in SQL.
    *   Repeated partial saves of the file (`Contact.php`) with minor changes, often only a few seconds or minutes apart, especially during the 4:00 PM hour on 1/21/2026. This strongly suggests rapid development and testing cycles.
*   **HubSpot Integration Focus:** The `PlotBoxHubSpotService.php` file focuses on the data synchronization process with HubSpot, specifically handling contacts (primary and deceased), deals, and location associations. The `dd($dealsBatch)` appearance and disappearance further emphasizes active development and debugging of this integration.
*   **Data Transformation Logic:** Both files are deeply involved in data transformation. `Contact.php` defines the source data extraction (SQL query), while `PlotBoxHubSpotService.php` uses a mapper (`PlotBoxDataToCrmMapper`) to prepare this data for a CRM system (HubSpot).
*   **Robustness with Try-Catch:** The `PlotBoxHubSpotService.php` uses `try-catch` blocks extensively around different processing stages (primary contacts, deceased contacts, associations, deals, location associations) to ensure resilience and allow for partial processing even if certain steps fail.
*   **Logging:** `Log::error` and `Log::info` calls are consistently used in `PlotBoxHubSpotService.php` for tracking execution and troubleshooting errors.
*   **Fixed Date:** All timestamps are consistently from 2026, specifically January 21st and 22nd, indicating changes made within a two-day period.