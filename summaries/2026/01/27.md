# Activity Summary for 1/27/2026

## 12:38:00 AM
The following summarizes the key changes from the provided code log:

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` (Multiple timestamps from 1/21/2026 to 1/22/2026):**
    *   This file, a Laravel Eloquent Model for `Contact` within the `PlotBox` namespace, consistently defines database connection (`snowflake`), table (`PLOTBOX_WAREHOUSE.WAREHOUSE_EVERSTORYPARTNERS.DIM_CONTACT`), primary key (`CONTACT_KEY`), and fillable attributes.
    *   It includes Eloquent relationships for `contractOwners` (hasMany) and `contracts` (belongsToMany).
    *   The core of the changes revolve around the `getDataWithDateRange` static method, which executes a complex SQL query to retrieve contact and contract data from a Snowflake warehouse.
    *   **SQL Query Evolution:**
        *   **1/21/2026, 12:51:05 PM (Initial State):** The `base_contracts` CTE's `WHERE` clause includes a date range filter on `DIM_CONTRACT.LAST_UPDATED_DATE_TIME_UTC` and `DIM_CONTACT.LAST_UPDATED_DATETIME`, with a production-only `DIM_CONTRACT.STATUS = 'Approved'` filter. It also includes a `cancelled_contract_fee_tax` CTE and references `ccft.cancelled_fee_tax_total` in `contract_tax_totals`.
        *   **1/21/2026, 12:52:00 PM to 1/21/2026, 1:37:28 PM:** The primary date range filtering condition in the `base_contracts` CTE is commented out, replaced by a hardcoded `WHERE DIM_CONTRACT.CONTRACT_NUMBER = '645-110814'`. The `cancelled_contract_fee_tax` CTE remains active and contributes to `contract_tax_totals`.
        *   **1/21/2026, 3:57:10 PM:** The `cancelled_contract_fee_tax` CTE is commented out, and its reference in `contract_tax_totals` (`COALESCE(ccft.cancelled_fee_tax_total, 0)`) is also commented out (or removed, depending on interpretation of partial code). The hardcoded `CONTRACT_NUMBER` filter remains.
        *   **1/21/2026, 4:05:53 PM:** Small change in `contract_fee_tax` and `deed_fee_tax` CTEs: `SUM(f.TAX_AMOUNT * cf.QUANTITY)` was changed to `SUM(cf.TAX_AMOUNT * cf.QUANTITY)` and `SUM(f.TAX_AMOUNT * df.QUANTITY)` to `SUM(cf.TAX_AMOUNT * df.QUANTITY)`. This looks like a potential copy-paste error where `f.TAX_AMOUNT` should likely be used in `deed_fee_tax` as well.
        *   **1/21/2026, 4:16:07 PM:** Corrected the `SUM` calculation in `deed_fee_tax` back to `SUM(df.TAX_AMOUNT * df.QUANTITY)`. The `cancelled_contract_fee_tax` CTE remains commented out. Changed `LOWER(f.FEE_TYPE) != 'interest'` to `LOWER(f.FEE_TYPE) != 'Interest'` (capital I).
        *   **1/21/2026, 4:20:08 PM:** Added `CAST(... AS INT)` around `SELECT CONTRACT_ID FROM base_contracts` in the `WHERE cf.CONTRACT_ID IN (...)` and `WHERE df.CONTRACT_ID IN (...)` clauses of `contract_fee_tax` and `deed_fee_tax` CTEs, and similarly for the commented-out `cancelled_contract_fee_tax` CTE.
        *   **1/21/2026, 4:20:13 PM:** Changed the hardcoded `CONTRACT_NUMBER` filter in `base_contracts` from `'645-110814'` to `'110814'`.
        *   **1/21/2026, 4:23:56 PM:** Removed `CAST(... AS INT)` around `SELECT CONTRACT_ID FROM base_contracts` in `deed_fee_tax` CTE (`WHERE df.CONTRACT_ID IN SELECT CONTRACT_ID FROM base_contracts AS INT)` -> likely a syntax error that was introduced). The `contract_fee_tax` CTE still has `CAST`.
        *   **1/21/2026, 4:26:14 PM:** Corrected the syntax error in `deed_fee_tax` by removing `AS INT)` from `(SELECT CONTRACT_ID FROM base_contracts AS INT)`. Also removed `CAST` from `contract_fee_tax`. So, the `CAST` operations added earlier were reverted.
        *   **1/21/2026, 4:26:47 PM:** In `contract_tax_totals`, the `COALESCE(ccft.cancelled_fee_tax_total, 0)` was uncommented, but `cancelled_contract_fee_tax` CTE remains commented out, leading to a potential SQL error.
        *   **1/21/2026, 4:27:14 PM:** The `COALESCE(ccft.cancelled_fee_tax_total, 0)` line in `contract_tax_totals` was commented out again.
        *   **1/21/2026, 4:27:46 PM:** The `total_tax` calculation in `contract_tax_totals` was slightly rearranged for `COALESCE(cft.cancelled_fee_tax_total, 0)`. It appears there was an attempt to add it back without the CTE being active, resulting in a syntax error (`//+ // COALESCE...`).
        *   **1/21/2026, 4:31:12 PM:** The hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '110814'` filter was commented out, and the original date range filter on `LAST_UPDATED_DATE_TIME_UTC` for `DIM_CONTRACT` and `DIM_CONTACT` was reinstated. The `COALESCE(ccft.cancelled_fee_tax_total, 0)` in `contract_tax_totals` remains commented out.
        *   **1/22/2026, 11:24:20 AM:** The `cancelled_contract_fee_tax` CTE block is completely removed from the SQL query (it was previously commented out). Consequently, its reference (`COALESCE(ccft.cancelled_fee_tax_total, 0)`) is also removed from `contract_tax_totals`. The final `SELECT` statement also shows a complete set of joins for `df`, `cnp`, `cw`, `ic`.
    *   **Final `SELECT` clause in `getDataWithDateRange`:** Over the course of the changes, the `SELECT` clause consistently returns a wide array of contact, contract, and item-related fields, including calculated net price and aggregated item counts by category. The joins to `DIM_FACILITY`, `contract_net_prices`, `contract_writers`, and `item_counts` are present in all logs.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (1/21/2026, 12:54:56 PM to 1/22/2026, 11:25:42 AM):**
    *   This service is responsible for syncing PlotBox data to HubSpot.
    *   The `syncPlotBoxData` method fetches data using `getDataForCrmSync`, maps it to CRM objects (`mapContact`, `mapDeceasedContact`, `mapDeal`), and then processes them in batches.
    *   It uses `HubSpotContactService`, `HubSpotDealService`, and `HubSpotLocationService` for CRM interactions.
    *   **Timestamp 1/21/2026, 12:54:56 PM:** Includes a `dd($dealsBatch)` call, which would halt execution and dump the `dealsBatch` variable. This indicates a debugging step.
    *   **Timestamp 1/22/2026, 11:19:31 AM:** The `dd($dealsBatch)` debugging line was removed.
    *   **Timestamp 1/22/2026, 11:24:34 AM:** The `dd($dealsBatch)` debugging line was re-added.
    *   **Timestamp 1/22/2026, 11:25:42 AM:** The `dd($dealsBatch)` debugging line was removed again.

**Timestamps of Significant Changes:**

*   **1/21/2026, 12:52:00 PM - 1:37:28 PM:** Introduction and retention of a hardcoded `CONTRACT_NUMBER` filter in the SQL query within `Contact.php`, temporarily disabling the date range filter.
*   **1/21/2026, 3:57:10 PM:** Removal/commenting out of the `cancelled_contract_fee_tax` CTE in `Contact.php`, signifying a change in tax calculation logic or data source.
*   **1/21/2026, 4:05:53 PM & 4:16:07 PM:** Minor corrections to `SUM` aggregation logic and case sensitivity for `FEE_TYPE` in `Contact.php`.
*   **1/21/2026, 4:20:08 PM - 4:26:14 PM:** Introduction and subsequent removal/correction of `CAST(... AS INT)` statements for subqueries in `Contact.php`'s SQL, suggesting experimentation with data type handling.
*   **1/21/2026, 4:26:47 PM - 4:27:46 PM:** Brief re-introduction and then re-commenting/mis-handling of `cancelled_fee_tax_total` in `contract_tax_totals` in `Contact.php`.
*   **1/21/2026, 4:31:12 PM:** Reversion to the original date range filtering logic in `Contact.php`'s SQL, removing the hardcoded contract number.
*   **1/22/2026, 11:19:31 AM:** Removal of the `dd($dealsBatch)` debug statement in `PlotBoxHubSpotService.php`.
*   **1/22/2026, 11:24:20 AM:** Final removal of `cancelled_contract_fee_tax` CTE in `Contact.php`.
*   **1/22/2026, 11:24:34 AM & 11:25:42 AM:** Toggling of the `dd($dealsBatch)` debug statement in `PlotBoxHubSpotService.php`, indicating active debugging sessions.

**Patterns and Recurring Elements:**

*   **Consistent File Modification:** The `Contact.php` model is the primary target for changes, particularly its `getDataWithDateRange` method and the complex SQL query it contains. This suggests ongoing development or refinement of data retrieval for PlotBox contacts and contracts.
*   **SQL Query Refinement:** There's a clear pattern of iterative development and debugging within the embedded SQL query:
    *   Toggling between dynamic date filters and hardcoded contract IDs for testing.
    *   Commenting out/uncommenting/removing specific CTEs (e.g., `cancelled_contract_fee_tax`) and their references, indicating adjustments to how total tax or other financial metrics are calculated.
    *   Minor syntax adjustments and type casting experiments within the SQL.
*   **Debugging Practices:** The repeated addition and removal of `dd($dealsBatch)` in `PlotBoxHubSpotService.php` highlights a pattern of using `var_dump` or `die` style debugging during development.
*   **Data Synchronization Context:** Both files are related to a "datalink" project, with `Contact.php` serving as a data source from `PlotBox_WAREHOUSE` and `PlotBoxHubSpotService.php` handling the synchronization of this data to HubSpot, suggesting an ETL (Extract, Transform, Load) or data integration pipeline.
*   **Snowflake Database:** The explicit `const CONNECTION = 'snowflake'` in `Contact.php` indicates the use of Snowflake as the data warehouse.
*   **Error Handling and Logging:** Both `Contact.php` (implicitly via `Log::error` in the service) and `PlotBoxHubSpotService.php` utilize `Illuminate\Support\Facades\Log` for error reporting, indicating robust error handling in the application.
*   **Partial Code Logs:** Many entries for `Contact.php` end abruptly, indicated by `----------------------------------------`, which suggests the log is showing only a segment of the file, but the start and context of changes are usually clear.