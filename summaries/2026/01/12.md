# Activity Summary for 1/12/2026

## 12:02:38 PM
The provided log outlines a series of changes focusing on HubSpot integration within a PHP application, particularly for managing contacts, deals, and locations related to "PlotBox" data.

### File-Specific Updates and Significant Timestamps:

#### `c:\Users\efeno\dev\datalink\app\SMCore\Services\Crm\Hubspot\HubSpotContactService.php`
- **1/2/2026, 11:41:48 AM (Initial state)**: This file defines `HubSpotContactService` implementing `CrmContactInterface`. It handles `createContact`, `updateContact`, and `associatePrimaryAndDeceasedContacts` operations with HubSpot's CRM Contact API. It removes certain properties (`loc_id`, `last_update_dt`, `exists`, `service_type_code`) before sending data to HubSpot. Error logging is robust, continuing processing even if individual contact operations fail.
- **1/2/2026, 12:01:48 PM**: A `dd($apiToken)` (die and dump) statement was temporarily added to the constructor for debugging purposes, indicating an issue or verification step during service instantiation.
- **1/2/2026, 12:03:11 PM**: The `dd($apiToken)` debugging statement was removed from the constructor, restoring the previous functionality.
- **1/2/2026, 12:16:54 PM**: The constructor's `$apiToken` parameter type hint was changed from `string` to `?string`, allowing the API token to be nullable, indicating a potential for optional API token configuration or graceful handling of its absence.
- **1/9/2026, 12:44:20 PM**: A `var_dump($contactProperties)` debugging statement was added within the `updateContact` method's `try` block, specifically before the HubSpot API update call. This suggests debugging efforts related to the data being sent for contact updates.
- **1/9/2026, 3:21:01 PM**: The `var_dump` statement added earlier in `updateContact` was removed, indicating the debugging step was completed.

#### `c:\Users\efeno\dev\datalink\app\SMCore\Services\Crm\Hubspot\HubSpotDealService.php`
- **1/2/2026, 11:41:59 AM (Initial state)**: This file defines `HubSpotDealService` implementing `CrmDealInterface`. It provides methods for `createDeal`, `updateDeal`, and `associateDealWithContact` using HubSpot's CRM Deals and Associations APIs. Similar to the Contact service, it removes specific properties (`loc_id`, `last_update_dt`, `exists`, `hmis_account_number`) before API calls and includes comprehensive error logging.
- **1/2/2026, 12:17:50 PM**: The constructor's `$apiToken` parameter type hint was changed from `string` to `?string`, mirroring the change in `HubSpotContactService` for consistency and flexibility.

#### `c:\Users\efeno\dev\datalink\app\SMCore\Services\Crm\Hubspot\HubSpotLocationService.php`
- **1/2/2026, 11:42:16 AM (Initial state)**: This file introduces `HubSpotLocationService` for interacting with HubSpot's custom objects API, specifically for "locations." It includes methods like `getLocationIdByCode`, `getAssociationTypeId`, `associateContactToLocation`, `associateDealToLocation`, and `batchAssociateWithLocation`. It uses caching for location data and association types to optimize API calls. Logging is present for various operations and errors.
- **1/2/2026, 12:17:39 PM**: The constructor's `$apiToken` parameter type hint was changed from `string` to `?string`, aligning with other HubSpot services.

#### `c:\Users\efeno\dev\datalink\app\SMCore\Services\Crm\Hubspot\HubSpotOwnerService.php`
- **1/2/2026, 11:43:42 AM (Initial state)**: This file defines `HubSpotOwnerService` for retrieving owner information from HubSpot. It contains `getOwnersList` and `getOwnerByEmailAddress` methods, with error handling.
- **1/2/2026, 12:17:13 PM**: The constructor's `$apiToken` parameter type hint was changed from `string` to `?string`.

#### `c:\Users\efeno\dev\datalink\app\Providers\HubSpotServiceProvider.php`
- **1/2/2026, 11:47:45 AM**: This service provider registers `PlotBoxHubSpotService` and `HmisHubSpotService` as singletons, injecting `HubSpotContactService` and `HubSpotDealService` instances. A `dd($hmisToken)` statement was added for debugging the `hmisToken`.
- **1/2/2026, 12:00:29 PM**: The `dd($hmisToken)` debugging statement was removed.

#### `c:\Users\efeno\dev\datalink\config\services.php`
- **1/2/2026, 12:08:26 PM**: This configuration file defines various HubSpot API parameters, including URLs, association type IDs for contacts, deals, and locations, lifecycle stages, pipeline IDs, and object type IDs. It also includes specific search configurations and property mappings for `hmis` and `plotbox` data sources, including their respective API access tokens. This file *stores configuration and not actual keys*, so it's included in the summary.

#### `c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`
- **1/6/2026, 3:15:57 PM (Initial state)**: This Eloquent model represents a `Contact` in the PlotBox data warehouse (Snowflake). It defines table, primary key, fillable fields, and relationships. Critically, it includes a complex SQL query in `getDataWithDateRange` to fetch contract, contact, and item count data, joining multiple Snowflake tables (`DIM_CONTRACT`, `DIM_CONTRACT_OWNER`, `DIM_CONTACT`, `DIM_CONTRACT_WRITER`, `DIM_SYSTEM_USER`, `DIM_CONTRACT_ITEM`, `DIM_FEE`, `DIM_FEE_CATEGORY`). It also defines `getHubspotData` to retrieve data for the current date.
- **1/8/2026, 10:29:41 AM**: A `LIMIT 1` clause was added to the main `SELECT` statement in `getDataWithDateRange` (specifically in the `FROM primary_contacts pc` section), suggesting a debugging step to fetch only a single record.
- **1/8/2026, 10:31:58 AM**: A new column `df.FACILITY_ID AS Facility_ID` and `df.FACILITY_NAME AS Facility_Name` were added to the final `SELECT` statement in `getDataWithDateRange`, along with a `LEFT JOIN WAREHOUSE_EVERSTORYPARTNERS.DIM_FACILITY df ON pc.FACILITY_KEY = df.FACILITY_KEY`. This enhances the retrieved data with facility details. The `LIMIT 1` remains.
- **1/8/2026, 10:33:02 AM**: The `df.FACILITY_ID` and `df.FACILITY_NAME` fields were removed from the main `SELECT` statement, reverting the previous addition. The `LIMIT 1` remains.
- **1/8/2026, 10:40:26 AM**: The `getDataWithDateRange` function was renamed to `getDataWithDateRange1`, and a new `getDataWithDateRange` function was introduced. The new `getDataWithDateRange` included a hardcoded `DIM_CONTRACT.CONTRACT_NUMBER = '660-1004010262'` filter and commented out the date range and `EXISTS` clause, indicating significant debugging of a specific contract.
- **1/8/2026, 10:52:47 AM**: The hardcoded contract number filter in `getDataWithDateRange` was commented out, and the original date range filter was restored, effectively reverting the previous change for `getDataWithDateRange`. The `getDataWithDateRange1` function still has `LIMIT 1`.
- **1/8/2026, 10:55:03 AM**: A leading 'W' was mistakenly added to the `WITH` clause of `getDataWithDateRange`, making the SQL invalid. It also removed `CREATED_BY_KEY` from `DIM_CONTRACT` in the `base_contracts` CTE and adjusted `primary_contacts` and `deceased_contacts` CTEs to remove `CREATED_BY_KEY` joins, using `CONTRACT_ID` for joining with `DIM_CONTRACT_OWNER`.
- **1/8/2026, 10:56:12 AM**: The accidental 'W' in `WITH` was removed, correcting the SQL syntax.
- **1/8/2026, 11:04:46 AM**: The `getDataWithDateRange` function was renamed to `getDataWithDateRange1`, and the original date range query was placed back in the main `getDataWithDateRange` function without the `LIMIT 1`. The `getDataWithDateRange1` still contains `LIMIT 1`.
- **1/8/2026, 11:04:55 AM**: The `Location_Cd` in `getDataWithDateRange` (the one *without* `LIMIT 1`) was changed to `SUBSTRING(CAST(pc.CONTACT_KEY AS STRING), 1, 3)`, deriving location code from `CONTACT_KEY` instead of joining `DIM_FACILITY`. The `DIM_FACILITY` join was removed.
- **1/8/2026, 11:18:21 AM**: The join condition for `DIM_CONTACT_OWNER` to `DIM_CONTACT` and `base_contracts` was modified in both `primary_contacts` and `deceased_contacts` CTEs, changing `dc.CONTACT_KEY` to `dc.CONTACT_ID` in the `ON` clause for `dco.CONTACT_ID = dc.CONTACT_KEY`. Also, `DIM_CONTRACT.CREATED_BY_KEY` was changed to `DIM_CONTRACT.CREATED_BY` and similar for `dco.CREATED_BY` and `dc.CREATED_BY`. `FACILITY_KEY` in `base_contracts` was changed to `FACILITY_ID`, and the final join to `DIM_FACILITY` used `pc.FACILITY_ID = df.FACILITY_ID`.
- **1/8/2026, 11:42:34 AM**: The join condition `dco.CONTACT_ID = DIM_CONTRACT.CONTRACT_KEY` was added in `base_contracts` `EXISTS` clause.
- **1/8/2026, 11:48:11 AM**: `cw.CONTRACT_ID` was used for joining in `contract_writers` and `item_counts` CTEs, and for the `cw` join in the final select, instead of `CONTRACT_KEY`. `ci.CONTRACT_ID` was used for `DIM_CONTRACT_ITEM` in `item_counts` and its `GROUP BY`. `su.SYSTEM_USER_ID = cw.USER_ID` was used for `DIM_SYSTEM_USER` join.
- **1/8/2026, 12:23:40 PM**: The join conditions for `DIM_FEE` and `DIM_FEE_CATEGORY` were changed to use `FEE_ID` and `FEE_CATEGORY_ID` respectively, instead of `FEE_KEY` and `FEE_CATEGORY_KEY`, in the `item_counts` CTE.
- **1/8/2026, 1:03:44 PM**: The `CREATED_BY` field was added to the `primary_contacts` and `deceased_contacts` selects and the final `SELECT` output as `Created_By_Key`. The join condition for `deceased_contacts` to `primary_contacts` was updated to include `pc.CREATED_BY = dc.CREATED_BY`. The `getDataWithDateRange1` function (with `LIMIT 1`) was removed, and the `getDataWithDateRange` was reverted to its pre-1/8/2026, 10:40:26 AM state with date range filtering and no `LIMIT 1`.
- **1/9/2026, 11:29:14 AM**: A significant change was made to `getDataWithDateRange`. The original date range filtering and the `EXISTS` clause were commented out. Instead, a hardcoded filter `DIM_CONTRACT.CONTRACT_NUMBER = '660-1004010262'` was introduced, indicating debugging on a specific contract. `LIMIT 1` was added back.
- **1/9/2026, 11:29:23 AM**: The `LIMIT 1` was removed, but the hardcoded `CONTRACT_NUMBER` filter remained, and date range filtering commented out.
- **1/9/2026, 3:21:23 PM**: The hardcoded `CONTRACT_NUMBER` filter in `getDataWithDateRange` was removed, and the original date range filtering and `EXISTS` clause were uncommented and restored, reverting the query to its intended date-filtered behavior without `LIMIT 1`.

#### `\response_fd37b194-620b-4981-a320-76fc5f36551b\0` (presumably `c:\Users\efeno\dev\datalink\app\Mappers\PlotBoxDataToCrmMapper.php`)
- **1/9/2026, 11:14:12 AM (Initial state)**: This file defines `PlotBoxDataToCrmMapper` responsible for mapping `PlotBoxDataTransferObject` to HubSpot CRM contact and deal data. It injects `HubSpotOwnerService` and `HubSpotLocationService` and fetches HubSpot config values. It has `mapContact`, `mapDeceasedContact`, `mapDeal` methods, and helper functions for date validation, deal name generation, email parsing, and formatting mapped fields (e.g., looking up location IDs, uppercasing state, standardizing pipeline/dealstage). It also includes a `mergePreNeedItemCountsToPrimaryContact` method.
- **1/9/2026, 11:15:29 AM**: Removed explicit `trim()` calls for `date_of_birth` and `date_of_death` when passed to `date_string_to_midnight_utc_millis` in `mapDeceasedContact`, assuming `isValidDate` handles trimming. Also removed a `Log::warning` with `debug_backtrace` from `listAllLocations`.
- **1/9/2026, 11:15:37 AM**: No functional changes, identical to the previous timestamp.
- **1/9/2026, 11:20:17 AM**: Added `primaryDateOfBirth` check and `birthday` field mapping in `mapContact`. The `isValidDate` check was moved to directly before setting `date_of_birth` in `mapDeceasedContact`.
- **1/9/2026, 11:24:38 AM**: Reverted the `isValidDate` check logic for deceased contact dates: instead of individual checks, it now iterates through an `$datesArray` for `date_of_birth` and `date_of_death`. This change was immediately reverted in the next commit.
- **1/9/2026, 11:25:29 AM**: The iteration through `$datesArray` for deceased contact dates was reverted, bringing the `mapDeceasedContact` function back to individual `isValidDate` checks for `deceasedBirthDate` and `deceasedDeathDate` as seen in `1/9/2026, 11:20:17 AM`.
- **1/9/2026, 11:31:54 AM**: No functional changes, identical to the previous timestamp.
- **1/9/2026, 11:32:58 AM**: No functional changes, identical to the previous timestamp.
- **1/9/2026, 11:43:23 AM**: The `formatMappedFields` method was updated to normalize `pipeline` and `dealstage` values by removing spaces and converting to lowercase before checking for 'at-need' or 'pre-need' keywords, making the mapping more robust to variations in input strings.
- **1/9/2026, 11:45:03 AM**: A temporary `var_dump('here');` and `var_dump('there');` debugging statements were added within the `mapDeceasedContact` method, specifically around the date handling logic.
- **1/9/2026, 1:41:35 PM**: Added a `birthday` field mapping for `primaryDateOfBirth` in `mapContact`.
- **1/9/2026, 1:41:42 PM**: Added a `birthday` field mapping for `deceasedBirthDate` in `mapDeceasedContact`.
- **1/9/2026, 1:45:03 PM**: The temporary `var_dump` statements in `mapDeceasedContact` were removed.
- **1/9/2026, 3:20:18 PM**: No functional changes, identical to the previous timestamp.

#### `c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`
- **1/9/2026, 11:26:48 AM (Initial state)**: This service orchestrates the HubSpot data synchronization for PlotBox data. It initializes mapper, contact, deal, and location services. The `syncPlotBoxData` method fetches data, maps it, and then attempts to process contacts, deals, and their associations. It includes `dd($dealsBatch, $primaryContactBatch)` for debugging.
- **1/9/2026, 11:26:59 AM**: No functional changes, identical to the previous timestamp.
- **1/9/2026, 12:17:46 PM**: The `dd($dealsBatch, $primaryContactBatch)` debugging statement was changed to `dd($deceasedContactBatch)`, indicating a shift in debugging focus.
- **1/9/2026, 12:31:34 PM**: The `dd($deceasedContactBatch)` debugging statement was commented out, restoring the normal execution flow.
- **1/9/2026, 12:53:47 PM**: Removed a `dd($dealsBatch, $primaryContactBatch, $deceasedContactBatch);` that was likely added as a temporary debugging measure.
- **1/9/2026, 3:21:42 PM**: No functional changes, identical to the previous timestamp.

#### `c:\Users\efeno\dev\datalink\app\helpers.php`
- **1/9/2026, 12:26:40 PM (Initial state)**: This file contains several helper functions. The `date_string_to_midnight_utc_millis` function converts a date string to milliseconds since epoch at midnight UTC, assuming 'America/New_York' timezone.
- **1/9/2026, 12:26:57 PM**: Removed the line `$dt->setTime(0, 0, 0);` from `date_string_to_midnight_utc_millis`, meaning it would no longer normalize the time to midnight UTC for the given date.
- **1/9/2026, 12:29:20 PM**: The `date_string_to_midnight_utc_millis` function now returns `getTimestamp()` (seconds) instead of `getTimestamp() * 1000` (milliseconds), and the `convert_utc_date_to_epoch` function was changed to return `strtotime($dateString)` (seconds) instead of `strtotime($dateString) * 1000` (milliseconds). This is a significant change in how dates are represented (seconds vs. milliseconds).
- **1/9/2026, 12:30:41 PM**: The `convert_utc_date_to_epoch` function was reverted to return milliseconds (`strtotime($dateString) * 1000`), while `date_string_to_midnight_utc_millis` remained returning seconds.
- **1/9/2026, 12:32:57 PM**: No functional changes, identical to the previous timestamp.
- **1/9/2026, 12:51:15 PM**: The `date_string_to_midnight_utc_millis` function was reverted to return milliseconds (`$dt->getTimestamp() * 1000`) and also had `$dt->setTime(0, 0, 0);` added back, restoring its original behavior of converting to midnight UTC milliseconds.
- **1/9/2026, 12:52:33 PM**: Changed `new \DateTime($dateString, $original_timezone)` to `new \DateTime($dateString . ' 00:00:00', new \DateTimeZone($original_timezone))` in `date_string_to_midnight_utc_millis`. This ensures the time component is explicitly set to midnight before timezone conversion, improving reliability for date strings without time.
- **1/9/2026, 12:54:35 PM**: Added a conditional check `if ($timestamp < 0) return $dateString;` to `date_string_to_midnight_utc_millis` to return the original string if the conversion results in a negative timestamp, which could happen for invalid or too early dates.
- **1/9/2026, 12:58:10 PM**: No functional changes, identical to the previous timestamp.
- **1/9/2026, 1:03:46 PM**: No functional changes, identical to the previous timestamp.
- **1/9/2026, 1:04:51 PM**: No functional changes, identical to the previous timestamp.
- **1/9/2026, 1:04:57 PM**: No functional changes, identical to the previous timestamp.
- **1/9/2026, 1:05:08 PM**: No functional changes, identical to the previous timestamp.
- **1/9/2026, 1:09:16 PM**: Added a new validation to `date_string_to_midnight_utc_millis`: `substr(trim($dateString), 0, 10)` and `!preg_match('/^\d{4}-\d{2}-\d{2}$/', $dateString)` to ensure the input date string is in 'YYYY-MM-DD' format before processing, returning `null` if it doesn't match. This improves input robustness.
- **1/9/2026, 1:09:50 PM**: No functional changes, identical to the previous timestamp.
- **1/9/2026, 1:10:08 PM**: No functional changes, identical to the previous timestamp.

### Patterns and Recurring Elements:

1.  **HubSpot API Integration**: A dominant pattern across multiple PHP service files (`HubSpotContactService`, `HubSpotDealService`, `HubSpotLocationService`, `HubSpotOwnerService`) is their interaction with the HubSpot CRM API. All these services use `HubSpot\Factory::createWithAccessToken($apiToken)` to initialize the HubSpot client and rely on specific HubSpot client classes (e.g., `HubSpot\Client\Crm\Contacts\BasicApi`, `HubSpot\Client\Crm\Deals\BasicApi`, `HubSpot\Client\Crm\Objects\SearchApi`, `HubSpot\Client\Crm\Associations\V4\BasicApi`).
2.  **Robust Error Handling and Logging**: All HubSpot service methods (`createContact`, `updateContact`, `associatePrimaryAndDeceasedContacts`, `createDeal`, `updateDeal`, `associateDealWithContact`, `getLocationIdByCode`, `getOwnersList`, `getOwnerByEmailAddress`) include `try-catch` blocks for `ApiException` (HubSpot specific) and general `Exception`s. Errors are logged using `Illuminate\Support\Facades\Log`, often including error codes, messages, response bodies, and stack traces, demonstrating a focus on debugging and fault tolerance.
3.  **Data Pre-processing and Formatting**: Before sending data to HubSpot, the services consistently remove irrelevant properties (e`'loc_id'`, `'last_update_dt'`, `'exists'`, and sometimes `'hmis_account_number'` or `'service_type_code'`). The `PlotBoxDataToCrmMapper` explicitly formats fields like `loc_id`, `state`, `relationship_to_the_deceased`, `pipeline`, `hubspot_owner_id`, and `dealstage` to match HubSpot's expectations, indicating a transformation layer.
4.  **Configuration-Driven Behavior**: Association type IDs, lifecycle stages, pipeline IDs, and search configurations are loaded dynamically from `config('services.hubspot...')`, making the integration flexible and configurable without code changes.
5.  **Date Handling Complexity**: The `app\helpers.php` file shows several iterations of refining date conversion functions, specifically `date_string_to_midnight_utc_millis` and `convert_utc_date_to_epoch`. The changes indicate challenges in correctly converting date strings to epoch milliseconds while accounting for timezones (America/New_York to UTC), setting time to midnight, and handling invalid date inputs. The `isValidDate` helper function also appears in the `PlotBoxDataToCrmMapper` and ensures that date fields are only mapped if they represent valid dates.
6.  **Debugging Practices**: Frequent addition and removal or commenting out of `dd()` (die and dump) and `var_dump()` statements, along with `Log::info` and `Log::error` messages, highlight an active development and debugging process, especially visible in `PlotBoxDataToCrmMapper`, `HubSpotContactService`, `PlotBoxHubSpotService`, and `PlotBox\Contact` model. `usleep` calls are also observed for rate limiting or allowing API processing time in `PlotBoxDataToCrmMapper`.
7.  **Data Source Mapping (PlotBox)**: The `PlotBoxDataToCrmMapper` and `PlotBox\Contact` model illustrate the specific process of extracting and transforming data from a "PlotBox" source (likely Snowflake database) into a format suitable for HubSpot CRM. This includes mapping primary and deceased contacts, and deals, with specific business logic for generating deal names and handling item counts (for 'pre-need' pipelines).
8.  **Database Query Evolution**: The `app\Models\PlotBox\Contact.php` file shows a repeated pattern of modifying a large, complex SQL query within `getDataWithDateRange` (and `getDataWithDateRange1`/`getDataWithDateRange2` temporarily), often adding `LIMIT 1` for debugging specific records, commenting out date range filters to focus on contract numbers, and then reverting these changes. This iterative refinement suggests detailed validation of the data extraction logic. Key columns and join conditions (`CONTACT_KEY` vs `CONTACT_ID`, `CREATED_BY_KEY` vs `CREATED_BY`, `FEE_KEY` vs `FEE_ID`) were also changed multiple times.
9.  **Service Provider Registration**: `HubSpotServiceProvider` demonstrates how the HubSpot CRM services are bound into the application's dependency injection container, with specific API tokens and data repositories injected for different data sources (PlotBox, HMIS).
10. **Association Logic**: The HubSpot service classes contain explicit logic for creating associations between different HubSpot objects (e.g., primary contacts with deceased contacts, deals with contacts, contacts with locations, deals with locations), often using `AssociationSpec` for user-defined or HubSpot-defined association categories. This indicates complex relationship modeling within the CRM.