# Activity Summary for 12/26/2025

## 3:17:55 AM
The code changes primarily revolve around a data synchronization system, specifically integrating "PlotBox" and "HMIS" data into HubSpot CRM. All documented changes occurred on December 22, 2025, within a roughly 25-minute window, suggesting a focused development or deployment activity.

**Key Information by File:**

*   **`c:\Users\efeno\dev\datalink\app\Mappers\PlotBoxDataToCrmMapper.php`**
    *   **Timestamp: 12/22/2025, 5:26:50 PM & 5:39:32 PM**
    *   This PHP class is responsible for mapping data from PlotBox (likely a data source) into a format suitable for HubSpot CRM.
    *   It initializes HubSpot owner and location services, fetches and caches owner lists and all locations.
    *   It defines methods to `mapContact`, `mapDeceasedContact`, and `mapDeal` from a `PlotBoxDataTransferObject`, cleaning and transforming fields like emails, names, addresses, and dates.
    *   Key mapping logic includes deriving `loc_id`, uppercasing state, standardizing 'Next of Kin' relationship, and mapping pipelines ('at-need', 'pre-need') and deal stages to HubSpot configurations.
    *   A `__destruct` method was added or refined to ensure cleanup of resources (clearing arrays and unsetting services) with logging.
    *   A `mergePreNeedItemCountsToPrimaryContact` method was introduced to conditionally add various "owned" item counts (caskets, cremation products, ground, etc.) to primary contact data if `HUBSPOT_PLOTBOX_ALLOW_ITEMS_COUNT` is enabled and the pipeline is 'pre-need'.
    *   **Significant Update (between 5:26:50 PM and 5:39:32 PM):** The `listAllLocations` method was corrected to properly use the already initialized `$this->locationService` instance to fetch locations with caching, rather than creating a new, unconfigured instance. This was a crucial bug fix or refinement.

*   **`c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php`**
    *   **Timestamp: 12/22/2025, 5:30:12 PM**
    *   This PHP class performs similar mapping to the PlotBox mapper but for HMIS data.
    *   It maps HMIS data to HubSpot contacts and deals, including fields specific to HMIS like `religious_affilation` and `date_of_burial_memorial_service` for deceased contacts.
    *   The `hubspot_owner_id` is derived from `dealOwnerUserName` appended with `@everstorypartners.com`.
    *   Its `formatMappedFields` method includes specific pipeline logic for 'an_fh' for at-need.

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
    *   **Timestamp: 12/22/2025, 5:30:34 PM & 5:43:57 PM**
    *   This Eloquent model connects to a Snowflake database to retrieve PlotBox contact data.
    *   The `getDataWithDateRange` method executes a complex SQL query using several Common Table Expressions (`base_contracts`, `contract_writers`, `item_counts`, `primary_contacts`, `deceased_contacts`) to gather comprehensive contact and contract-related information, including detailed item counts for various products (caskets, cremation, ground, markers, etc.).
    *   **Significant Update (between 5:30:34 PM and 5:43:57 PM):** An explicit `LIMIT 2` clause was removed from the main SQL query, indicating a shift from a debug/test mode (fetching only 2 records) to full data retrieval.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**
    *   **Timestamp: 12/22/2025, 5:31:15 PM**
    *   This service orchestrates the synchronization of PlotBox data to HubSpot.
    *   The `syncPlotBoxData` method fetches data, uses the `PlotBoxDataToCrmMapper` to transform it, and batches primary contacts, deceased contacts, and deals.
    *   The `processContacts` method then handles the creation, updating, and association of these entities in HubSpot, including associating contacts and deals with locations. It employs `try-catch` blocks for resilience, allowing the process to continue even if some steps fail, and includes `sleep` calls to manage API limits.

*   **`c:\Users\efeno\dev\datalink\config\services.php`**
    *   **Timestamp: 12/22/2025, 5:35:58 PM**
    *   This configuration file was significantly updated to centralize HubSpot-related settings.
    *   It now defines numerous HubSpot association type IDs, lifecycle stages, pipeline IDs, and deal stages (`deceased_lifecycle_stage`, `at_need_pipeline`, `pre_need_pipeline`, `ready_for_contract`, etc.).
    *   Detailed `deal_search_config` and `sources` configurations (for 'hmis' and 'plotbox') were added, specifying search properties, properties to fetch, and properties to map for contacts, enabling a more robust and flexible integration.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`**
    *   **Timestamp: 12/22/2025, 5:36:18 PM**
    *   This service is analogous to `PlotBoxHubSpotService` but for HMIS data.
    *   The `syncData` method specifically differentiates between 'SHIPOUT' and non-'SHIPOUT' service types, processing them in separate batches.
    *   The `processContacts` method includes additional logic to `checkContactOwnerExists` and `checkDealOwnerExists` before updating entities, ensuring data integrity related to HubSpot ownership.

*   **`c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php`**
    *   **Timestamp: 12/22/2025, 5:42:08 PM & 5:43:47 PM**
    *   This Eloquent model connects to a SQL Server database for HMIS sales data.
    *   The `getDataWithDateRange` method queries sales, purchaser, deceased, and service details, joining across multiple HMIS-specific tables.
    *   It includes extensive `WHERE` clauses to filter sales by status, type, location, and financial criteria.
    *   **Significant Update (between 5:42:08 PM and 5:43:47 PM):** The `LIMIT 2` clause was removed from the SQL query, indicating a transition from testing to full data processing.

**Patterns and Recurring Elements:**

*   **Dual Integration Paths:** There are distinct but parallel integration paths for "PlotBox" and "HMIS" data, each with its own mapper, model, and HubSpot service.
*   **HubSpot Focus:** All PHP code changes are deeply tied to HubSpot CRM functionality, including managing contacts, deals, and associations between different HubSpot objects (contacts-contacts, contacts-deals, contacts-locations, deals-locations).
*   **Data Transformation:** A clear pattern of data mapping exists, where raw data from internal systems is trimmed, formatted, and converted to match HubSpot's property requirements. Dates are consistently converted to epoch milliseconds.
*   **Resilience and Rate Limiting:** The use of `try-catch` blocks for individual processing steps and `sleep` calls throughout the HubSpot services indicates an awareness of API limitations and the need for robust error handling.
*   **Configuration-Driven:** The `config/services.php` update highlights a move towards more externalized and configurable settings for HubSpot integration, making it easier to manage different environments or adjust integration logic without code changes.
*   **Debugging Artifacts:** The presence and subsequent removal of `LIMIT 2` in SQL queries point to an iterative development process that included testing with limited datasets.