# Activity Summary for 12/26/2025

## 3:17:55 AM
The code changes primarily revolve around a data synchronization system, specifically integrating "PlotBox" and "HMIS" data into HubSpot CRM. All documented changes occurred on December 22, 2025, within a roughly 25-minute window, suggesting a focused development or deployment activity.

**Key Information by File:**

*   **`c:\Users\efeno\dev\datalink\app\Mappers\PlotBoxDataToCrmMapper.php`**
    *   **Timestamp: 12/22/2025, 5:26:50 PM & 5:39:32 PM**
    *   This PHP class is responsible for mapping data from PlotBox (likely a data source) into a format suitable for HubSpot CRM.
    *   It initializes HubSpot owner and location services, fetches and caches owner lists and all locations.
    *   It defines methods to `mapContact`, `mapDeceasedContact`, and `mapDeal` from a `PlotBoxDataTransferObject`, cleaning and transforming fields like emails, names, addresses, and dates.
    *   Key mapping logic includes deriving `loc_id`, uppercasing state, standardizing 'Next of Kin' relationship, and mapping pipelines ('at-need', 'pre-need') and deal stages to HubSpot configurations.
    *   A `__destruct` method was added or refined to ensure cleanup of resources (clearing arrays and unsetting services) with logging.
    *   A `mergePreNeedItemCountsToPrimaryContact` method was introduced to conditionally add various "owned" item counts (caskets, cremation products, ground, etc.) to primary contact data if `HUBSPOT_PLOTBOX_ALLOW_ITEMS_COUNT` is enabled and the pipeline is 'pre-need'.
    *   **Significant Update (between 5:26:50 PM and 5:39:32 PM):** The `listAllLocations` method was corrected to properly use the already initialized `$this->locationService` instance to fetch locations with caching, rather than creating a new, unconfigured instance. This was a crucial bug fix or refinement.

*   **`c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php`**
    *   **Timestamp: 12/22/2025, 5:30:12 PM**
    *   This PHP class performs similar mapping to the PlotBox mapper but for HMIS data.
    *   It maps HMIS data to HubSpot contacts and deals, including fields specific to HMIS like `religious_affilation` and `date_of_burial_memorial_service` for deceased contacts.
    *   The `hubspot_owner_id` is derived from `dealOwnerUserName` appended with `@everstorypartners.com`.
    *   Its `formatMappedFields` method includes specific pipeline logic for 'an_fh' for at-need.

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
    *   **Timestamp: 12/22/2025, 5:30:34 PM & 5:43:57 PM**
    *   This Eloquent model connects to a Snowflake database to retrieve PlotBox contact data.
    *   The `getDataWithDateRange` method executes a complex SQL query using several Common Table Expressions (`base_contracts`, `contract_writers`, `item_counts`, `primary_contacts`, `deceased_contacts`) to gather comprehensive contact and contract-related information, including detailed item counts for various products (caskets, cremation, ground, markers, etc.).
    *   **Significant Update (between 5:30:34 PM and 5:43:57 PM):** An explicit `LIMIT 2` clause was removed from the main SQL query, indicating a shift from a debug/test mode (fetching only 2 records) to full data retrieval.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**
    *   **Timestamp: 12/22/2025, 5:31:15 PM**
    *   This service orchestrates the synchronization of PlotBox data to HubSpot.
    *   The `syncPlotBoxData` method fetches data, uses the `PlotBoxDataToCrmMapper` to transform it, and batches primary contacts, deceased contacts, and deals.
    *   The `processContacts` method then handles the creation, updating, and association of these entities in HubSpot, including associating contacts and deals with locations. It employs `try-catch` blocks for resilience, allowing the process to continue even if some steps fail, and includes `sleep` calls to manage API limits.

*   **`c:\Users\efeno\dev\datalink\config\services.php`**
    *   **Timestamp: 12/22/2025, 5:35:58 PM**
    *   This configuration file was significantly updated to centralize HubSpot-related settings.
    *   It now defines numerous HubSpot association type IDs, lifecycle stages, pipeline IDs, and deal stages (`deceased_lifecycle_stage`, `at_need_pipeline`, `pre_need_pipeline`, `ready_for_contract`, etc.).
    *   Detailed `deal_search_config` and `sources` configurations (for 'hmis' and 'plotbox') were added, specifying search properties, properties to fetch, and properties to map for contacts, enabling a more robust and flexible integration.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`**
    *   **Timestamp: 12/22/2025, 5:36:18 PM**
    *   This service is analogous to `PlotBoxHubSpotService` but for HMIS data.
    *   The `syncData` method specifically differentiates between 'SHIPOUT' and non-'SHIPOUT' service types, processing them in separate batches.
    *   The `processContacts` method includes additional logic to `checkContactOwnerExists` and `checkDealOwnerExists` before updating entities, ensuring data integrity related to HubSpot ownership.

*   **`c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php`**
    *   **Timestamp: 12/22/2025, 5:42:08 PM & 5:43:47 PM**
    *   This Eloquent model connects to a SQL Server database for HMIS sales data.
    *   The `getDataWithDateRange` method queries sales, purchaser, deceased, and service details, joining across multiple HMIS-specific tables.
    *   It includes extensive `WHERE` clauses to filter sales by status, type, location, and financial criteria.
    *   **Significant Update (between 5:42:08 PM and 5:43:47 PM):** The `LIMIT 2` clause was removed from the SQL query, indicating a transition from testing to full data processing.

**Patterns and Recurring Elements:**

*   **Dual Integration Paths:** There are distinct but parallel integration paths for "PlotBox" and "HMIS" data, each with its own mapper, model, and HubSpot service.
*   **HubSpot Focus:** All PHP code changes are deeply tied to HubSpot CRM functionality, including managing contacts, deals, and associations between different HubSpot objects (contacts-contacts, contacts-deals, contacts-locations, deals-locations).
*   **Data Transformation:** A clear pattern of data mapping exists, where raw data from internal systems is trimmed, formatted, and converted to match HubSpot's property requirements. Dates are consistently converted to epoch milliseconds.
*   **Resilience and Rate Limiting:** The use of `try-catch` blocks for individual processing steps and `sleep` calls throughout the HubSpot services indicates an awareness of API limitations and the need for robust error handling.
*   **Configuration-Driven:** The `config/services.php` update highlights a move towards more externalized and configurable settings for HubSpot integration, making it easier to manage different environments or adjust integration logic without code changes.
*   **Debugging Artifacts:** The presence and subsequent removal of `LIMIT 2` in SQL queries point to an iterative development process that included testing with limited datasets.

## 2:01:31 PM
The changes primarily focus on implementing and refining the synchronization of customer and sales data from two internal systems, PlotBox and HMIS, to HubSpot CRM. All documented changes occurred on December 22, 2025, between 5:26:50 PM and 5:50:06 PM, indicating a concentrated development effort.

**File-Specific Updates:**

*   **`app\Mappers\PlotBoxDataToCrmMapper.php` (12/22/2025, 5:26:50 PM & 5:39:32 PM):** This file defines the logic for transforming PlotBox data into HubSpot-compatible formats for contacts (primary and deceased) and deals. It initializes HubSpot owner and location services, fetches configuration for lifecycle stages and pipelines, and includes a destructor for resource cleanup. The `mapContact` method specifically merges pre-need item counts (e.g., caskets, cremation products owned) if an environment variable `HUBSPOT_PLOTBOX_ALLOW_ITEMS_COUNT` is enabled and the pipeline is 'pre-need'. The `formatMappedFields` method standardizes various data points like location IDs, state, relationship to deceased, pipelines, and HubSpot owner IDs. Both timestamps show identical code, indicating no functional change between these two log entries for this file.

*   **`app\Mappers\HmisDataToCrmMapper.php` (12/22/2025, 5:30:12 PM):** This mapper serves a similar purpose for HMIS data. It maps HMIS data to HubSpot contacts (primary and deceased) and deals. Key differences from the PlotBox mapper include constructing `hubspot_owner_id` by appending `@everstorypartners.com` to a username, mapping HMIS-specific fields like `religious_affilation` and `date_of_burial_memorial_service`, and not including the pre-need item count merging logic.

*   **`app\Models\PlotBox\Contact.php` (12/22/2025, 5:30:34 PM & 5:43:57 PM):** This Eloquent model is responsible for querying PlotBox contract and contact data from a Snowflake database. It uses complex SQL queries with several Common Table Expressions (CTEs) to gather details for primary contacts, deceased contacts, contract writers, and a comprehensive breakdown of owned items (e.g., caskets, vaults, niches). The most significant change in this file, observed at 5:43:57 PM, is the **removal of `limit 2`** from the main SQL query within `getDataWithDateRange`, which previously restricted the result set. This suggests a transition from testing with a limited dataset to fetching all relevant data for full synchronization.

*   **`app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (12/22/2025, 5:31:15 PM):** This service orchestrates the synchronization of PlotBox data to HubSpot. It fetches raw data, uses the `PlotBoxDataToCrmMapper` to transform it, and then processes batches of contacts and deals for creation, updating, and associating them with each other and with locations in HubSpot. It employs individual try-catch blocks for resilience and includes `sleep` calls (10 seconds after primary contacts, 5 seconds after deals) to manage HubSpot API processing times. The log entry for this file is incomplete.

*   **`config\services.php` (12/22/2025, 5:35:58 PM):** This configuration file centralizes HubSpot-related settings, defining various association type IDs (contact-to-contact, contact-to-deal, contact-to-location, etc.), lifecycle stages, deal pipelines, and object type IDs. It also specifies `deal_search_config` and `sources` properties for both HMIS and PlotBox, detailing how to search for existing deals and contacts, and which properties to fetch, indicating a tailored approach for each data source.

*   **`app\SMCore\Services\Hmis\HmisHubSpotService.php` (12/22/2025, 5:36:18 PM):** This service manages the HMIS to HubSpot data sync. Similar to its PlotBox counterpart, it fetches, maps, and processes contact and deal data in HubSpot. A key distinction is its explicit handling of "SHIPOUT" `serviceTypeCode` data, processing it in separate batches. It also includes `checkContactOwnerExists` and `checkDealOwnerExists` methods prior to updates, which are not present in the PlotBox service. This log entry is also incomplete.

*   **`app\Models\Hmis\Sale.php` (12/22/2025, 5:42:08 PM & 5:43:47 PM):** This Eloquent model handles retrieving HMIS sales data from an SQL Server database. It performs a complex query joining multiple tables to gather comprehensive information about sales, purchasers, deceased individuals, and service details. Similar to the PlotBox Contact model, the critical change at 5:43:47 PM is the **removal of `limit 2`** from the `getDataWithDateRange` SQL query, enabling the retrieval of the full dataset.

*   **`app\Providers\HubSpotServiceProvider.php` (12/22/2025, 5:50:06 PM):** This file registers the `PlotBoxHubSpotService` and `HmisHubSpotService` in the application's service container. It ensures that these services are correctly instantiated with their respective HubSpot API tokens, HubSpot CRM services (ContactService, DealService), and the appropriate data repositories (`EloquentHubSpotRepository` configured for either `PlotBox\Contact` or `Hmis\Sale` models). This demonstrates a dependency-injected and modular architecture for the HubSpot integrations.

**Patterns and Recurring Elements:**

*   **Dual Integration:** There's a clear pattern of parallel development for integrating two distinct source systems (PlotBox and HMIS) with HubSpot CRM, often with very similar class structures (mappers, services) adapted for each source's specifics.
*   **Data Transformation:** Dedicated mapper classes are central to the process, standardizing source data into a common format for HubSpot.
*   **Complex SQL Queries:** Both source models (`PlotBox\Contact`, `Hmis\Sale`) rely on extensive SQL queries to extract and prepare comprehensive datasets for HubSpot, often involving multiple joins and conditional aggregations.
*   **Full Data Sync:** The removal of `limit 2` from the primary data retrieval queries in both `PlotBox\Contact.php` and `Hmis\Sale.php` indicates a shift towards full data synchronization rather than limited testing.
*   **Resilience and Rate Limiting:** The HubSpot services incorporate individual try-catch blocks for error handling and `sleep` calls, suggesting an awareness of API rate limits and the need for robust processing.
*   **Centralized Configuration:** The `config/services.php` file acts as a central hub for HubSpot-related settings, demonstrating a structured approach to managing external service credentials and parameters.
*   **Dependency Injection:** The `HubSpotServiceProvider` showcases a well-architected system using dependency injection for managing and configuring the various HubSpot integration components.