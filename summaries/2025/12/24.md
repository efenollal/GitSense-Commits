# Activity Summary for 12/24/2025

## 3:30:38 AM
The provided logs detail updates to a data synchronization system, primarily focusing on integrating PlotBox and HMIS data with HubSpot CRM. Key changes involve refining data mapping logic, enhancing service robustness, and adjusting data retrieval queries.

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Mappers\PlotBoxDataToCrmMapper.php`**
    *   **Timestamp: 12/22/2025, 5:26:50 PM**
        *   Introduced a `__destruct` method to explicitly clean up resources by clearing internal arrays (`ownersList`, `allLocations`) and unsetting service instances (`ownerService`, `locationService`), with accompanying log messages.
        *   The `formatMappedFields` method was enhanced to standardize various fields like `loc_id` (looking up location ID by code), `state` (uppercasing), `relationship_to_the_deceased` (setting a constant 'Next of Kin'), `pipeline` (standardizing to at-need or pre-need pipelines based on configuration), `hubspot_owner_id` (finding owner by email), and `dealstage` (setting to appropriate 'ready for contract' stages). A general `ucwords(strtolower($value))` is applied as a default.
        *   A new private method `mergePreNeedItemCountsToPrimaryContact` was added to conditionally merge specific item counts (e.g., `caskets_owned`, `cremation_products_owned`) into the primary contact's mapped fields, activated only if the `HUBSPOT_PLOTBOX_ALLOW_ITEMS_COUNT` environment variable is true and the pipeline is 'pre-need'.
        *   The `listAllLocations` method included a `Log::warning` with a debug backtrace for tracing when location fetching is triggered.
    *   **Timestamp: 12/22/2025, 5:39:32 PM**
        *   A subtle but important fix was applied within the `listAllLocations` method. Previously, if `allLocations` was empty, it would create a *new* `HubSpotLocationService` instance without passing the `apiToken` or source. This was corrected to use the already initialized `$this->locationService` instance, ensuring that the correct API token and source ('plotbox') are always utilized for fetching locations with cache.

*   **`c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php` (12/22/2025, 5:30:12 PM)**
    *   This mapper class maintains a similar structure to `PlotBoxDataToCrmMapper` but is tailored for HMIS data.
    *   `mapContact`, `mapDeceasedContact`, and `mapDeal` methods append `@everstorypartners.com` to the `dealOwnerUserName` when mapping `hubspot_owner_id`.
    *   `mapDeceasedContact` specifically maps `religious_affilation` and `date_of_burial_memorial_service` fields.
    *   `mapDeal` includes an `hmis_deal_identifier` and sets `dealstage` to a fixed `readyForContract` value.
    *   The `formatMappedFields` logic is similar to PlotBox but includes specific pipeline mapping for 'an_fh' and explicitly skips transformation for the 'email' field.

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
    *   **Timestamp: 12/22/2025, 5:30:34 PM**
        *   The `getDataWithDateRange` static method defines a complex Snowflake SQL query using several Common Table Expressions (CTEs): `base_contracts`, `contract_writers`, `item_counts`, `primary_contacts`, and `deceased_contacts`. This query extracts comprehensive contact, contract, deal owner, and granular item ownership data (e.g., caskets, cremation products, ground, markers).
        *   The query included a `limit 2` clause, likely for development or testing purposes.
        *   `Log::info` was added to output the first query result for debugging all fetched fields.
    *   **Timestamp: 12/22/2025, 5:43:57 PM**
        *   The `limit 2` clause was removed from the main SQL query within `getDataWithDateRange`, indicating the query is now intended to fetch all relevant data within the specified date range.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (12/22/2025, 5:31:15 PM)**
    *   This service orchestrates the synchronization of PlotBox data to HubSpot.
    *   The `syncPlotBoxData` method fetches data using a `HubSpotRepositoryInterface` and then iterates to map contacts and deals using `PlotBoxDataToCrmMapper`.
    *   Error handling is robust, with individual `try-catch` blocks for processing primary contacts, deceased contacts, contact associations, deal processing, and location associations, allowing the sync to continue even if one step fails.
    *   Explicit `sleep(10)` and `sleep(5)` calls are used between processing steps to mitigate HubSpot API rate limits or allow for backend processing.
    *   The service uses configured association type IDs (`dealTypeIdForLocationsAssociations`, `contactTypeIdForLocationsAssociations`) for linking contacts and deals to locations.

*   **`c:\Users\efeno\dev\datalink\config\services.php` (12/22/2025, 5:35:58 PM)**
    *   Added `ready_for_contract_pre_need` configuration, sourced from `HUBSPOT_READY_FOR_CONTRACT_DEAL_STAGE_PRE_NEED`.
    *   Introduced `deal_object_type_id_for_locations_associations` and `contact_object_type_id_for_locations_associations` with default values ('0-3' and '0-1', respectively) for HubSpot associations.
    *   Updated `deal_search_config` for `plotbox` to use `contract_number` as the `search_property` and fetch additional properties like `plotbox_key` and `plotbox_account_number`.
    *   Refined `sources` configuration for both `hmis` and `plotbox` to specify `id_property`, `phone_properties`, and a comprehensive list of `properties` to fetch/map. Notably, `plotbox` now explicitly includes `mobilephone`, `gender`, and `marital_status`.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php` (12/22/2025, 5:36:18 PM)**
    *   This service mirrors the PlotBox service but handles HMIS data.
    *   The `syncData` method includes logic to differentiate between 'SHIPOUT' and other `serviceTypeCode`s, processing them into separate batches before invoking the `processContacts` method.
    *   The `processContacts` method (shared logic with PlotBox service) incorporates `checkContactOwnerExists` and `checkDealOwnerExists` calls before updating contacts and deals, a feature not present in the PlotBox service's version shown.

*   **`c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php`**
    *   **Timestamp: 12/22/2025, 5:42:08 PM**
        *   The `getDataWithDateRange` static method constructs an SQL Server (MSSQL) query to retrieve sales and related contact/case information. It performs multiple joins across `Sales`, `Name`, `Sales_Finance`, `Location`, `CafeCase`, `CafeEmployee`, `Name2` (for deceased), `CafeCasePerson`, `CafeArrangement`, and `CafeArrangementService`.
        *   The query included a `limit 2` clause.
    *   **Timestamp: 12/22/2025, 5:43:47 PM**
        *   The `limit 2` clause was removed from the `getDataWithDateRange` query, allowing it to retrieve all filtered HMIS sales data.

*   **`c:\Users\efeno\dev\datalink\app\Providers\HubSpotServiceProvider.php` (12/22/2025, 5:50:06 PM)**
    *   The service provider registers both `PlotBoxHubSpotService` and `HmisHubSpotService` as bindings in the Laravel container.
    *   Each service is initialized with dedicated instances of `HubSpotContactService`, `HubSpotDealService`, `EloquentHubSpotRepository` (configured with the appropriate model: `\App\Models\PlotBox\Contact::class` or `\App\Models\Hmis\Sale::class`), and their respective HubSpot API tokens. This setup ensures proper dependency injection and distinct configurations for each integration.

**Patterns and Recurring Elements:**

*   **HubSpot Integration Focus:** The core pattern across all changes is the robust integration with HubSpot CRM. This involves mapping diverse data sources (PlotBox, HMIS) to HubSpot's contact, deal, and location objects.
*   **Dedicated Mappers:** There are distinct mapper classes (`PlotBoxDataToCrmMapper`, `HmisDataToCrmMapper`) responsible for transforming source-specific data transfer objects (DTOs) into HubSpot-compatible array structures.
*   **HubSpot Service Reuse:** A suite of HubSpot-specific services (`HubSpotOwnerService`, `HubSpotLocationService`, `HubSpotContactService`, `HubSpotDealService`) are consistently utilized for interacting with the HubSpot API.
*   **Configuration-Driven Behavior:** Many HubSpot-related values, such as lifecycle stages, pipeline IDs, deal stages, and association type IDs, are fetched dynamically from Laravel's configuration, which in turn is populated by environment variables.
*   **Robust Sync Logic:** The HubSpot synchronization services (`PlotBoxHubSpotService`, `HmisHubSpotService`) implement detailed batch processing with individual `try-catch` blocks for each major operation (contact creation/update, deal creation/update, associations), ensuring resilience and comprehensive error logging.
*   **API Rate Limit Management:** Explicit `usleep()` and `sleep()` calls are scattered throughout the mappers and services, indicating an active strategy to manage API request rates and allow for HubSpot's asynchronous processing.
*   **Database Query Optimization:** The Eloquent models (`PlotBox\Contact`, `Hmis\Sale`) feature complex SQL queries designed to extract detailed and joined data from their respective data warehouses (Snowflake, MSSQL) for CRM synchronization.
*   **Temporary Debugging Limits:** A recurring pattern observed in `PlotBox\Contact.php` and `Hmis\Sale.php` was the temporary inclusion of a `limit 2` clause in their data retrieval queries, which was subsequently removed, suggesting a development or testing phase for these data extraction methods.
*   **Owner Email Standardization:** Both HMIS and PlotBox mappers handle the `hubspot_owner_id` field, with HMIS consistently appending `@everstorypartners.com` to a username, while PlotBox uses a direct email.
*   **Location Service Caching:** Both mappers utilize cached lists of HubSpot locations to efficiently map internal location codes to HubSpot object IDs, reducing repeated API calls.

## 11:46:28 PM
The provided code changes primarily revolve around enhancing the data synchronization process from internal systems (PlotBox and HMIS) to HubSpot CRM, focusing on contact, deceased contact, and deal management, along with location associations. A significant part of the updates involves refining data retrieval queries, improving resilience in HubSpot API interactions, and standardizing configuration.

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Mappers\PlotBoxDataToCrmMapper.php`** (initial update: **12/22/2025, 5:26:50 PM**, subsequent fix: **12/22/2025, 5:39:32 PM**)
    *   **Initial Update:** This mapper class is responsible for transforming PlotBox data into HubSpot-compatible formats for contacts, deceased contacts, and deals.
        *   A new `__destruct` method was added to explicitly clear internal arrays (`ownersList`, `allLocations`) and unset service instances (`ownerService`, `locationService`), indicating a focus on resource management and cleanup.
        *   The `mapContact` method was updated to include `plotbox_account_number` and `last_update_dt` and to conditionally merge pre-need item counts (like `caskets_owned`, `cremation_products_owned`, `ground_owned`, etc.) into the primary contact data based on the `HUBSPOT_PLOTBOX_ALLOW_ITEMS_COUNT` environment variable and if the pipeline is 'pre-need'.
        *   `mapDeceasedContact` and `mapDeal` methods were enhanced with additional fields like `deceasedAccountNumber`, `lifecyclestage`, `service_type_code`, `plotbox_key`, `contract_number`, `dealstage`, and `closedate`.
        *   The `formatMappedFields` private method was expanded to standardize `pipeline` and `dealstage` values based on 'at-need' or 'pre-need' categories using configured HubSpot IDs.
    *   **Subsequent Fix (5:39:32 PM):** The `listAllLocations` method was corrected to properly use `$this->locationService->listAllLocationsWithCache()` instead of creating a new `HubSpotLocationService()` instance without the API token, which was a critical bug fix for fetching locations.

*   **`c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php`** (**12/22/2025, 5:30:12 PM**)
    *   This mapper class, similar to its PlotBox counterpart, handles HMIS data transformation for HubSpot.
    *   It defines methods `mapContact`, `mapDeceasedContact`, and `mapDeal` to convert HMIS DTOs into HubSpot properties.
    *   A notable difference from the PlotBox mapper is how `hubspot_owner_id` is derived, appending `@everstorypartners.com` to the `dealOwnerUserName`.
    *   `mapDeceasedContact` also includes fields specific to HMIS, such as `religious_affilation` and `date_of_burial_memorial_service`.
    *   The `formatMappedFields` method standardizes pipeline names (`AN_FH` for at-need) and sets the `dealstage` consistently to `readyForContract`.

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`** (initial update: **12/22/2025, 5:30:34 PM**, subsequent fix: **12/22/2025, 5:43:57 PM**)
    *   **Initial Update:** This Eloquent model, configured for a Snowflake connection, retrieves PlotBox contact data.
        *   The `getDataWithDateRange` static method introduces a complex SQL query using Common Table Expressions (CTEs) to gather comprehensive data, including `base_contracts`, `contract_writers`, `primary_contacts`, and `deceased_contacts`.
        *   Crucially, a new `item_counts` CTE was added to calculate and include various owned merchandise quantities (e.g., `caskets_owned`, `cremation_products_owned`, `ground_owned`) based on `FEE_CATEGORY_NAME` within contracts. These counts are then included in the final `SELECT` statement.
        *   The initial query included a `limit 2` clause, likely for testing purposes.
        *   A `Log::info` call was added to show the first query result, useful for debugging.
    *   **Subsequent Fix (5:43:57 PM):** The `limit 2` clause was removed from the SQL query within `getDataWithDateRange`, enabling the retrieval of all relevant contact records for the specified date range.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`** (**12/22/2025, 5:31:15 PM**)
    *   This service orchestrates the HubSpot synchronization for PlotBox data.
    *   The `syncPlotBoxData` method now uses a lazy-loaded `PlotBoxDataToCrmMapper` and iterates through data to prepare batches for primary contacts, deceased contacts, deals, and location associations.
    *   The `processContacts` method was significantly refactored to wrap each major step (processing primary contacts, deceased contacts, deals, and various associations) in individual `try-catch` blocks. This enhances the service's resilience, allowing the synchronization to continue even if one specific type of HubSpot interaction fails for a batch.
    *   `sleep` calls (10 and 5 seconds) were introduced between contact and deal processing steps, likely to manage HubSpot API rate limits or allow for background processing.
    *   Extensive logging was added to monitor the success and failure of each association step.

*   **`c:\Users\efeno\dev\datalink\config\services.php`** (**12/22/2025, 5:35:58 PM**)
    *   This configuration file was updated to centralize numerous HubSpot-related settings, drawing values from environment variables.
    *   It now includes a comprehensive set of HubSpot association type IDs (`contact_to_contact`, `contact_to_deal`, `next_of_kin`, `contact_to_location`, `deal_to_contact`, `deal_to_location`), lifecycle stage IDs (`deceased_lifecycle_stage`), pipeline IDs (`at_need_pipeline`, `pre_need_pipeline`), deal stages (`ready_for_contract`, `ready_for_contract_pre_need`), and object type IDs for associations.
    *   New `deal_search_config` and `sources` arrays (for `hmis` and `plotbox`) specify search properties and fields to fetch, demonstrating a flexible and extensible configuration for different data sources.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`** (**12/22/2025, 5:36:18 PM**)
    *   This service mirrors the PlotBox HubSpot service but for HMIS data.
    *   The `syncData` method now categorizes data based on `serviceTypeCode`, distinguishing between 'SHIPOUT' and non-'SHIPOUT' items and processing them in separate batches.
    *   The `processContacts` method here is nearly identical to the one in `PlotBoxHubSpotService`, adopting the same resilience improvements with individual `try-catch` blocks and `sleep` calls.
    *   A key difference is the inclusion of `checkContactOwnerExists` and `checkDealOwnerExists` calls before updating contacts and deals, suggesting specific validation requirements for HMIS data owners.

*   **`c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php`** (initial update: **12/22/2025, 5:42:08 PM**, subsequent fix: **12/22/2025, 5:43:47 PM**)
    *   **Initial Update:** This Eloquent model for HMIS sales retrieves data from a SQL Server connection.
        *   The `getDataWithDateRange` static method defines a complex SQL query joining several tables (`Name`, `Sales_Finance`, `Location`, `CafeCase`, `CafeEmployee`, `CafeCasePerson`, `CafeArrangement`, `CafeArrangementService`) to fetch detailed sales and related contact information.
        *   The query extracts primary contact details, deceased details (including `Religion_CD`, `Birth_Dt`, `Death_Dt`), location, contract numbers, dates, prices, and service types.
        *   Similar to the PlotBox model, it initially included a `limit(2)` clause, likely for development testing.
    *   **Subsequent Fix (5:43:47 PM):** The `limit(2)` clause was removed from the `getDataWithDateRange` query, allowing the retrieval of all matching HMIS sales records.

*   **`c:\Users\efeno\dev\datalink\app\Providers\HubSpotServiceProvider.php`** (**12/22/2025, 5:50:06 PM**)
    *   This Laravel service provider registers the `PlotBoxHubSpotService` and `HmisHubSpotService` with the application's dependency injection container.
    *   It demonstrates a clear separation of concerns by injecting specific `HubSpotContactService`, `HubSpotDealService`, and `EloquentHubSpotRepository` instances, each configured with the appropriate API token and data model (`\App\Models\PlotBox\Contact` or `\App\Models\Hmis\Sale`), ensuring that each HubSpot service operates with its designated data source and credentials.

**Patterns and Recurring Elements:**

1.  **HubSpot Integration Focus:** The core theme across all relevant files is the robust integration with HubSpot CRM for both PlotBox and HMIS data. This includes mapping data, creating/updating contacts and deals, and managing associations.
2.  **Increased Resilience:** Both `PlotBoxHubSpotService` and `HmisHubSpotService` now implement `try-catch` blocks around individual HubSpot API operations within their `processContacts` methods. This pattern significantly improves fault tolerance, preventing a single failure from halting the entire synchronization process. The inclusion of `sleep` calls further suggests strategies for handling API limitations.
3.  **Data Source Specific Mappers:** Dedicated mapper classes (`PlotBoxDataToCrmMapper`, `HmisDataToCrmMapper`) are used for each data source, allowing for tailored data transformation logic and field mappings.
4.  **Configuration Centralization:** The `config/services.php` file has been expanded to hold a comprehensive set of HubSpot configuration parameters, which are then used by the mappers and services. This promotes easier management and consistency of HubSpot-related settings.
5.  **Data Retrieval Refinements:**
    *   Complex SQL queries within Eloquent models (`PlotBox\Contact`, `Hmis\Sale`) are used to gather rich datasets, including derived metrics (e.g., item counts for PlotBox) and specific fields.
    *   The removal of `limit 2` clauses from these queries, seen in the 5:43:47 PM and 5:43:57 PM timestamps, indicates a transition from testing-oriented data fetching to full production-ready data retrieval.
6.  **Resource Management:** The addition of a `__destruct` method in `PlotBoxDataToCrmMapper` and the correction in `listAllLocations` demonstrate attention to proper resource allocation and cleanup.
7.  **Service Provider Integration:** The `HubSpotServiceProvider` pattern ensures that the HubSpot services are properly instantiated with their dependencies and configuration, adhering to Laravel's best practices for application architecture.