# Activity Summary for 12/24/2025

## 3:30:38 AM
The provided logs detail updates to a data synchronization system, primarily focusing on integrating PlotBox and HMIS data with HubSpot CRM. Key changes involve refining data mapping logic, enhancing service robustness, and adjusting data retrieval queries.

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Mappers\PlotBoxDataToCrmMapper.php`**
    *   **Timestamp: 12/22/2025, 5:26:50 PM**
        *   Introduced a `__destruct` method to explicitly clean up resources by clearing internal arrays (`ownersList`, `allLocations`) and unsetting service instances (`ownerService`, `locationService`), with accompanying log messages.
        *   The `formatMappedFields` method was enhanced to standardize various fields like `loc_id` (looking up location ID by code), `state` (uppercasing), `relationship_to_the_deceased` (setting a constant 'Next of Kin'), `pipeline` (standardizing to at-need or pre-need pipelines based on configuration), `hubspot_owner_id` (finding owner by email), and `dealstage` (setting to appropriate 'ready for contract' stages). A general `ucwords(strtolower($value))` is applied as a default.
        *   A new private method `mergePreNeedItemCountsToPrimaryContact` was added to conditionally merge specific item counts (e.g., `caskets_owned`, `cremation_products_owned`) into the primary contact's mapped fields, activated only if the `HUBSPOT_PLOTBOX_ALLOW_ITEMS_COUNT` environment variable is true and the pipeline is 'pre-need'.
        *   The `listAllLocations` method included a `Log::warning` with a debug backtrace for tracing when location fetching is triggered.
    *   **Timestamp: 12/22/2025, 5:39:32 PM**
        *   A subtle but important fix was applied within the `listAllLocations` method. Previously, if `allLocations` was empty, it would create a *new* `HubSpotLocationService` instance without passing the `apiToken` or source. This was corrected to use the already initialized `$this->locationService` instance, ensuring that the correct API token and source ('plotbox') are always utilized for fetching locations with cache.

*   **`c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php` (12/22/2025, 5:30:12 PM)**
    *   This mapper class maintains a similar structure to `PlotBoxDataToCrmMapper` but is tailored for HMIS data.
    *   `mapContact`, `mapDeceasedContact`, and `mapDeal` methods append `@everstorypartners.com` to the `dealOwnerUserName` when mapping `hubspot_owner_id`.
    *   `mapDeceasedContact` specifically maps `religious_affilation` and `date_of_burial_memorial_service` fields.
    *   `mapDeal` includes an `hmis_deal_identifier` and sets `dealstage` to a fixed `readyForContract` value.
    *   The `formatMappedFields` logic is similar to PlotBox but includes specific pipeline mapping for 'an_fh' and explicitly skips transformation for the 'email' field.

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
    *   **Timestamp: 12/22/2025, 5:30:34 PM**
        *   The `getDataWithDateRange` static method defines a complex Snowflake SQL query using several Common Table Expressions (CTEs): `base_contracts`, `contract_writers`, `item_counts`, `primary_contacts`, and `deceased_contacts`. This query extracts comprehensive contact, contract, deal owner, and granular item ownership data (e.g., caskets, cremation products, ground, markers).
        *   The query included a `limit 2` clause, likely for development or testing purposes.
        *   `Log::info` was added to output the first query result for debugging all fetched fields.
    *   **Timestamp: 12/22/2025, 5:43:57 PM**
        *   The `limit 2` clause was removed from the main SQL query within `getDataWithDateRange`, indicating the query is now intended to fetch all relevant data within the specified date range.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (12/22/2025, 5:31:15 PM)**
    *   This service orchestrates the synchronization of PlotBox data to HubSpot.
    *   The `syncPlotBoxData` method fetches data using a `HubSpotRepositoryInterface` and then iterates to map contacts and deals using `PlotBoxDataToCrmMapper`.
    *   Error handling is robust, with individual `try-catch` blocks for processing primary contacts, deceased contacts, contact associations, deal processing, and location associations, allowing the sync to continue even if one step fails.
    *   Explicit `sleep(10)` and `sleep(5)` calls are used between processing steps to mitigate HubSpot API rate limits or allow for backend processing.
    *   The service uses configured association type IDs (`dealTypeIdForLocationsAssociations`, `contactTypeIdForLocationsAssociations`) for linking contacts and deals to locations.

*   **`c:\Users\efeno\dev\datalink\config\services.php` (12/22/2025, 5:35:58 PM)**
    *   Added `ready_for_contract_pre_need` configuration, sourced from `HUBSPOT_READY_FOR_CONTRACT_DEAL_STAGE_PRE_NEED`.
    *   Introduced `deal_object_type_id_for_locations_associations` and `contact_object_type_id_for_locations_associations` with default values ('0-3' and '0-1', respectively) for HubSpot associations.
    *   Updated `deal_search_config` for `plotbox` to use `contract_number` as the `search_property` and fetch additional properties like `plotbox_key` and `plotbox_account_number`.
    *   Refined `sources` configuration for both `hmis` and `plotbox` to specify `id_property`, `phone_properties`, and a comprehensive list of `properties` to fetch/map. Notably, `plotbox` now explicitly includes `mobilephone`, `gender`, and `marital_status`.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php` (12/22/2025, 5:36:18 PM)**
    *   This service mirrors the PlotBox service but handles HMIS data.
    *   The `syncData` method includes logic to differentiate between 'SHIPOUT' and other `serviceTypeCode`s, processing them into separate batches before invoking the `processContacts` method.
    *   The `processContacts` method (shared logic with PlotBox service) incorporates `checkContactOwnerExists` and `checkDealOwnerExists` calls before updating contacts and deals, a feature not present in the PlotBox service's version shown.

*   **`c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php`**
    *   **Timestamp: 12/22/2025, 5:42:08 PM**
        *   The `getDataWithDateRange` static method constructs an SQL Server (MSSQL) query to retrieve sales and related contact/case information. It performs multiple joins across `Sales`, `Name`, `Sales_Finance`, `Location`, `CafeCase`, `CafeEmployee`, `Name2` (for deceased), `CafeCasePerson`, `CafeArrangement`, and `CafeArrangementService`.
        *   The query included a `limit 2` clause.
    *   **Timestamp: 12/22/2025, 5:43:47 PM**
        *   The `limit 2` clause was removed from the `getDataWithDateRange` query, allowing it to retrieve all filtered HMIS sales data.

*   **`c:\Users\efeno\dev\datalink\app\Providers\HubSpotServiceProvider.php` (12/22/2025, 5:50:06 PM)**
    *   The service provider registers both `PlotBoxHubSpotService` and `HmisHubSpotService` as bindings in the Laravel container.
    *   Each service is initialized with dedicated instances of `HubSpotContactService`, `HubSpotDealService`, `EloquentHubSpotRepository` (configured with the appropriate model: `\App\Models\PlotBox\Contact::class` or `\App\Models\Hmis\Sale::class`), and their respective HubSpot API tokens. This setup ensures proper dependency injection and distinct configurations for each integration.

**Patterns and Recurring Elements:**

*   **HubSpot Integration Focus:** The core pattern across all changes is the robust integration with HubSpot CRM. This involves mapping diverse data sources (PlotBox, HMIS) to HubSpot's contact, deal, and location objects.
*   **Dedicated Mappers:** There are distinct mapper classes (`PlotBoxDataToCrmMapper`, `HmisDataToCrmMapper`) responsible for transforming source-specific data transfer objects (DTOs) into HubSpot-compatible array structures.
*   **HubSpot Service Reuse:** A suite of HubSpot-specific services (`HubSpotOwnerService`, `HubSpotLocationService`, `HubSpotContactService`, `HubSpotDealService`) are consistently utilized for interacting with the HubSpot API.
*   **Configuration-Driven Behavior:** Many HubSpot-related values, such as lifecycle stages, pipeline IDs, deal stages, and association type IDs, are fetched dynamically from Laravel's configuration, which in turn is populated by environment variables.
*   **Robust Sync Logic:** The HubSpot synchronization services (`PlotBoxHubSpotService`, `HmisHubSpotService`) implement detailed batch processing with individual `try-catch` blocks for each major operation (contact creation/update, deal creation/update, associations), ensuring resilience and comprehensive error logging.
*   **API Rate Limit Management:** Explicit `usleep()` and `sleep()` calls are scattered throughout the mappers and services, indicating an active strategy to manage API request rates and allow for HubSpot's asynchronous processing.
*   **Database Query Optimization:** The Eloquent models (`PlotBox\Contact`, `Hmis\Sale`) feature complex SQL queries designed to extract detailed and joined data from their respective data warehouses (Snowflake, MSSQL) for CRM synchronization.
*   **Temporary Debugging Limits:** A recurring pattern observed in `PlotBox\Contact.php` and `Hmis\Sale.php` was the temporary inclusion of a `limit 2` clause in their data retrieval queries, which was subsequently removed, suggesting a development or testing phase for these data extraction methods.
*   **Owner Email Standardization:** Both HMIS and PlotBox mappers handle the `hubspot_owner_id` field, with HMIS consistently appending `@everstorypartners.com` to a username, while PlotBox uses a direct email.
*   **Location Service Caching:** Both mappers utilize cached lists of HubSpot locations to efficiently map internal location codes to HubSpot object IDs, reducing repeated API calls.