# Activity Summary for 12/9/2025

## 3:17:56 AM
The changes log indicates ongoing development related to data synchronization between an internal HMIS/PlotBox system and HubSpot CRM, focusing on contacts and deals. The timestamps span from November 20, 2025, to December 8, 2025, with frequent updates on specific days, suggesting an active development or debugging phase.

**File-specific updates:**

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`** (Multiple entries from 11/20/2025, 7:36 PM to 8:15 PM, and 11/21/2025, 1:18 PM to 12/8/2025, 10:28 PM):
    *   This file is central to the HMIS to HubSpot data synchronization.
    *   Early changes involve slight modifications, including commented-out lines like `$dealsToUpdate = $this->checkDealOwnerExists($dealsToCreateOrUpdate['to_update']);` and `dd($deceasedContactBatch, $dealsBatch);`, indicating debugging and testing within the `processContacts` and `syncData` methods. These `dd()` (dump and die) statements are usually temporary debugging tools.
    *   The `syncData` method handles different `serviceTypeCode`s, distinguishing between regular processing and 'SHIPOUT' contacts/deals.
    *   The `processContacts` method is responsible for searching, creating, updating, and associating primary and deceased contacts and deals in HubSpot, including associating them with locations. Error logging (`Log::error`) is consistently implemented for resilience in each step (contact creation/update, association, deal processing).
    *   A significant change occurred around `12/8/2025, 10:35 AM` onwards, where the service began explicitly importing `PlotBoxDataToCrmMapper` and adopted a `HubSpotRepositoryInterface` in its constructor. The `syncData` method was renamed to `syncPlotBoxData` and modified to specifically handle PlotBox data, including conditional `dd($this->plotBoxData);` and commented-out `SHIPOUT` processing, suggesting a shift or expansion to integrate PlotBox data. The `mapper` is now lazily loaded via `getMapper()`. The `processContacts` method was updated to remove `checkContactOwnerExists` and `checkDealOwnerExists` calls, simplifying the update logic.

*   **`c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php`** (Multiple entries from 11/20/2025, 7:41 PM to 9:07 PM):
    *   This mapper is responsible for transforming HMIS data into a format suitable for HubSpot.
    *   Updates include changes to how `hubspot_owner_id` is assigned in `mapContact`, `mapDeceasedContact`, and `mapDeal`. Initially, it directly used `trim($hmisDto->dealOwnerUserName) . '@everstorypartners.com'`, but at `11/20/2025, 7:54 PM`, it was temporarily hardcoded to `'cking@everstorypartners.com'` before being reverted back to the original dynamic assignment at `11/20/2025, 8:01 PM`.
    *   New fields `date_of_burial_memorial_service` (for deceased contacts) and `date_of_service` (for deals) were introduced and mapped using `date_string_to_midnight_utc_millis()` (e.g., `11/20/2025, 8:30 PM`). There was a typo (`$htmisDto`) that was corrected to `$hmisDto` at `11/20/2025, 8:34 PM`.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Crm\Hubspot\HubSpotContactService.php`** (Single entry on 11/20/2025, 7:41 PM):
    *   This service handles HubSpot contact interactions.
    *   The primary change noted is the explicit removal of `loc_id`, `last_update_dt`, `exists`, and `service_type_code` properties before creating or updating contacts in HubSpot. This ensures only relevant data is sent to the CRM.
    *   Error handling within `createContact` and `updateContact` was improved to log specific errors for individual contacts but allow the process to continue for others.

*   **`c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php`** (Multiple entries from 11/20/2025, 7:41 PM to 9:09 PM):
    *   This Eloquent model defines how HMIS sales data is retrieved.
    *   Key changes involve expanding the `select` statement in `getHmisDataWithDateRange` to include `CAS.ServiceDate AS Service_Date` and `CAS.Sevice_Type_Cd AS Service_Type_Code` for service-related data, reflecting new data requirements for HubSpot.
    *   Temporary `limit(1)` or `limit(5)` clauses were added to the `getHmisDataWithDateRange` method at various points (e.g., `11/20/2025, 7:52 PM`, `8:36 PM`, `8:49 PM`, `9:03 PM`) and then removed, indicating localized testing with a small subset of data. A specific `where('Sales.CaseKey', '=', '265707')` was also temporarily added for focused debugging.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Crm\Hubspot\HubSpotDealService.php`** (Multiple entries from 11/20/2025, 7:52 PM to 12/8/2025, 10:32 PM):
    *   This service manages HubSpot deal interactions.
    *   Similar to the `HubSpotContactService`, explicit removal of `loc_id`, `last_update_dt`, `exists`, and `hmis_account_number` properties is implemented before creating or updating deals.
    *   The `updateDeal` method saw a commented-out line `// $dealsToUpdate = $this->checkDealOwnerExists($dealsToCreateOrUpdate['to_update']);` at `11/20/2025, 7:58 PM`, which was then un-commented and re-commented at various points, indicating a back-and-forth decision or testing around owner existence checks before updating deals. The final version before the PlotBox changes does include this line.
    *   After `12/5/2025`, the `hmis_account_number` was removed from properties to unset before sending to HubSpot, which is consistent with the shift towards PlotBox data where a different account number property might be used.

*   **`c:\Users\efeno\dev\datalink\app\Data\HubSpotDataTransferObject.php`** (Multiple entries from 11/20/2025, 8:32 PM to 12/5/2025, 3:31 PM):
    *   This DTO defines the structure for HMIS data being transferred to HubSpot.
    *   It was updated to include `$serviceDate` property at `11/20/2025, 8:32 PM`.
    *   A significant, but quickly reverted, change occurred at `12/5/2025, 3:26 PM`, where new integer properties for product counts (e.g., `casketsCount`, `cremationProductCount`) were added, and then removed shortly after (`12/5/2025, 3:28 PM`), reverting the class to its previous state without these properties. This suggests a brief attempt to integrate product count data directly into this DTO, which was reconsidered.

*   **`c:\Users\efeno\dev\datalink\app\Repositories\EloquentHubSpotRepository.php`** (Multiple entries from 11/20/2025, 9:02 PM to 12/8/2025, 10:10 PM):
    *   This repository handles fetching data for HubSpot synchronization.
    *   Initially, it had methods like `getHmisDataForCrmSync`.
    *   A major refactoring occurred around `11/25/2025, 5:01 PM`:
        *   It was made more generic by introducing a `$modelClass` property in the constructor, allowing it to work with different data sources (HMIS or PlotBox).
        *   The method names were generalized (e.g., `getHmisDataForCrmSync` became `getDataForCrmSync`).
        *   A `transformKeysToTitleCase` private method was added to convert database column names (e.g., `unique_key`) to a title-cased format (e.g., `Unique_Key`), which is then used by the DTOs.
        *   Conditional logic was introduced to map data to either `PlotBoxDataTransferObject` or `HubSpotDataTransferObject` based on the `$modelClass`. Null coalescing (`?? null`) was extensively added when constructing DTOs, making the data mapping more robust against missing fields.
        *   The `getDataForCrmSync` method was updated to handle both `getDataWithDateRange` and `getHubspotData` calls on the dynamic `$model`.

*   **`c:\Users\efeno\dev\datalink\app\Data\PlotBoxDataTransferObject.php`** (Multiple entries from 12/5/2025, 3:29 PM to 3:30 PM):
    *   This is a new DTO specifically for PlotBox data.
    *   Introduced with numerous properties, including product counts (e.g., `casketsCount`, `cremationProductCount`), `gender`, `maritalStatus`, and `purchaserRelationToTheDeceased`.
    *   Methods like `getFullName`, `getDeceasedFullName`, `hasValidEmail`, and `hasDeceasedContact` were added to encapsulate logic for PlotBox data.

*   **`c:\Users\efeno\dev\datalink\app\Mappers\PlotBoxDataToCrmMapper.php`** (Multiple entries from 12/5/2025, 3:40 PM to 3:41 PM):
    *   This is a new mapper specifically for PlotBox data to HubSpot.
    *   It closely mirrors `HmisDataToCrmMapper` but is tailored for `PlotBoxDataTransferObject`.
    *   Notable differences include:
        *   `mapContact` and `mapDeceasedContact` use `plotbox_account_number` instead of `hmis_account_number`.
        *   `hubspot_owner_id` is now derived from `dealOwnerEmailAddress` (which is a JSON string) using a new helper method `getEmailFromJson`.
        *   `mapDeal` includes new fields for product counts (e.g., `caskets_count`, `cremation_product_count`, etc.) and uses `plotbox_key` and `contract_number`.
        *   It introduces `generateDealName` to create a descriptive deal name from PlotBox data.
        *   It has `listAllLocationsWithCache` suggesting caching mechanisms for locations.
        *   `atNeedPipeline` and `preNeedPipeline` configurations were commented out, suggesting these might be dynamically determined or less relevant for PlotBox integration.

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`** (Multiple entries from 12/5/2025, 2:05 PM to 12/8/2025, 10:44 PM):
    *   This new Eloquent model interacts with a Snowflake database for PlotBox data.
    *   It defines the `CONTACT` table and its fillable fields.
    *   The `getDataWithDateRange` static method contains complex SQL queries using `WITH` clauses to join data from `DIM_CONTRACT`, `DIM_CONTRACT_OWNER`, `DIM_CONTACT`, `DIM_CONTRACT_ITEM`, `DIM_FEE`, and `DIM_FEE_CATEGORY`.
    *   This query specifically selects various contact and contract details, including primary and deceased contact information, sales contract number, pipeline, purchase price, and a new `product_counts` CTE to calculate quantities of different product types (caskets, cremation, ground, markers, mausoleum, niche, opening/closing, other merchandise, other services, private estates, urns, vaults) based on `FEE_CATEGORY_NAME` using `LIKE` clauses.
    *   There was a temporary `getDataWithDateRange1` method and several temporary `LIMIT` clauses (e.g., `LIMIT 5`, `LIMIT 20`) in the SQL queries, as well as commented-out sections of the old `getDataWithDateRange1` method, indicating extensive testing and refinement of the Snowflake query.
    *   A `getHubspotData` method was added to retrieve data for the current day.
    *   A `testSimpleQuery` method was added to verify the Snowflake database connection.

*   **`c:\Users\efeno\dev\datalink\app\Console\Commands\Integration\PlotBox\PlotBoxHubSpotSyncDataCommand.php`** (Multiple entries from 12/8/2025, 10:13 PM to 10:28 PM):
    *   This is a new Artisan command for initiating PlotBox data synchronization to HubSpot.
    *   It supports various date filtering options (`--date`, `--from-date`, `--to-date`, `--days-back`).
    *   It leverages `PlotBoxHubSpotService` to perform the sync and includes error handling with email notifications (`HmisErrorNotifications` - note: the class name still refers to HMIS).
    *   Temporary `var_dump` and `dd` statements were observed in the error handling section, again suggesting active debugging.

*   **`c:\Users\efeno\dev\datalink\app\helpers.php`** (Single entry on 11/20/2025, 8:40 PM):
    *   No significant functional changes, but includes helper functions like `response`, `format_currency`, `human_readable_duration`, `human_readable_filesize`, `array_diff_assoc_recursive`, `array_sort_keys_by_array`, `object_set_key_with_dot`, `object_forget_key_with_dot`, `exception_wrapper`, `http_headers`, `have_valid_debug_request_header`, `date_string_to_midnight_utc_millis`, and `convert_utc_date_to_epoch`. This indicates a collection of utility functions.

**Patterns and Recurring Elements:**

*   **HubSpot Integration Focus:** The vast majority of changes revolve around syncing data to HubSpot, involving services for contacts, deals, and locations.
*   **Data Transformation:** There's a clear pattern of mapping data from internal systems (HMIS, PlotBox) into a `HubSpotDataTransferObject` or `PlotBoxDataTransferObject` structure before interacting with the HubSpot API. This involves trimming strings, converting dates to epoch milliseconds, and looking up IDs (owners, locations).
*   **Robust Error Handling & Logging:** `try-catch` blocks with `Log::error` are consistently used throughout the HubSpot service classes (`HmisHubSpotService`, `HubSpotContactService`, `HubSpotDealService`, `PlotBoxHubSpotService`) to handle API exceptions and general errors, often continuing processing even if individual items fail. Detailed logging with JSON-encoded data is also common.
*   **Date Filtering for Sync:** The synchronization commands and repository methods consistently support various date-based filtering options (`--date`, `--from-date`, `--to-date`, `--days-back`) to control the scope of the data sync.
*   **Debugging Practices:** Frequent use of `dd()` (dump and die) and `var_dump()` statements in `HmisHubSpotService`, `PlotBoxHubSpotService`, `EloquentHubSpotRepository`, and `PlotBoxHubSpotSyncDataCommand` indicates active debugging sessions during development. Similarly, `LIMIT` clauses and specific `WHERE` conditions were temporarily added to SQL queries for focused testing.
*   **Abstraction and Generality:** The refactoring of `EloquentHubSpotRepository` to use a `$modelClass` property and a `HubSpotRepositoryInterface` suggests an effort to make the data retrieval layer more generic and extensible, allowing it to handle different source systems (HMIS, PlotBox) through polymorphism.
*   **Product Count Integration:** A new recurring theme, especially in the PlotBox related changes, is the addition of product count fields (caskets, cremation products, ground spaces, markers, etc.) to the data model and SQL queries. This indicates a new requirement to track detailed product sales in HubSpot.
*   **Code Duplication (Temporary):** The `getDataWithDateRange` method in `app\Models\PlotBox\Contact.php` initially had a duplicated SQL query, one of which was commented out and the other was expanded with product counts. This suggests an iterative development process where old logic is kept for comparison or temporary disabling.
*   **Specific HubSpot Configurations:** The frequent use of `config('services.hubspot....')` shows reliance on external configuration for HubSpot API access tokens, association type IDs, lifecycle stages, and pipeline IDs.
*   **Database Connectivity:** The log shows interactions with both `sqlsrv` (for HMIS data) and `snowflake` (for PlotBox data), indicating a multi-database environment.

In summary, this log illustrates a significant development effort to integrate PlotBox data into an existing HubSpot synchronization pipeline, alongside continued maintenance and debugging of the HMIS integration. Key changes include refactoring the repository for data source flexibility, introducing a new DTO and mapper for PlotBox data with detailed product metrics, and updating the synchronization service and command-line tool to support the new data source. The process involves careful data mapping, robust error handling, and visible debugging steps.