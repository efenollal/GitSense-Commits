# Activity Summary for 12/23/2025

## 3:21:28 AM
The code changes primarily focus on enhancing and refining the data synchronization process between two internal systems, PlotBox and HMIS, and HubSpot CRM. This involves extensive data mapping, robust error handling, and structured data retrieval, with a consistent effort to centralize configuration and improve resilience.

### File-Specific Updates:

*   **`c:\Users\efeno\dev\datalink\app\Mappers\PlotBoxDataToCrmMapper.php`**
    *   **(12/22/2025, 5:26:50 PM & 5:39:32 PM)** This file defines how PlotBox data is transformed into HubSpot CRM format. Key features include:
        *   Initialization of HubSpot owner and location services.
        *   Caching of `ownersList` and `allLocations` in the constructor with a `usleep(100000)` pause, suggesting a delay for API rate limits or data readiness.
        *   Configuration of HubSpot lifecycle stages, deal stages (`readyForContract`, `readyForContractPreNeed`), and pipelines (`atNeedPipeline`, `preNeedPipeline`) from application settings.
        *   A `__destruct` method is implemented for explicit resource cleanup (clearing arrays, unsetting services) with logging, indicating a focus on efficient memory management.
        *   Core mapping methods (`mapContact`, `mapDeceasedContact`, `mapDeal`) are responsible for translating PlotBox DTOs into HubSpot-compatible arrays, including date conversions to epoch/milliseconds.
        *   A `formatMappedFields` private method standardizes data like location IDs, state capitalization, relationship text, pipeline names, and HubSpot owner IDs.
        *   A `mergePreNeedItemCountsToPrimaryContact` method conditionally adds various item counts (caskets, cremation products, etc.) to the primary contact if `HUBSPOT_PLOTBOX_ALLOW_ITEMS_COUNT` is enabled and the pipeline is 'pre-need'.
        *   The content of the file at both timestamps is identical, suggesting a re-save without functional changes.

*   **`c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php`**
    *   **(12/22/2025, 5:30:12 PM)** This mapper handles HMIS data to HubSpot CRM mapping, sharing a similar structure to the PlotBox mapper.
        *   It also initializes HubSpot services and configures HubSpot-related values in the constructor, including `usleep(100000)` pauses.
        *   `mapContact` specifically appends `@everstorypartners.com` to the `dealOwnerUserName` for HubSpot owner identification.
        *   `mapDeceasedContact` includes fields like `religious_affilation` and `date_of_burial_memorial_service`.
        *   The `formatMappedFields` method includes specific pipeline mapping logic for HMIS codes (e.g., `an_fh`).
        *   Unlike the PlotBox mapper, this class does not include a `__destruct` method.

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
    *   **(12/22/2025, 5:30:34 PM)** This Eloquent model, connected to a Snowflake database, defines relationships and a complex SQL query to retrieve contact and contract data for CRM synchronization.
        *   The `getDataWithDateRange` method uses several Common Table Expressions (CTEs) (`base_contracts`, `contract_writers`, `item_counts`, `primary_contacts`, `deceased_contacts`) to join various tables and calculate item counts (e.g., `caskets_owned`, `ground_owned`).
        *   It initially included a `limit 2` clause in the final `SELECT` statement, likely for development or testing purposes.
        *   **(12/22/2025, 5:43:57 PM)** The `limit 2` clause was removed from the `getDataWithDateRange` method's SQL query, indicating a shift from limited data retrieval (e.g., for testing) to fetching all relevant records for synchronization.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**
    *   **(12/22/2025, 5:31:15 PM)** This service orchestrates the PlotBox data synchronization with HubSpot.
        *   It fetches PlotBox data, lazy-loads the `PlotBoxDataToCrmMapper`, and then processes batches of primary contacts, deceased contacts, and deals.
        *   The `processContacts` method handles searching, creating, updating, and associating various HubSpot entities (contacts, deals, locations).
        *   It includes `sleep(10)` and `sleep(5)` calls at different stages, possibly to accommodate HubSpot API processing times or rate limits.
        *   Extensive `try-catch` blocks and `Log::error` messages ensure resilience and detailed error reporting.
        *   The log entry shows truncation in the `processContacts` method, specifically during location association error handling.

*   **`c:\Users\efeno\dev\datalink\config\services.php`**
    *   **(12/22/2025, 5:35:58 PM)** This configuration file defines the HubSpot integration settings.
        *   It adds a new configuration entry `ready_for_contract_pre_need`.
        *   It introduces structured `deal_search_config` for both `hmis` and `plotbox` to specify search properties and properties to fetch for deals.
        *   A new `sources` configuration section is added for `hmis` and `plotbox`, detailing `api_access_token`, `id_property`, `phone_properties`, and a list of `properties` to be retrieved for contact searches. This significantly refactors how HubSpot source-specific configurations are managed.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`**
    *   **(12/22/2025, 5:36:18 PM)** This service manages the HMIS data synchronization with HubSpot, mirroring the PlotBox service in its orchestration role.
        *   It explicitly categorizes HMIS data into "ship out" and "non-ship out" batches based on `serviceTypeCode` and processes them separately.
        *   The `processContacts` method in this service includes additional `checkContactOwnerExists` and `checkDealOwnerExists` calls before updating entities, implying a specific requirement for owner validation in the HMIS context.
        *   Like its PlotBox counterpart, it uses `try-catch` blocks, logging, and `sleep` calls for robust processing.
        *   The log entry shows truncation in the `processContacts` method, specifically during location association error handling.

*   **`c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php`**
    *   **(12/22/2025, 5:42:08 PM)** This Eloquent model for HMIS sales data, connected to a SQL Server database, defines relationships and a complex SQL query for data retrieval.
        *   The `getDataWithDateRange` method constructs a detailed query joining multiple HMIS tables (Sales, Name, Sales_Finance, Location, CafeCase, CafeEmployee, CafeCasePerson, CafeArrangement, CafeArrangementService) to collect comprehensive sales data.
        *   It includes logic to parse multiline street addresses.
        *   Filters are applied based on `Sales_Status_Cd`, `Sales_Type_Cd`, location status, and financial details (`Balance_Due`, `Purchase_Price`).
        *   It initially included a `limit(2)` clause, likely for development or testing purposes.
        *   **(12/22/2025, 5:43:47 PM)** The `limit(2)` clause was removed from the `getDataWithDateRange` method's SQL query, allowing the query to return all matching records instead of just two.

*   **`c:\Users\efeno\dev\datalink\app\Providers\HubSpotServiceProvider.php`**
    *   **(12/22/2025, 5:50:06 PM)** This Laravel service provider configures how the HubSpot synchronization services are instantiated.
        *   It binds `PlotBoxHubSpotService` and `HmisHubSpotService` to the application container, injecting their dependencies (`HubSpotContactService`, `HubSpotDealService`, `EloquentHubSpotRepository` with specific models, and API tokens).
        *   The API tokens are now retrieved from the refactored `config('services.hubspot.sources.plotbox.api_access_token')` and `config('services.hubspot.sources.hmis.api_access_token')`, reflecting the changes in `config\services.php`.

### Patterns and Recurring Elements:

*   **HubSpot CRM Integration:** A pervasive theme is the extensive integration with HubSpot, handling contacts, deals, and locations as primary entities.
*   **Dual Data Sources:** The system is designed to handle data from two distinct sources: PlotBox (Snowflake) and HMIS (SQL Server), each with its own mappers, models, and HubSpot services.
*   **Data Mapping:** Both PlotBox and HMIS utilize dedicated mapper classes (`PlotBoxDataToCrmMapper`, `HmisDataToToCrmMapper`) to transform raw data into a standardized format for HubSpot, including specific field mappings, data clean-up, and date conversions.
*   **Structured Data Retrieval:** Models (`PlotBox\Contact`, `Hmis\Sale`) use complex SQL queries, often with CTEs and multiple joins, to gather comprehensive data sets, typically filtered by a date range, for synchronization.
*   **Service-Oriented Architecture:** Dedicated service classes (`PlotBoxHubSpotService`, `HmisHubSpotService`) encapsulate the entire synchronization logic, from data retrieval to HubSpot API interactions.
*   **Robustness and Error Handling:** Throughout the service classes, extensive `try-catch` blocks are used around HubSpot API calls to ensure resilience against failures, with detailed `Log::error` messages for diagnostics. `Log::info` and `Log::warning` are also used for tracing execution.
*   **Configuration Centralization:** HubSpot-related settings, including API tokens, association type IDs, lifecycle stages, and deal pipelines, are consistently retrieved from `config('services.hubspot....')`, with a recent refactor to organize source-specific configurations under `sources.hmis` and `sources.plotbox`.
*   **Rate Limiting/Concurrency Management:** The frequent use of `usleep()` in mapper constructors and `sleep()` in service orchestration methods suggests a strategy to manage HubSpot API rate limits or to allow for eventual consistency in HubSpot's internal processing.
*   **Evolution of Data Retrieval:** A clear pattern emerged in both `PlotBox\Contact` and `Hmis\Sale` models where an initial `limit(2)` clause, likely for debugging or partial data processing, was removed, indicating a transition to full-scale data synchronization.
*   **HMIS-Specific Logic:** The HMIS integration introduces unique aspects like categorizing "ship out" vs. "non-ship out" data and explicit checks for owner existence before updating HubSpot entities, suggesting tailored requirements for HMIS data processing.