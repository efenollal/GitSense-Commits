# Activity Summary for 12/28/2025

## 3:24:06 AM
The log details recent changes primarily focused on integrating PlotBox and HMIS data with HubSpot CRM, following a distinct mapper-service-model architecture for each data source.

### File-Specific Updates:

*   **`c:\Users\efeno\dev\datalink\app\Mappers\PlotBoxDataToCrmMapper.php`**
    *   **Timestamp:** 12/22/2025, 5:26:50 PM and 12/22/2025, 5:39:32 PM
    *   **Initial Change:** This mapper is responsible for transforming PlotBox data into a format suitable for HubSpot contacts and deals. It initializes HubSpot owner and location services, caches lists of owners and locations, and retrieves various HubSpot configuration values (lifecycle stages, pipelines, deal stages). Key methods `mapContact`, `mapDeceasedContact`, and `mapDeal` handle the specific data mappings, including a `mergePreNeedItemCountsToPrimaryContact` function that conditionally adds item counts (like caskets owned) to primary contacts based on a feature flag. A `__destruct` method is implemented for cleaning up resources. The `formatMappedFields` method standardizes data such as location IDs, state formats, relationship texts, and pipeline/deal stage names.
    *   **Subsequent Change (5:39:32 PM):** A minor refactoring occurred in the `listAllLocations` method. It was updated to consistently use the injected `locationService` instance (`$this->locationService->listAllLocationsWithCache()`) instead of creating a new instance within the method.

*   **`c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php`**
    *   **Timestamp:** 12/22/2025, 5:30:12 PM
    *   This mapper performs a similar role to its PlotBox counterpart but for HMIS data. It maps HMIS contact, deceased contact, and deal information to HubSpot properties. Notably, it constructs the `hubspot_owner_id` by appending `'@everstorypartners.com'` to the `dealOwnerUserName`. The `formatMappedFields` logic is largely consistent with the PlotBox mapper, though it uses `AN_FH` for identifying at-need pipelines. This mapper does not include a destructor or the item count merging logic found in the PlotBox mapper.

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php`**
    *   **Timestamp:** 12/22/2025, 5:30:34 PM and 12/22/2025, 5:43:57 PM
    *   **Initial Change:** This Eloquent model defines the structure and data retrieval logic for PlotBox contacts from a Snowflake warehouse. The `getDataWithDateRange` method executes a complex SQL query using Common Table Expressions (CTEs) to gather contract, owner, and item count information, and then joins these to form comprehensive primary and deceased contact records. This initial version included a `limit 2` clause at the end of the query.
    *   **Subsequent Change (5:43:57 PM):** The `limit 2` clause was removed from the `getDataWithDateRange` SQL query, indicating a shift towards fetching all relevant data for the specified date range rather than a limited sample.

*   **`c:\Users\efeno\dev\datalink\config\services.php`**
    *   **Timestamp:** 12/22/2025, 5:35:58 PM
    *   This configuration file was significantly updated to include extensive HubSpot-specific settings. It now defines various HubSpot association type IDs (for contact-contact, contact-deal, deal-location, etc.), lifecycle stages, pipelines, and deal stages, all sourced from environment variables. Crucially, it introduces `deal_search_config` and `sources` configurations, specifying unique properties and API tokens for both HMIS and PlotBox integrations.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php`**
    *   **Timestamp:** 12/22/2025, 5:36:18 PM
    *   This service orchestrates the synchronization of HMIS data to HubSpot. The `syncData` method processes incoming data, specifically differentiating between 'SHIPOUT' and non-'SHIPOUT' records and handling them in separate batches. The `processContacts` method within this service includes additional logic not seen in the PlotBox service, such as `checkContactOwnerExists` and `checkDealOwnerExists` before updating records, and explicit `sleep` calls to manage API rate limits. It handles the full lifecycle of searching, creating, updating, and associating contacts and deals with locations.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php`**
    *   **Timestamp:** 12/22/2025, 5:31:15 PM
    *   This service manages the HubSpot synchronization for PlotBox data. Similar to the HMIS service, it prepares primary and deceased contact batches, deal batches, and location associations. It uses a lazy-loaded mapper instance. The `processContacts` method handles the complex sequence of searching, creating, updating contacts and deals, merging contacts, and associating them with each other and with HubSpot locations, incorporating `try-catch` blocks and `sleep` calls for resilience and API management.

*   **`c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php`**
    *   **Timestamp:** 12/22/2025, 5:42:08 PM and 12/22/2025, 5:43:47 PM
    *   **Initial Change:** This Eloquent model focuses on retrieving HMIS sale data from an SQL Server database. Its `getDataWithDateRange` method executes a detailed SQL query with multiple joins to fetch comprehensive sales, purchaser, deceased, and service information. It includes logic to parse multi-line addresses into separate fields and filters sales records based on status, type, location, and balance. This version also contained a `limit 2` clause.
    *   **Subsequent Change (5:43:47 PM):** The `limit 2` clause was removed from the `getDataWithDateRange` SQL query, indicating a transition to full data retrieval for the specified period.

*   **`c:\Users\efeno\dev\datalink\app\Providers\HubSpotServiceProvider.php`**
    *   **Timestamp:** 12/22/2025, 5:50:06 PM
    *   This service provider was updated to bind `PlotBoxHubSpotService` and `HmisHubSpotService` to Laravel's service container. It ensures that these services are correctly instantiated with their respective HubSpot API tokens, HubSpot CRM services (Contact, Deal), and `EloquentHubSpotRepository` instances, each configured for the correct data source model (`\App\Models\PlotBox\Contact::class` or `\App\Models\Hmis\Sale::class`).

### Patterns and Recurring Elements:

*   **HubSpot Integration Core:** The primary focus across these changes is the robust integration of two distinct source systems (PlotBox and HMIS) with HubSpot CRM for managing contacts, deceased contacts, and deals.
*   **Modular Architecture:** A clear separation of concerns is evident through the use of Mappers for data transformation, Models for data retrieval, and Services for orchestration of the sync process. This pattern is consistently applied to both PlotBox and HMIS integrations.
*   **Data Source Specificity:** Each source system (PlotBox, HMIS) has its dedicated mapper, model, and service, reflecting the unique data structures and business rules associated with each.
*   **Comprehensive Data Fetching:** The removal of `limit 2` from the SQL queries in both `PlotBox\Contact` and `Hmis\Sale` models suggests a move from testing/sampling to full-scale data synchronization for the given date ranges.
*   **Standardized HubSpot Interactions:** Both `PlotBoxHubSpotService` and `HmisHubSpotService` follow a similar sequence of operations for HubSpot: search, create/update contacts, create/update deals, associate contacts (primary and deceased), and associate contacts/deals with locations.
*   **Configuration-Driven Flexibility:** Critical HubSpot API details, association IDs, lifecycle stages, and pipeline identifiers are externalized and managed through `config/services.php` and environment variables, allowing for flexible deployment and easy updates.
*   **Error Handling and Resilience:** Extensive `try-catch` blocks and logging are used throughout the services to manage potential API failures and provide detailed diagnostics. `sleep` or `usleep` calls are employed in both mappers and services, likely to adhere to HubSpot API rate limits and allow for asynchronous processing.
*   **Location-Based Associations:** A significant recurring element is the emphasis on associating HubSpot contacts and deals with specific locations, utilizing `loc_id` from the source data and HubSpot's object type IDs for associations.

## 1:14:38 PM
The changes log details a series of updates related to HubSpot CRM integration for both PlotBox and HMIS data sources, all occurring on December 22, 2025, between 5:26 PM and 5:50 PM, indicating a focused development session.

**File-Specific Updates:**

*   **`c:\Users\efeno\dev\datalink\app\Mappers\PlotBoxDataToCrmMapper.php` (Timestamp: 12/22/2025, 5:26:50 PM & 5:39:32 PM)**
    *   This mapper class is responsible for transforming `PlotBoxDataTransferObject` into a format suitable for HubSpot contacts (primary and deceased) and deals.
    *   It initializes `HubSpotOwnerService` and `HubSpotLocationService` and caches lists of owners and locations.
    *   Configures HubSpot lifecycle stages, pipelines, and deal stages using application settings.
    *   Includes a destructor for explicit resource cleanup.
    *   Features methods like `mapContact`, `mapDeceasedContact`, and `mapDeal` for specific HubSpot object types.
    *   A private `formatMappedFields` method standardizes data, performing lookups for location IDs and owner IDs, and mapping pipeline/dealstage values.
    *   Includes `mergePreNeedItemCountsToPrimaryContact` to append pre-need item counts (e.g., caskets, urns, mausoleum) to primary contact data, conditionally based on an environment variable and pipeline type.
    *   A minor but important update at **5:39:32 PM** corrected the `listAllLocations()` method to properly use the existing `HubSpotLocationService` instance with caching (`$this->locationService->listAllLocationsWithCache()`) instead of creating a new, unconfigured one.

*   **`c:\Users\efeno\dev\datalink\app\Mappers\HmisDataToCrmMapper.php` (Timestamp: 12/22/2025, 5:30:12 PM)**
    *   This mapper performs a similar function to the PlotBox mapper but for HMIS data, converting `HubSpotDataTransferObject` into HubSpot contacts and deals.
    *   It also initializes `HubSpotOwnerService` and `HubSpotLocationService`, fetches owner lists, and configures HubSpot stages/pipelines.
    *   `hubspot_owner_id` is derived by appending `'@everstorypartners.com'` to the `dealOwnerUserName`.
    *   The `mapDeceasedContact` method includes specific fields like `religious_affilation` and `date_of_burial_memorial_service`.
    *   The `formatMappedFields` method has a slightly different mapping for the 'pipeline' field (`'an_fh'` for at-need).
    *   Unlike its PlotBox counterpart, this class does not have an explicit destructor in the provided log.

*   **`c:\Users\efeno\dev\datalink\app\Models\PlotBox\Contact.php` (Timestamp: 12/22/2025, 5:30:34 PM & 5:43:57 PM)**
    *   An Eloquent model for fetching contact and contract data from a Snowflake database (PlotBox warehouse).
    *   The `getDataWithDateRange` method executes a complex SQL query using Common Table Expressions (CTEs) to join multiple tables (e.g., `DIM_CONTRACT`, `DIM_CONTACT`, `DIM_CONTRACT_OWNER`, `DIM_CONTRACT_WRITER`, `DIM_CONTRACT_ITEM`, `DIM_FEE`, `DIM_FEE_CATEGORY`). This query extracts comprehensive details including primary contact info, deceased contact info, contract writer, and detailed item counts (caskets, urns, etc.).
    *   Initially, at **5:30:34 PM**, the SQL query was limited to `limit 2`, likely for testing or development purposes. This `limit 2` clause was **removed at 5:43:57 PM**, indicating a transition to full data extraction.
    *   Includes a `getHubspotData` wrapper to fetch data for the current day.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\PlotBox\PlotBoxHubSpotService.php` (Timestamp: 12/22/2025, 5:31:15 PM)**
    *   This service orchestrates the HubSpot synchronization process for PlotBox data.
    *   It fetches data using a repository, then uses the `PlotBoxDataToCrmMapper` to prepare contact and deal batches.
    *   The `processContacts` method handles searching for existing contacts/deals in HubSpot, creating new ones, and updating existing ones.
    *   It includes `sleep()` calls (10 seconds after primary contacts, 5 seconds after deals) between batches, suggesting an awareness of HubSpot API rate limits or processing delays.
    *   Manages various associations: primary-deceased contact merging, contact-deal associations, and primary/deceased contact and deal-to-location associations. Each association type includes detailed logging and individual `try-catch` blocks for resilience.

*   **`c:\Users\efeno\dev\datalink\config\services.php` (Timestamp: 12/22/2025, 5:35:58 PM)**
    *   This file centralizes configuration for third-party services, specifically detailing a comprehensive HubSpot section.
    *   It defines various HubSpot API access tokens (for PlotBox and HMIS), API URL, and numerous association type IDs for contacts, deals, and locations.
    *   Crucially, it sets specific HubSpot lifecycle stages (`deceased_lifecycle_stage`), pipelines (`at_need_pipeline`, `pre_need_pipeline`), and deal stages (`ready_for_contract`, `ready_for_contract_pre_need`).
    *   Also includes `deal_search_config` to define how deals are searched for (e.g., by `hmis_key` or `contract_number`) and `sources` configuration detailing properties to fetch for HMIS and PlotBox contacts.

*   **`c:\Users\efeno\dev\datalink\app\SMCore\Services\Hmis\HmisHubSpotService.php` (Timestamp: 12/22/2025, 5:36:18 PM)**
    *   This service manages the HubSpot synchronization for HMIS data, analogous to the `PlotBoxHubSpotService`.
    *   A key distinction is its logic within `syncData` to segregate data based on `serviceTypeCode`: 'SHIPOUT' contacts/deals are processed in separate batches from other types.
    *   The `processContacts` method is similar to the PlotBox service, but it includes `checkContactOwnerExists` and `checkDealOwnerExists` calls before updating existing contacts and deals, ensuring owner IDs are valid.
    *   It also incorporates `sleep()` calls between HubSpot API operations.

*   **`c:\Users\efeno\dev\datalink\app\Models\Hmis\Sale.php` (Timestamp: 12/22/2025, 5:42:08 PM & 5:43:47 PM)**
    *   An Eloquent model for fetching HMIS sales data from an SQL Server database.
    *   The `getDataWithDateRange` method executes a complex SQL query joining several HMIS-related tables (`Sales`, `Name`, `Sales_Finance`, `Location`, `CafeCase`, `CafeEmployee`, `CafeCasePerson`, `CafeArrangement`, `CafeArrangementService`). It filters by sales status, type, and location status.
    *   The query extracts purchaser and deceased details, location information, sales contract number, and pricing.
    *   Similar to the PlotBox model, the initial query at **5:42:08 PM** included a `limit 2` clause, which was subsequently **removed at 5:43:47 PM** for full data retrieval.
    *   Includes a `getHubspotData` wrapper.

*   **`c:\Users\efeno\dev\datalink\app\Providers\HubSpotServiceProvider.php` (Timestamp: 12/22/2025, 5:50:06 PM)**
    *   This service provider registers the `PlotBoxHubSpotService` and `HmisHubSpotService` with the Laravel service container.
    *   It demonstrates dependency injection, setting up the HubSpot services with their respective `HubSpotContactService`, `HubSpotDealService`, `EloquentHubSpotRepository` (configured with the correct data model, `PlotBox\Contact` or `Hmis\Sale`), and API tokens.

**Patterns and Recurring Elements:**

*   **Modular Architecture:** The codebase consistently uses separate mappers, services, and models for each data source (PlotBox and HMIS), promoting clear separation of concerns.
*   **HubSpot Integration Consistency:** Both PlotBox and HMIS integrations follow a similar pattern for mapping data, interacting with HubSpot APIs (search, create, update, associate), and handling configuration. This suggests a standardized approach to CRM synchronization.
*   **Data Source-Specific Logic:** While the overall pattern is consistent, there are specific differences tailored to each source, such as how `hubspot_owner_id` is derived, specific fields mapped, or the handling of 'SHIPOUT' service types in HMIS.
*   **Performance and Resilience:** The repeated use of `usleep()` in mappers and `sleep()` in services points to deliberate attempts to manage API rate limits or allow for eventual consistency in the HubSpot API, enhancing the robustness of the integration. `try-catch` blocks around individual HubSpot operations also support resilience.
*   **Centralized Configuration:** The `config/services.php` file, populated from environment variables, serves as a central hub for all HubSpot-related settings, making it easily configurable and maintainable.
*   **Database Query Refinement:** The most notable pattern in the model files is the removal of the `limit 2` clause from the SQL queries in both `PlotBox\Contact.php` and `Hmis\Sale.php`. This indicates a shift from testing or debugging-constrained queries to full data extraction for production use.
*   **Logging:** Extensive `Log::info` and `Log::error` calls are present across the service classes, crucial for monitoring the sync process and debugging issues.

The changes collectively illustrate a robust system for synchronizing complex business data (contacts, deals, item counts, location associations) from different internal systems (PlotBox, HMIS) into HubSpot CRM, with careful consideration for API interaction, data transformation, and system resilience.